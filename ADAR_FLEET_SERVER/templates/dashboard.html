<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ADAR â€” Fleet Command Center v3</title>

    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>

    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                },
            },
        };
    </script>

    <style>
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: 'Inter', system-ui, sans-serif; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 99px; }

        .nav-link { transition: all 0.15s ease; }
        .nav-link:hover { background: rgba(255,255,255,0.08); }
        .nav-link.active { background: rgba(255,255,255,0.12); border-right: 3px solid #3b82f6; }

        .stat-card { transition: box-shadow 0.2s ease, transform 0.2s ease; }
        .stat-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-1px); }

        @keyframes slideIn { from { opacity: 0; transform: translateX(12px); } to { opacity: 1; transform: translateX(0); } }
        .alert-row { animation: slideIn 0.3s ease-out; }

        .leaflet-container { font-family: 'Inter', sans-serif !important; }
        .leaflet-control-attribution { font-size: 9px !important; }

        .car-marker {
            width: 36px; height: 36px;
            background: #1e40af; border: 3px solid #fff;
            border-radius: 50%; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.3s ease;
        }
        .car-marker svg { width: 18px; height: 18px; color: #fff; }

        @keyframes sosPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.5); }
            50% { box-shadow: 0 0 0 12px rgba(239,68,68,0); }
        }
        .sos-btn { animation: sosPulse 2s ease-in-out infinite; }
        .sos-btn:hover { animation: none; box-shadow: 0 0 0 6px rgba(239,68,68,0.3); }

        @keyframes dotBlink { 0%,100%{opacity:1}50%{opacity:.3} }
        .dot-blink { animation: dotBlink 1.5s ease-in-out infinite; }

        /* Compass â€” phone-style rotating dial */
        .compass-container {
            width: 140px; height: 140px; position: relative;
            display: flex; align-items: center; justify-content: center;
        }
        .compass-dial {
            width: 100%; height: 100%; position: absolute;
            will-change: transform;
        }
        /* Fixed top triangle pointer (bearing indicator) */
        .compass-pointer {
            position: absolute; top: -2px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 7px solid transparent;
            border-right: 7px solid transparent;
            border-top: 12px solid #ef4444;
            z-index: 10; filter: drop-shadow(0 1px 2px rgba(239,68,68,0.4));
        }
        /* Center dot */
        .compass-center {
            position: absolute; width: 8px; height: 8px;
            border-radius: 50%; background: #1e293b;
            box-shadow: 0 0 0 2px #fff, 0 0 0 3px #cbd5e1;
            z-index: 5;
        }
        /* Degree readout ring */
        .compass-readout {
            position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: #fff; font-size: 13px; font-weight: 700;
            padding: 2px 12px; border-radius: 12px; white-space: nowrap;
            letter-spacing: 0.5px; z-index: 10;
        }

        /* GPS accuracy ring on map */
        @keyframes accuracyPulse { 0%,100%{opacity:0.15}50%{opacity:0.3} }
        .accuracy-ring { animation: accuracyPulse 3s ease-in-out infinite; }

        /* Speedometer arc */
        .speedo-arc {
            transition: stroke-dashoffset 0.4s ease;
        }

        /* Theme toggle */
        [data-theme="dark"] {
            --bg: #0f172a; --card: #1e293b; --border: #334155;
            --text: #f8fafc; --muted: #94a3b8;
        }

        /* Page transitions */
        .page-section { display: none; }
        .page-section.active { display: block; }
        .page-section.page-flex.active { display: flex; }

        /* Live Tracking fullscreen layout */
        #page-tracking { flex-direction: column; height: 100%; }
        #page-tracking .tracking-body {
            flex: 1; display: grid;
            grid-template-columns: 1fr 320px;
            gap: 0; overflow: hidden;
        }
        #tracking-map-wrap { position: relative; min-height: 0; }
        #tracking-map-container { position: absolute; inset: 0; }

        /* Instrument panel styling */
        .instrument-panel { overflow-y: auto; }
        .instrument-card {
            background: white; border-radius: 12px; border: 1px solid #e2e8f0;
            padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        /* Mini gauge for tracking page */
        .mini-gauge-ring { transition: stroke-dashoffset 0.5s ease; }

        @keyframes livePulse { 0%,100%{box-shadow: 0 0 0 0 rgba(16,185,129,0.4)} 50%{box-shadow: 0 0 0 8px rgba(16,185,129,0)} }
        .live-pulse { animation: livePulse 2s ease-in-out infinite; }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <aside class="w-[220px] bg-slate-900 text-white flex flex-col flex-shrink-0">
        <div class="px-5 py-5 border-b border-slate-700/50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 flex items-center justify-center flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 140" class="w-10 h-7">
                        <defs>
                            <radialGradient id="irisGrad" cx="50%" cy="50%" r="50%">
                                <stop offset="0%" stop-color="#60cfff"/>
                                <stop offset="55%" stop-color="#2196F3"/>
                                <stop offset="100%" stop-color="#0d3b66"/>
                            </radialGradient>
                            <radialGradient id="glowGrad" cx="50%" cy="50%" r="50%">
                                <stop offset="0%" stop-color="#40b0ff" stop-opacity="0.5"/>
                                <stop offset="100%" stop-color="#0d3b66" stop-opacity="0"/>
                            </radialGradient>
                            <filter id="eyeGlow">
                                <feGaussianBlur stdDeviation="3" result="blur"/>
                                <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
                            </filter>
                        </defs>
                        <!-- Outer eye shape -->
                        <path d="M100 15 C145 15, 185 55, 195 70 C185 85, 145 125, 100 125 C55 125, 15 85, 5 70 C15 55, 55 15, 100 15Z" fill="#1a3a5c" stroke="#0d2b45" stroke-width="6"/>
                        <!-- Inner eye shape -->
                        <path d="M100 25 C140 25, 175 55, 185 70 C175 85, 140 115, 100 115 C60 115, 25 85, 15 70 C25 55, 60 25, 100 25Z" fill="#1e4976"/>
                        <!-- Iris glow -->
                        <circle cx="100" cy="70" r="40" fill="url(#glowGrad)" filter="url(#eyeGlow)"/>
                        <!-- Iris -->
                        <circle cx="100" cy="70" r="36" fill="url(#irisGrad)" stroke="#1565C0" stroke-width="2"/>
                        <!-- Circuit lines radiating from iris -->
                        <g stroke="#40b0ff" stroke-width="1.5" opacity="0.8" stroke-linecap="round">
                            <line x1="100" y1="34" x2="100" y2="44"/><line x1="100" y1="96" x2="100" y2="106"/>
                            <line x1="64" y1="70" x2="74" y2="70"/><line x1="126" y1="70" x2="136" y2="70"/>
                            <line x1="76" y1="44" x2="82" y2="52"/><line x1="124" y1="44" x2="118" y2="52"/>
                            <line x1="76" y1="96" x2="82" y2="88"/><line x1="124" y1="96" x2="118" y2="88"/>
                            <!-- Short circuit ticks -->
                            <line x1="87" y1="36" x2="90" y2="43"/><line x1="113" y1="36" x2="110" y2="43"/>
                            <line x1="87" y1="104" x2="90" y2="97"/><line x1="113" y1="104" x2="110" y2="97"/>
                            <line x1="66" y1="55" x2="73" y2="58"/><line x1="66" y1="85" x2="73" y2="82"/>
                            <line x1="134" y1="55" x2="127" y2="58"/><line x1="134" y1="85" x2="127" y2="82"/>
                            <!-- Tiny circuit dots -->
                            <circle cx="100" cy="34" r="1.5" fill="#40b0ff"/><circle cx="100" cy="106" r="1.5" fill="#40b0ff"/>
                            <circle cx="64" cy="70" r="1.5" fill="#40b0ff"/><circle cx="136" cy="70" r="1.5" fill="#40b0ff"/>
                            <circle cx="76" cy="44" r="1.5" fill="#40b0ff"/><circle cx="124" cy="44" r="1.5" fill="#40b0ff"/>
                            <circle cx="76" cy="96" r="1.5" fill="#40b0ff"/><circle cx="124" cy="96" r="1.5" fill="#40b0ff"/>
                        </g>
                        <!-- Pupil -->
                        <circle cx="100" cy="70" r="16" fill="#0a1929"/>
                        <!-- Highlight reflection -->
                        <circle cx="110" cy="58" r="6" fill="white" opacity="0.9"/>
                        <circle cx="92" cy="80" r="2.5" fill="white" opacity="0.4"/>
                    </svg>
                </div>
                <div>
                    <p class="text-sm font-semibold tracking-wide">ADAR</p>
                    <p class="text-[10px] text-slate-400 tracking-wider">FLEET COMMAND v3</p>
                </div>
            </div>
        </div>

        <nav class="flex-1 py-4 px-3 space-y-1">
            <p class="px-3 pb-2 text-[10px] font-semibold text-slate-500 uppercase tracking-wider">Main</p>
            <a href="#" data-page="dashboard" class="nav-link active flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-slate-200">
                <i data-lucide="layout-dashboard" class="w-4 h-4 text-slate-400"></i> Dashboard
            </a>
            <a href="#" data-page="tracking" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-slate-400">
                <i data-lucide="map-pin" class="w-4 h-4"></i> Live Tracking
            </a>
            <a href="#" data-page="safety" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-slate-400">
                <i data-lucide="shield-check" class="w-4 h-4"></i> Safety Reports
            </a>
            <a href="#" data-page="adar-points" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-slate-400">
                <i data-lucide="award" class="w-4 h-4"></i> ADAR Points
            </a>
            <a href="#" data-page="analytics" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-slate-400">
                <i data-lucide="bar-chart-3" class="w-4 h-4"></i> Analytics
            </a>

            <p class="px-3 pt-5 pb-2 text-[10px] font-semibold text-slate-500 uppercase tracking-wider">System</p>
            <a href="#" data-page="settings" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-slate-400">
                <i data-lucide="settings" class="w-4 h-4"></i> Settings
            </a>
            <a href="#" data-page="support" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-slate-400">
                <i data-lucide="life-buoy" class="w-4 h-4"></i> Support
            </a>
        </nav>

        <!-- GPS Status in Sidebar -->
        <div class="px-4 py-3 border-t border-slate-700/50">
            <div class="flex items-center gap-2 mb-2">
                <i data-lucide="navigation" class="w-3.5 h-3.5 text-slate-500"></i>
                <span class="text-[10px] font-semibold text-slate-500 uppercase tracking-wider">GPS Source</span>
            </div>
            <div class="flex items-center gap-2">
                <span id="gps-source-dot" class="w-2 h-2 rounded-full bg-amber-500 dot-blink"></span>
                <span id="gps-source-label" class="text-xs text-slate-400">Waitingâ€¦</span>
            </div>
            <div class="text-[10px] text-slate-600 mt-1" id="gps-accuracy-label"></div>
        </div>

        <!-- Connection Status -->
        <div class="p-4 border-t border-slate-700/50">
            <div class="flex items-center gap-2 text-xs text-slate-500">
                <span id="ws-dot" class="w-2 h-2 rounded-full bg-amber-500 dot-blink"></span>
                <span id="ws-label">Connectingâ€¦</span>
            </div>
            <div class="text-[10px] text-slate-600 mt-1">
                Uptime: <span id="uptime-label" class="font-mono">00:00:00</span>
            </div>
        </div>
    </aside>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN CONTENT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="flex-1 flex flex-col overflow-hidden">

        <!-- â”€â”€ Top Navbar â”€â”€ -->
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 flex-shrink-0">
            <div>
                <h1 class="text-lg font-semibold text-slate-800">Fleet Dashboard</h1>
                <p class="text-xs text-slate-400" id="subtitle">Real-time fleet intelligence</p>
            </div>
            <div class="flex items-center gap-4">
                <!-- CV Pipeline badge -->
                <span id="cv-badge" class="px-2.5 py-1 rounded-full text-[10px] font-semibold bg-slate-50 text-slate-400 border border-slate-200">
                    <span id="cv-badge-icon">ðŸŽ¥</span> <span id="cv-badge-text">Camera: Offline</span>
                </span>
                <!-- GPS badge -->
                <span id="gps-badge" class="px-2.5 py-1 rounded-full text-[10px] font-semibold bg-blue-50 text-blue-600 border border-blue-200">
                    <span id="gps-badge-icon">ðŸ“¡</span> <span id="gps-badge-text">GPS: Acquiringâ€¦</span>
                </span>
                <!-- Sensor badge -->
                <span id="sensor-badge" class="px-2.5 py-1 rounded-full text-[10px] font-semibold bg-slate-50 text-slate-400 border border-slate-200">
                    <span id="sensor-badge-icon">ðŸ”Œ</span> <span id="sensor-badge-text">MQ-135: No Sensor</span>
                </span>
                <!-- Sim / Live badge -->
                <span id="sim-badge" class="px-2.5 py-1 rounded-full text-[10px] font-semibold bg-amber-50 text-amber-600 border border-amber-200">
                    SIMULATION
                </span>
                <!-- Clock -->
                <span id="clock" class="text-xs text-slate-400 font-mono tabular-nums"></span>
                <!-- Profile -->
                <div class="flex items-center gap-3 pl-4 border-l border-slate-200">
                    <div class="text-right">
                        <p class="text-sm font-medium text-slate-700">Aditya Raj</p>
                        <p class="text-[10px] text-slate-400">Fleet Admin</p>
                    </div>
                    <div class="w-9 h-9 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white text-sm font-semibold">AR</div>
                </div>
            </div>
        </header>

        <!-- â”€â”€ Scrollable Body â”€â”€ -->
        <main class="flex-1 overflow-hidden relative">

        <!-- ======= PAGE: DASHBOARD ======= -->
        <div id="page-dashboard" class="page-section active overflow-y-auto p-6 space-y-5 h-full">

            <!-- â•â•â•â•â•â•â•â•â•â• 6-COLUMN STAT CARDS â•â•â•â•â•â•â•â•â•â• -->
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">

                <!-- 1. Active Vehicles -->
                <div class="stat-card bg-white rounded-xl border border-slate-200 shadow-sm p-4">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-[10px] font-medium text-slate-500 uppercase tracking-wide">Vehicles</p>
                        <div class="w-7 h-7 rounded-lg bg-blue-50 flex items-center justify-center">
                            <i data-lucide="car" class="w-3.5 h-3.5 text-blue-600"></i>
                        </div>
                    </div>
                    <p class="text-2xl font-bold text-slate-800" id="stat-vehicles">1</p>
                    <div class="flex items-center gap-1 mt-1">
                        <span id="vehicle-badge" class="px-1.5 py-0.5 rounded-full text-[9px] font-semibold bg-emerald-50 text-emerald-600">Online</span>
                        <span class="text-[10px] text-slate-400" id="vehicle-id-label">VH-7842</span>
                    </div>
                </div>

                <!-- 2. Safety Score -->
                <div class="stat-card bg-white rounded-xl border border-slate-200 shadow-sm p-4" id="safety-card">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-[10px] font-medium text-slate-500 uppercase tracking-wide">Safety</p>
                        <div class="w-7 h-7 rounded-lg bg-emerald-50 flex items-center justify-center" id="safety-icon-bg">
                            <i data-lucide="shield-check" class="w-3.5 h-3.5 text-emerald-600" id="safety-icon"></i>
                        </div>
                    </div>
                    <p class="text-2xl font-bold text-emerald-600" id="stat-safety">98%</p>
                    <div class="flex items-center gap-1 mt-1">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500" id="dot-face"></span>
                        <span class="text-[10px] text-slate-400" id="face-label">Face: â€”</span>
                        <span class="ml-1 text-[10px] font-semibold" id="affective-label"></span>
                    </div>
                    <div id="drowsy-timer-bar" class="mt-2 hidden">
                        <div class="flex items-center justify-between mb-0.5">
                            <span class="text-[9px] font-semibold text-red-600">DROWSY</span>
                            <span class="text-[9px] font-mono text-red-500" id="drowsy-timer-text">0.0s</span>
                        </div>
                        <div class="h-1 bg-red-100 rounded-full overflow-hidden">
                            <div id="drowsy-timer-fill" class="h-full rounded-full bg-red-500 transition-all duration-300" style="width:0%"></div>
                        </div>
                    </div>
                </div>

                <!-- 3. Speed -->
                <div class="stat-card bg-white rounded-xl border border-slate-200 shadow-sm p-4">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-[10px] font-medium text-slate-500 uppercase tracking-wide">Speed</p>
                        <div class="w-7 h-7 rounded-lg bg-violet-50 flex items-center justify-center">
                            <i data-lucide="gauge" class="w-3.5 h-3.5 text-violet-600"></i>
                        </div>
                    </div>
                    <div class="flex items-baseline gap-1">
                        <p class="text-2xl font-bold text-slate-800" id="stat-speed">0</p>
                        <span class="text-xs text-slate-400">km/h</span>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-1">Max: <span id="stat-max-speed" class="font-semibold text-slate-600">0</span> km/h</p>
                </div>

                <!-- 4. COâ‚‚ -->
                <div class="stat-card bg-white rounded-xl border border-slate-200 shadow-sm p-4">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-[10px] font-medium text-slate-500 uppercase tracking-wide">COâ‚‚</p>
                        <div class="w-7 h-7 rounded-lg bg-sky-50 flex items-center justify-center" id="co2-icon-bg">
                            <i data-lucide="wind" class="w-3.5 h-3.5 text-sky-600"></i>
                        </div>
                    </div>
                    <div class="flex items-baseline gap-1">
                        <p class="text-2xl font-bold text-slate-800" id="stat-co2">420</p>
                        <span class="text-xs text-slate-400">PPM</span>
                    </div>
                    <div class="mt-2 h-1 bg-slate-100 rounded-full overflow-hidden">
                        <div id="co2-bar" class="h-full rounded-full bg-emerald-500 transition-all duration-500" style="width:16%"></div>
                    </div>
                </div>

                <!-- 5. Trip Distance -->
                <div class="stat-card bg-white rounded-xl border border-slate-200 shadow-sm p-4">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-[10px] font-medium text-slate-500 uppercase tracking-wide">Trip</p>
                        <div class="w-7 h-7 rounded-lg bg-amber-50 flex items-center justify-center">
                            <i data-lucide="route" class="w-3.5 h-3.5 text-amber-600"></i>
                        </div>
                    </div>
                    <div class="flex items-baseline gap-1">
                        <p class="text-2xl font-bold text-slate-800" id="stat-distance">0.00</p>
                        <span class="text-xs text-slate-400">km</span>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-1" id="stat-altitude">Alt: â€” m</p>
                </div>

                <!-- 6. System Status -->
                <div class="stat-card bg-white rounded-xl border border-slate-200 shadow-sm p-4">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-[10px] font-medium text-slate-500 uppercase tracking-wide">System</p>
                        <div class="w-7 h-7 rounded-lg bg-emerald-50 flex items-center justify-center" id="sys-icon-bg">
                            <i data-lucide="activity" class="w-3.5 h-3.5 text-emerald-600"></i>
                        </div>
                    </div>
                    <p class="text-xs font-semibold text-emerald-600" id="stat-sys">Nominal</p>
                    <div class="flex items-center gap-2 mt-2 text-[10px] text-slate-400">
                        <span class="flex items-center gap-0.5"><span class="w-1.5 h-1.5 rounded-full bg-slate-300" id="dot-cv"></span>CV</span>
                        <span class="flex items-center gap-0.5"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>Cam</span>
                        <span class="flex items-center gap-0.5"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500" id="dot-sensor"></span>MQ</span>
                        <span class="flex items-center gap-0.5"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500" id="dot-gps"></span>GPS</span>
                    </div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â• LIVE TRACKING PANEL â•â•â•â•â•â•â•â•â•â• -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4" style="min-height:460px;">

                <!-- Map (3/4) -->
                <div class="lg:col-span-3 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                    <!-- Map Header Bar -->
                    <div class="flex items-center justify-between px-4 py-2.5 border-b border-slate-100 bg-slate-50/50">
                        <div class="flex items-center gap-3">
                            <div class="flex items-center gap-1.5">
                                <div class="w-2 h-2 rounded-full bg-emerald-500 dot-blink" id="tracking-dot"></div>
                                <p class="text-xs font-bold text-slate-700 uppercase tracking-wide">Live Tracking</p>
                            </div>
                            <span id="gps-source-tag" class="px-2 py-0.5 rounded-full text-[8px] font-semibold bg-blue-50 text-blue-600">BROWSER GPS</span>
                            <span id="imu-tag" class="px-2 py-0.5 rounded-full text-[8px] font-semibold bg-slate-100 text-slate-400 hidden">MPU6050</span>
                        </div>
                        <div class="flex items-center gap-3 text-[10px] text-slate-400">
                            <span class="flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                <strong class="text-slate-600 font-mono text-[10px]" id="map-lat">â€”</strong>,
                                <strong class="text-slate-600 font-mono text-[10px]" id="map-lon">â€”</strong>
                            </span>
                            <span class="h-3 w-px bg-slate-200"></span>
                            <span>Â± <strong class="text-slate-600 font-mono" id="map-accuracy">â€”</strong>m</span>
                            <span class="h-3 w-px bg-slate-200"></span>
                            <span class="flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                <strong class="text-slate-700 font-mono" id="map-speed">0</strong>
                                <span class="text-slate-300">km/h</span>
                            </span>
                        </div>
                    </div>

                    <!-- Map Container -->
                    <div class="flex-1 relative" style="min-height:400px;">
                        <div id="map" class="absolute inset-0"></div>

                        <!-- â”€â”€ Speedometer Gauge (bottom-left overlay) â”€â”€ -->
                        <div class="absolute bottom-4 left-4 z-[500]" id="speedo-overlay">
                            <div class="bg-white/90 backdrop-blur-md rounded-2xl shadow-lg border border-slate-200/60 p-3 flex items-center gap-3" style="min-width:200px;">
                                <div class="relative" style="width:80px; height:80px;">
                                    <svg viewBox="0 0 100 100" class="w-full h-full">
                                        <!-- Background arc -->
                                        <path d="M 15 75 A 42 42 0 1 1 85 75" fill="none" stroke="#e2e8f0" stroke-width="7" stroke-linecap="round"/>
                                        <!-- Speed arc (colored) -->
                                        <path id="speedo-arc" d="M 15 75 A 42 42 0 1 1 85 75" fill="none" stroke="#3b82f6" stroke-width="7" stroke-linecap="round"
                                              stroke-dasharray="220" stroke-dashoffset="220" class="speedo-arc"/>
                                        <!-- Tick marks -->
                                        <g opacity="0.4">
                                            <line x1="50" y1="12" x2="50" y2="18" stroke="#64748b" stroke-width="1.5"/>
                                            <line x1="20" y1="50" x2="26" y2="50" stroke="#64748b" stroke-width="1"/>
                                            <line x1="74" y1="50" x2="80" y2="50" stroke="#64748b" stroke-width="1"/>
                                            <line x1="27" y1="27" x2="31" y2="31" stroke="#64748b" stroke-width="1"/>
                                            <line x1="73" y1="27" x2="69" y2="31" stroke="#64748b" stroke-width="1"/>
                                        </g>
                                        <!-- Center speed text -->
                                        <text x="50" y="52" text-anchor="middle" font-size="20" font-weight="800" fill="#1e293b" id="speedo-value">0</text>
                                        <text x="50" y="65" text-anchor="middle" font-size="7" font-weight="500" fill="#94a3b8">km/h</text>
                                        <!-- Speed source label -->
                                        <text x="50" y="85" text-anchor="middle" font-size="6" font-weight="600" fill="#94a3b8" id="speed-source-label">GPS</text>
                                    </svg>
                                </div>
                                <div class="flex flex-col gap-1">
                                    <div class="flex items-center gap-1.5">
                                        <div class="w-1.5 h-1.5 rounded-full" id="gforce-dot" style="background:#3b82f6;"></div>
                                        <span class="text-[9px] text-slate-400">G-Force</span>
                                        <strong class="text-[11px] font-mono text-slate-700" id="gforce-val">1.00</strong>
                                        <span class="text-[8px] text-slate-300">g</span>
                                    </div>
                                    <div class="flex items-center gap-1.5">
                                        <div class="w-1.5 h-1.5 rounded-full bg-emerald-500"></div>
                                        <span class="text-[9px] text-slate-400">Max</span>
                                        <strong class="text-[11px] font-mono text-slate-700" id="speedo-max">0</strong>
                                        <span class="text-[8px] text-slate-300">km/h</span>
                                    </div>
                                    <div class="flex items-center gap-1.5">
                                        <div class="w-1.5 h-1.5 rounded-full bg-violet-500"></div>
                                        <span class="text-[9px] text-slate-400">Avg</span>
                                        <strong class="text-[11px] font-mono text-slate-700" id="speedo-avg">0</strong>
                                        <span class="text-[8px] text-slate-300">km/h</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- â”€â”€ Trip Stats (top-right overlay) â”€â”€ -->
                        <div class="absolute top-3 right-3 z-[500]">
                            <div class="bg-white/90 backdrop-blur-md rounded-xl shadow-lg border border-slate-200/60 px-3 py-2">
                                <div class="flex items-center gap-4 text-[10px]">
                                    <div class="flex flex-col items-center">
                                        <span class="text-slate-400 uppercase font-semibold" style="font-size:7px;">Distance</span>
                                        <span class="font-bold font-mono text-slate-700" id="trip-distance-overlay">0.00 km</span>
                                    </div>
                                    <div class="w-px h-6 bg-slate-200"></div>
                                    <div class="flex flex-col items-center">
                                        <span class="text-slate-400 uppercase font-semibold" style="font-size:7px;">Duration</span>
                                        <span class="font-bold font-mono text-slate-700" id="trip-duration-overlay">00:00</span>
                                    </div>
                                    <div class="w-px h-6 bg-slate-200"></div>
                                    <div class="flex flex-col items-center">
                                        <span class="text-slate-400 uppercase font-semibold" style="font-size:7px;">Altitude</span>
                                        <span class="font-bold font-mono text-slate-700" id="trip-alt-overlay">â€” m</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- â”€â”€ Map Controls (right side) â”€â”€ -->
                        <div class="absolute top-16 right-3 z-[500] flex flex-col gap-1.5">
                            <button id="btn-center-vehicle" class="w-8 h-8 bg-white/90 backdrop-blur-md rounded-lg shadow border border-slate-200/60 flex items-center justify-center hover:bg-blue-50 transition-colors" title="Center on vehicle">
                                <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            </button>
                            <button id="btn-toggle-trail" class="w-8 h-8 bg-white/90 backdrop-blur-md rounded-lg shadow border border-slate-200/60 flex items-center justify-center hover:bg-blue-50 transition-colors" title="Toggle trail">
                                <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                            </button>
                            <button id="btn-toggle-satellite" class="w-8 h-8 bg-white/90 backdrop-blur-md rounded-lg shadow border border-slate-200/60 flex items-center justify-center hover:bg-blue-50 transition-colors" title="Toggle satellite/map">
                                <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            </button>
                        </div>

                        <!-- GPS Disabled Overlay -->
                        <div id="gps-overlay" class="absolute inset-0 z-[1000] bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center">
                            <div class="w-16 h-16 rounded-full bg-red-50 flex items-center justify-center mb-4">
                                <svg class="w-8 h-8 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 3l18 18" />
                                </svg>
                            </div>
                            <p class="text-sm font-semibold text-slate-700 mb-1">GPS Location Required</p>
                            <p class="text-xs text-slate-400 mb-4 text-center max-w-[280px]">Allow location access to see your real position on the map. No fake data will be shown.</p>
                            <button id="enable-gps-btn" class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold rounded-lg shadow-sm transition-colors">
                                Enable GPS Location
                            </button>
                            <p class="text-[10px] text-slate-400 mt-3">If blocked, click the ðŸ”’ icon in your browser's address bar â†’ Allow Location</p>
                        </div>
                    </div>

                    <!-- Map Footer â€” Sensor Strip -->
                    <div class="px-4 py-2 border-t border-slate-100 bg-slate-50/50 flex items-center justify-between text-[9px]">
                        <div class="flex items-center gap-4">
                            <span class="flex items-center gap-1 text-slate-400">
                                <span class="w-1.5 h-1.5 rounded-full" id="footer-gps-dot" style="background:#10b981;"></span>
                                GPS: <strong class="text-slate-600" id="footer-gps-status">Acquiring</strong>
                            </span>
                            <span class="flex items-center gap-1 text-slate-400">
                                <span class="w-1.5 h-1.5 rounded-full" id="footer-imu-dot" style="background:#94a3b8;"></span>
                                MPU6050: <strong class="text-slate-600" id="footer-imu-status">No Sensor</strong>
                            </span>
                            <span class="flex items-center gap-1 text-slate-400">
                                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                                Trail: <strong class="text-slate-600" id="footer-trail-pts">0</strong> pts
                            </span>
                        </div>
                        <span class="text-slate-300 font-mono" id="footer-timestamp">â€”</span>
                    </div>
                </div>

                <!-- Right Panel: Compass + Alerts -->
                <div class="flex flex-col gap-4">
                    <!-- Compass + Heading (phone-style) -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4 flex flex-col items-center">
                        <div class="flex items-center gap-2 mb-2">
                            <p class="text-[10px] font-semibold text-slate-500 uppercase tracking-wider">Heading</p>
                            <span id="heading-source-tag" class="px-2 py-0.5 rounded-full text-[8px] font-semibold bg-slate-100 text-slate-400">WAITING</span>
                        </div>
                        <div class="compass-container">
                            <!-- Fixed top pointer (bearing reference) -->
                            <div class="compass-pointer"></div>
                            <!-- Rotating SVG dial -->
                            <svg id="compass-dial" class="compass-dial" viewBox="0 0 200 200">
                                <g id="compass-dial-group" transform="rotate(0, 100, 100)">
                                    <!-- Outer ring -->
                                    <circle cx="100" cy="100" r="95" fill="none" stroke="#e2e8f0" stroke-width="1.5"/>
                                    <circle cx="100" cy="100" r="80" fill="none" stroke="#f1f5f9" stroke-width="0.5"/>
                                    <!-- Degree tick marks generated by JS -->
                                    <g id="compass-ticks"></g>
                                    <!-- Cardinal & intercardinal labels -->
                                    <text x="100" y="22" text-anchor="middle" font-size="14" font-weight="800" fill="#ef4444">N</text>
                                    <text x="100" y="192" text-anchor="middle" font-size="11" font-weight="600" fill="#64748b">S</text>
                                    <text x="187" y="104" text-anchor="middle" font-size="11" font-weight="600" fill="#64748b">E</text>
                                    <text x="13" y="104" text-anchor="middle" font-size="11" font-weight="600" fill="#64748b">W</text>
                                    <text x="162" y="42" text-anchor="middle" font-size="8" font-weight="500" fill="#94a3b8">NE</text>
                                    <text x="162" y="168" text-anchor="middle" font-size="8" font-weight="500" fill="#94a3b8">SE</text>
                                    <text x="38" y="168" text-anchor="middle" font-size="8" font-weight="500" fill="#94a3b8">SW</text>
                                    <text x="38" y="42" text-anchor="middle" font-size="8" font-weight="500" fill="#94a3b8">NW</text>
                                    <!-- Needle: red north / grey south -->
                                    <polygon points="100,28 96,100 104,100" fill="#ef4444" opacity="0.9"/>
                                    <polygon points="100,172 96,100 104,100" fill="#94a3b8" opacity="0.6"/>
                                </g>
                            </svg>
                            <!-- Center dot -->
                            <div class="compass-center"></div>
                            <!-- Degree readout -->
                            <div class="compass-readout">
                                <span id="heading-value">0Â°</span>
                                <span id="heading-cardinal" class="text-[10px] text-slate-300 ml-1">N</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 mt-4 text-[9px] text-slate-400">
                            <span>YAW: <strong id="head-yaw-val" class="text-slate-600">0Â°</strong></span>
                            <span>PITCH: <strong id="head-pitch-val" class="text-slate-600">0Â°</strong></span>
                        </div>
                    </div>

                    <!-- Alerts -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col flex-1" id="alerts-panel">
                        <div class="flex items-center justify-between px-4 py-3 border-b border-slate-100">
                            <div class="flex items-center gap-2">
                                <i data-lucide="bell" class="w-4 h-4 text-slate-400"></i>
                                <p class="text-sm font-semibold text-slate-700">CV Alerts</p>
                            </div>
                            <span id="alert-count" class="px-2 py-0.5 rounded-full bg-slate-100 text-slate-500 text-[10px] font-semibold">0</span>
                        </div>
                        <!-- Alert Stats Bar -->
                        <div class="px-4 py-2 border-b border-slate-50 flex items-center gap-3 text-[9px]">
                            <span class="text-slate-400">DROWSY: <strong class="text-red-500" id="cnt-drowsy">0</strong></span>
                            <span class="text-slate-400">YAWN: <strong class="text-amber-500" id="cnt-yawn">0</strong></span>
                            <span class="text-slate-400">DISTRACT: <strong class="text-orange-500" id="cnt-distract">0</strong></span>
                        </div>
                        <div id="alert-feed" class="flex-1 overflow-y-auto p-3 space-y-2" style="max-height:220px;">
                            <div class="text-center py-8 text-sm text-slate-300" id="no-alerts-msg">
                                <i data-lucide="check-circle" class="w-6 h-6 mx-auto mb-2 text-slate-200"></i>
                                No alerts â€” CV pipeline monitoring
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â• 3-COLUMN CHARTS â•â•â•â•â•â•â•â•â•â• -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <!-- EAR Chart -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="text-sm font-semibold text-slate-700">Fatigue (EAR)</p>
                            <p class="text-[10px] text-slate-400">Eye Aspect Ratio â€” &lt;0.20 drowsy</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full" id="ear-dot"></span>
                            <span class="text-base font-bold" id="ear-live">0.280</span>
                        </div>
                    </div>
                    <div style="height:170px;"><canvas id="ear-chart"></canvas></div>
                </div>
                <!-- MAR Chart -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="text-sm font-semibold text-slate-700">Yawn (MAR)</p>
                            <p class="text-[10px] text-slate-400">Mouth Aspect Ratio â€” &gt;0.50 yawn</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full" id="mar-dot"></span>
                            <span class="text-base font-bold" id="mar-live">0.140</span>
                        </div>
                    </div>
                    <div style="height:170px;"><canvas id="mar-chart"></canvas></div>
                </div>
                <!-- COâ‚‚ Chart -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="text-sm font-semibold text-slate-700">Air Quality (COâ‚‚)</p>
                            <p class="text-[10px] text-slate-400">MQ-135 â€” &gt;1000 PPM danger</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full" id="co2-dot"></span>
                            <span class="text-base font-bold" id="co2-live">420</span>
                            <span class="text-[10px] text-slate-400">PPM</span>
                        </div>
                    </div>
                    <div style="height:170px;"><canvas id="co2-chart"></canvas></div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â• SPEED CHART (full width) â•â•â•â•â•â•â•â•â•â• -->
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <p class="text-sm font-semibold text-slate-700">Speed History</p>
                        <p class="text-[10px] text-slate-400">GPS-derived speed over time (km/h)</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-base font-bold text-slate-800" id="speed-live">0</span>
                        <span class="text-xs text-slate-400">km/h</span>
                    </div>
                </div>
                <div style="height:140px;"><canvas id="speed-chart"></canvas></div>
            </div>

        </div><!-- /page-dashboard -->

        <!-- ======= PAGE: LIVE TRACKING ======= -->
        <div id="page-tracking" class="page-section page-flex h-full">
            <!-- Tracking Top Bar -->
            <div class="flex items-center justify-between px-5 py-3 bg-white border-b border-slate-200 flex-shrink-0">
                <div class="flex items-center gap-4">
                    <div class="w-3 h-3 rounded-full bg-emerald-500 live-pulse" id="trk-live-dot"></div>
                    <h2 class="text-sm font-bold text-slate-800 uppercase tracking-wider">Live Vehicle Tracking</h2>
                    <span id="trk-mode-badge" class="px-2.5 py-0.5 rounded-full text-[9px] font-bold bg-emerald-50 text-emerald-600 border border-emerald-200">REAL-TIME</span>
                    <span id="trk-vehicle-badge" class="px-2.5 py-0.5 rounded-full text-[9px] font-bold bg-blue-50 text-blue-600 border border-blue-200">VH-7842</span>
                </div>
                <div class="flex items-center gap-4 text-[10px] text-slate-400">
                    <span class="flex items-center gap-1.5">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500" id="trk-gps-dot"></span>
                        GPS: <strong class="text-slate-600" id="trk-gps-label">Active</strong>
                    </span>
                    <span class="h-3 w-px bg-slate-200"></span>
                    <span class="flex items-center gap-1.5">
                        <span class="w-1.5 h-1.5 rounded-full" id="trk-imu-dot" style="background:#94a3b8"></span>
                        IMU: <strong class="text-slate-600" id="trk-imu-label">â€”</strong>
                    </span>
                    <span class="h-3 w-px bg-slate-200"></span>
                    <span>Lat: <strong class="text-slate-600 font-mono" id="trk-lat">â€”</strong></span>
                    <span>Lon: <strong class="text-slate-600 font-mono" id="trk-lon">â€”</strong></span>
                    <span class="h-3 w-px bg-slate-200"></span>
                    <span>Â± <strong class="text-slate-600 font-mono" id="trk-accuracy">â€”</strong>m</span>
                    <span class="h-3 w-px bg-slate-200"></span>
                    <span class="font-mono text-slate-500" id="trk-clock"></span>
                </div>
            </div>

            <!-- Tracking Body: Map + Instruments -->
            <div class="tracking-body flex-1">
                <!-- Full Map -->
                <div id="tracking-map-wrap" class="bg-slate-100">
                    <div id="tracking-map" class="tracking-map-container" style="position:absolute;inset:0;"></div>

                    <!-- Speedometer Overlay (bottom-left) -->
                    <div class="absolute bottom-5 left-5 z-[500]">
                        <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-xl border border-slate-200/60 p-4" style="min-width:220px;">
                            <div class="flex items-center gap-4">
                                <div class="relative" style="width:100px; height:100px;">
                                    <svg viewBox="0 0 100 100" class="w-full h-full">
                                        <path d="M 15 75 A 42 42 0 1 1 85 75" fill="none" stroke="#e2e8f0" stroke-width="7" stroke-linecap="round"/>
                                        <path id="trk-speedo-arc" d="M 15 75 A 42 42 0 1 1 85 75" fill="none" stroke="#3b82f6" stroke-width="7" stroke-linecap="round" stroke-dasharray="220" stroke-dashoffset="220" class="speedo-arc"/>
                                        <g opacity="0.4">
                                            <line x1="50" y1="12" x2="50" y2="18" stroke="#64748b" stroke-width="1.5"/>
                                            <line x1="20" y1="50" x2="26" y2="50" stroke="#64748b" stroke-width="1"/>
                                            <line x1="74" y1="50" x2="80" y2="50" stroke="#64748b" stroke-width="1"/>
                                            <line x1="27" y1="27" x2="31" y2="31" stroke="#64748b" stroke-width="1"/>
                                            <line x1="73" y1="27" x2="69" y2="31" stroke="#64748b" stroke-width="1"/>
                                        </g>
                                        <text x="50" y="50" text-anchor="middle" font-size="24" font-weight="800" fill="#1e293b" id="trk-speed-val">0</text>
                                        <text x="50" y="65" text-anchor="middle" font-size="8" font-weight="500" fill="#94a3b8">km/h</text>
                                        <text x="50" y="88" text-anchor="middle" font-size="7" font-weight="600" fill="#94a3b8" id="trk-speed-source">GPS</text>
                                    </svg>
                                </div>
                                <div class="flex flex-col gap-1.5">
                                    <div class="flex items-center gap-1.5">
                                        <div class="w-1.5 h-1.5 rounded-full" id="trk-gforce-dot" style="background:#3b82f6"></div>
                                        <span class="text-[9px] text-slate-400">G-Force</span>
                                        <strong class="text-xs font-mono text-slate-700" id="trk-gforce">1.00</strong>
                                        <span class="text-[8px] text-slate-300">g</span>
                                    </div>
                                    <div class="flex items-center gap-1.5">
                                        <div class="w-1.5 h-1.5 rounded-full bg-emerald-500"></div>
                                        <span class="text-[9px] text-slate-400">Max</span>
                                        <strong class="text-xs font-mono text-slate-700" id="trk-max-speed">0</strong>
                                        <span class="text-[8px] text-slate-300">km/h</span>
                                    </div>
                                    <div class="flex items-center gap-1.5">
                                        <div class="w-1.5 h-1.5 rounded-full bg-violet-500"></div>
                                        <span class="text-[9px] text-slate-400">Avg</span>
                                        <strong class="text-xs font-mono text-slate-700" id="trk-avg-speed">0</strong>
                                        <span class="text-[8px] text-slate-300">km/h</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Trip Stats Overlay (top-right) -->
                    <div class="absolute top-4 right-4 z-[500]">
                        <div class="bg-white/95 backdrop-blur-md rounded-xl shadow-xl border border-slate-200/60 px-4 py-2.5">
                            <div class="flex items-center gap-5 text-[10px]">
                                <div class="flex flex-col items-center">
                                    <span class="text-slate-400 uppercase font-semibold" style="font-size:7px;">Distance</span>
                                    <span class="font-bold font-mono text-slate-700" id="trk-distance">0.00 km</span>
                                </div>
                                <div class="w-px h-7 bg-slate-200"></div>
                                <div class="flex flex-col items-center">
                                    <span class="text-slate-400 uppercase font-semibold" style="font-size:7px;">Duration</span>
                                    <span class="font-bold font-mono text-slate-700" id="trk-duration">00:00</span>
                                </div>
                                <div class="w-px h-7 bg-slate-200"></div>
                                <div class="flex flex-col items-center">
                                    <span class="text-slate-400 uppercase font-semibold" style="font-size:7px;">Altitude</span>
                                    <span class="font-bold font-mono text-slate-700" id="trk-altitude">â€” m</span>
                                </div>
                                <div class="w-px h-7 bg-slate-200"></div>
                                <div class="flex flex-col items-center">
                                    <span class="text-slate-400 uppercase font-semibold" style="font-size:7px;">Trail Pts</span>
                                    <span class="font-bold font-mono text-slate-700" id="trk-trail-pts">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Map Controls (right side) -->
                    <div class="absolute top-20 right-4 z-[500] flex flex-col gap-2">
                        <button id="trk-btn-center" class="w-9 h-9 bg-white/95 backdrop-blur-md rounded-lg shadow-lg border border-slate-200/60 flex items-center justify-center hover:bg-blue-50 transition-colors" title="Center on vehicle">
                            <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        </button>
                        <button id="trk-btn-trail" class="w-9 h-9 bg-white/95 backdrop-blur-md rounded-lg shadow-lg border border-slate-200/60 flex items-center justify-center hover:bg-blue-50 transition-colors" title="Toggle trail">
                            <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                        </button>
                        <button id="trk-btn-satellite" class="w-9 h-9 bg-white/95 backdrop-blur-md rounded-lg shadow-lg border border-slate-200/60 flex items-center justify-center hover:bg-blue-50 transition-colors" title="Satellite view">
                            <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        </button>
                        <button id="trk-btn-zoom-in" class="w-9 h-9 bg-white/95 backdrop-blur-md rounded-lg shadow-lg border border-slate-200/60 flex items-center justify-center hover:bg-blue-50 transition-colors" title="Zoom in">
                            <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12M6 12h12"/></svg>
                        </button>
                        <button id="trk-btn-zoom-out" class="w-9 h-9 bg-white/95 backdrop-blur-md rounded-lg shadow-lg border border-slate-200/60 flex items-center justify-center hover:bg-blue-50 transition-colors" title="Zoom out">
                            <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 12h12"/></svg>
                        </button>
                    </div>
                </div>

                <!-- Instrument Panel (right side) -->
                <div class="instrument-panel bg-slate-50 border-l border-slate-200 p-4 space-y-3 overflow-y-auto">

                    <!-- Compass Card -->
                    <div class="instrument-card flex flex-col items-center">
                        <div class="flex items-center gap-2 mb-2 w-full">
                            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Compass</p>
                            <span id="trk-heading-src" class="px-2 py-0.5 rounded-full text-[8px] font-semibold bg-slate-100 text-slate-400">WAITING</span>
                        </div>
                        <div class="compass-container" style="width:130px; height:130px;">
                            <div class="compass-pointer"></div>
                            <svg id="trk-compass-dial" class="compass-dial" viewBox="0 0 200 200">
                                <g id="trk-compass-group" transform="rotate(0, 100, 100)">
                                    <circle cx="100" cy="100" r="95" fill="none" stroke="#e2e8f0" stroke-width="1.5"/>
                                    <circle cx="100" cy="100" r="80" fill="none" stroke="#f1f5f9" stroke-width="0.5"/>
                                    <g id="trk-compass-ticks"></g>
                                    <text x="100" y="22" text-anchor="middle" font-size="14" font-weight="800" fill="#ef4444">N</text>
                                    <text x="100" y="192" text-anchor="middle" font-size="11" font-weight="600" fill="#64748b">S</text>
                                    <text x="187" y="104" text-anchor="middle" font-size="11" font-weight="600" fill="#64748b">E</text>
                                    <text x="13" y="104" text-anchor="middle" font-size="11" font-weight="600" fill="#64748b">W</text>
                                    <text x="162" y="42" text-anchor="middle" font-size="8" font-weight="500" fill="#94a3b8">NE</text>
                                    <text x="162" y="168" text-anchor="middle" font-size="8" font-weight="500" fill="#94a3b8">SE</text>
                                    <text x="38" y="168" text-anchor="middle" font-size="8" font-weight="500" fill="#94a3b8">SW</text>
                                    <text x="38" y="42" text-anchor="middle" font-size="8" font-weight="500" fill="#94a3b8">NW</text>
                                    <polygon points="100,28 96,100 104,100" fill="#ef4444" opacity="0.9"/>
                                    <polygon points="100,172 96,100 104,100" fill="#94a3b8" opacity="0.6"/>
                                </g>
                            </svg>
                            <div class="compass-center"></div>
                            <div class="compass-readout">
                                <span id="trk-heading-val">0Â°</span>
                                <span id="trk-heading-dir" class="text-[10px] text-slate-300 ml-1">N</span>
                            </div>
                        </div>
                    </div>

                    <!-- Safety Status -->
                    <div class="instrument-card" id="trk-safety-card">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Driver Safety</p>
                            <span class="px-2 py-0.5 rounded-full text-[9px] font-bold bg-emerald-50 text-emerald-600" id="trk-safety-badge">SAFE</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="relative" style="width:56px; height:56px;">
                                <svg viewBox="0 0 56 56" class="w-full h-full">
                                    <circle cx="28" cy="28" r="24" fill="none" stroke="#e2e8f0" stroke-width="4"/>
                                    <circle id="trk-safety-ring" cx="28" cy="28" r="24" fill="none" stroke="#10b981" stroke-width="4" stroke-linecap="round" stroke-dasharray="150.8" stroke-dashoffset="3" transform="rotate(-90 28 28)" class="mini-gauge-ring"/>
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span class="text-sm font-bold text-emerald-600" id="trk-safety-score">98%</span>
                                </div>
                            </div>
                            <div class="flex flex-col gap-1 text-[10px]">
                                <div class="flex items-center gap-1.5">
                                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500" id="trk-face-dot"></span>
                                    <span class="text-slate-400" id="trk-face-label">Face: â€”</span>
                                </div>
                                <div class="flex items-center gap-1.5">
                                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500" id="trk-cv-dot"></span>
                                    <span class="text-slate-400" id="trk-cv-label">CV: Offline</span>
                                </div>
                                <div class="flex items-center gap-1.5">
                                    <span class="w-1.5 h-1.5 rounded-full" id="trk-drowsy-dot" style="background:#10b981"></span>
                                    <span class="text-slate-400" id="trk-drowsy-label">Alert</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sensor Readings -->
                    <div class="instrument-card">
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-3">Sensor Readings</p>
                        <div class="space-y-2.5">
                            <!-- EAR -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full" id="trk-ear-dot" style="background:#10b981"></span>
                                    <span class="text-[10px] text-slate-500">EAR (Fatigue)</span>
                                </div>
                                <span class="text-xs font-bold font-mono" id="trk-ear-val">0.280</span>
                            </div>
                            <div class="h-1 bg-slate-100 rounded-full overflow-hidden"><div id="trk-ear-bar" class="h-full rounded-full bg-blue-500 transition-all" style="width:62%"></div></div>
                            <!-- MAR -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full" id="trk-mar-dot" style="background:#10b981"></span>
                                    <span class="text-[10px] text-slate-500">MAR (Yawn)</span>
                                </div>
                                <span class="text-xs font-bold font-mono" id="trk-mar-val">0.140</span>
                            </div>
                            <div class="h-1 bg-slate-100 rounded-full overflow-hidden"><div id="trk-mar-bar" class="h-full rounded-full bg-violet-500 transition-all" style="width:16%"></div></div>
                            <!-- CO2 -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full" id="trk-co2-dot" style="background:#10b981"></span>
                                    <span class="text-[10px] text-slate-500">COâ‚‚</span>
                                </div>
                                <span class="text-xs font-bold font-mono" id="trk-co2-val">420 PPM</span>
                            </div>
                            <div class="h-1 bg-slate-100 rounded-full overflow-hidden"><div id="trk-co2-bar" class="h-full rounded-full bg-amber-400 transition-all" style="width:16%"></div></div>
                            <!-- Speed -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full bg-cyan-500"></span>
                                    <span class="text-[10px] text-slate-500">Speed</span>
                                </div>
                                <span class="text-xs font-bold font-mono" id="trk-speed-reading">0 km/h</span>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Alerts -->
                    <div class="instrument-card flex flex-col" style="max-height:200px;">
                        <div class="flex items-center justify-between mb-2">
                            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Recent Alerts</p>
                            <span class="px-1.5 py-0.5 rounded-full bg-slate-100 text-slate-500 text-[9px] font-semibold" id="trk-alert-count">0</span>
                        </div>
                        <div id="trk-alert-feed" class="flex-1 overflow-y-auto space-y-1.5" style="max-height:140px;">
                            <div class="text-center py-4 text-[10px] text-slate-300" id="trk-no-alerts">No alerts</div>
                        </div>
                    </div>

                </div><!-- /instrument-panel -->
            </div><!-- /tracking-body -->

            <!-- Tracking Footer -->
            <div class="flex items-center justify-between px-5 py-2 bg-white border-t border-slate-200 flex-shrink-0 text-[9px]">
                <div class="flex items-center gap-5">
                    <span class="flex items-center gap-1 text-slate-400">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500" id="trk-footer-gps"></span>
                        GPS: <strong class="text-slate-600" id="trk-footer-gps-status">Active</strong>
                    </span>
                    <span class="flex items-center gap-1 text-slate-400">
                        <span class="w-1.5 h-1.5 rounded-full" id="trk-footer-imu" style="background:#94a3b8"></span>
                        MPU6050: <strong class="text-slate-600" id="trk-footer-imu-status">â€”</strong>
                    </span>
                    <span class="flex items-center gap-1 text-slate-400">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                        MQ-135: <strong class="text-slate-600" id="trk-footer-co2-status">â€”</strong>
                    </span>
                </div>
                <span class="text-slate-400">ADAR Fleet Command v3 â€” Real-time Tracking Module</span>
                <span class="font-mono text-slate-300" id="trk-footer-time">â€”</span>
            </div>
        </div><!-- /page-tracking -->

        <!-- ======= PAGE: SAFETY REPORTS ======= -->
        <div id="page-safety" class="page-section h-full overflow-y-auto">

            <!-- Safety Hero Header -->
            <div class="bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 px-6 py-5">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-5">
                        <!-- Giant Safety Score Gauge -->
                        <div class="relative" style="width:96px; height:96px;">
                            <svg viewBox="0 0 100 100" class="w-full h-full">
                                <circle cx="50" cy="50" r="42" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="6"/>
                                <circle id="sf-score-ring" cx="50" cy="50" r="42" fill="none" stroke="#10b981" stroke-width="6"
                                    stroke-linecap="round" stroke-dasharray="263.9" stroke-dashoffset="5.3"
                                    transform="rotate(-90 50 50)" style="transition:stroke-dashoffset 1s ease, stroke 0.5s ease;"/>
                                <text x="50" y="46" text-anchor="middle" font-size="22" font-weight="800" fill="#fff" id="sf-score-text">98</text>
                                <text x="50" y="60" text-anchor="middle" font-size="8" font-weight="500" fill="rgba(255,255,255,0.5)">SCORE</text>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-white">Driver Safety Report</h2>
                            <p class="text-xs text-slate-400 mt-0.5">Real-time CV-powered driver monitoring analytics</p>
                            <div class="flex items-center gap-3 mt-2">
                                <span id="sf-risk-badge" class="px-3 py-1 rounded-full text-[10px] font-bold bg-emerald-500/20 text-emerald-400 border border-emerald-500/30">LOW RISK</span>
                                <span id="sf-session-badge" class="px-3 py-1 rounded-full text-[10px] font-bold bg-blue-500/20 text-blue-400 border border-blue-500/30">SESSION ACTIVE</span>
                                <span id="sf-cv-status" class="px-3 py-1 rounded-full text-[10px] font-bold bg-slate-500/20 text-slate-400 border border-slate-500/30">CV: WAITING</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-6">
                        <!-- Session KPIs -->
                        <div class="text-center">
                            <p class="text-2xl font-bold text-white" id="sf-kpi-alerts">0</p>
                            <p class="text-[9px] text-slate-500 uppercase font-semibold tracking-wider">Total Alerts</p>
                        </div>
                        <div class="w-px h-10 bg-slate-700"></div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-red-400" id="sf-kpi-critical">0</p>
                            <p class="text-[9px] text-slate-500 uppercase font-semibold tracking-wider">Critical</p>
                        </div>
                        <div class="w-px h-10 bg-slate-700"></div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-amber-400" id="sf-kpi-warnings">0</p>
                            <p class="text-[9px] text-slate-500 uppercase font-semibold tracking-wider">Warnings</p>
                        </div>
                        <div class="w-px h-10 bg-slate-700"></div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-orange-400" id="sf-kpi-episodes">0</p>
                            <p class="text-[9px] text-slate-500 uppercase font-semibold tracking-wider">Drowsy Ep.</p>
                        </div>
                        <div class="w-px h-10 bg-slate-700"></div>
                        <div class="text-center">
                            <p class="text-[10px] text-slate-500 uppercase font-semibold tracking-wider mb-1">Session</p>
                            <p class="text-sm font-bold font-mono text-blue-400" id="sf-session-time">00:00:00</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="p-6 space-y-5">

                <!-- Row 1: Live Safety Gauges (5 gauges) -->
                <div class="grid grid-cols-5 gap-3">
                    <!-- Gauge 1: EAR (Fatigue Level) -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4">
                        <div class="flex items-center justify-between mb-3">
                            <p class="text-[10px] font-semibold text-slate-500 uppercase tracking-wide">Fatigue (EAR)</p>
                            <span class="w-2 h-2 rounded-full" id="sf-ear-status-dot" style="background:#10b981"></span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="relative" style="width:60px; height:60px;">
                                <svg viewBox="0 0 60 60" class="w-full h-full">
                                    <circle cx="30" cy="30" r="25" fill="none" stroke="#f1f5f9" stroke-width="5"/>
                                    <circle id="sf-ear-ring" cx="30" cy="30" r="25" fill="none" stroke="#3b82f6" stroke-width="5"
                                        stroke-linecap="round" stroke-dasharray="157" stroke-dashoffset="60"
                                        transform="rotate(-90 30 30)" style="transition:all 0.5s ease;"/>
                                    <text x="30" y="34" text-anchor="middle" font-size="13" font-weight="700" fill="#1e293b" id="sf-ear-gauge-val">0.28</text>
                                </svg>
                            </div>
                            <div>
                                <p class="text-[10px] text-slate-400">Threshold: <strong class="text-slate-600">0.20</strong></p>
                                <p class="text-[10px] text-slate-400">Avg: <strong class="text-slate-600" id="sf-ear-avg">0.28</strong></p>
                                <p class="text-[10px] text-slate-400">Min: <strong class="text-slate-600" id="sf-ear-min">0.28</strong></p>
                            </div>
                        </div>
                    </div>

                    <!-- Gauge 2: MAR (Yawn Level) -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4">
                        <div class="flex items-center justify-between mb-3">
                            <p class="text-[10px] font-semibold text-slate-500 uppercase tracking-wide">Yawn (MAR)</p>
                            <span class="w-2 h-2 rounded-full" id="sf-mar-status-dot" style="background:#10b981"></span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="relative" style="width:60px; height:60px;">
                                <svg viewBox="0 0 60 60" class="w-full h-full">
                                    <circle cx="30" cy="30" r="25" fill="none" stroke="#f1f5f9" stroke-width="5"/>
                                    <circle id="sf-mar-ring" cx="30" cy="30" r="25" fill="none" stroke="#8b5cf6" stroke-width="5"
                                        stroke-linecap="round" stroke-dasharray="157" stroke-dashoffset="132"
                                        transform="rotate(-90 30 30)" style="transition:all 0.5s ease;"/>
                                    <text x="30" y="34" text-anchor="middle" font-size="13" font-weight="700" fill="#1e293b" id="sf-mar-gauge-val">0.14</text>
                                </svg>
                            </div>
                            <div>
                                <p class="text-[10px] text-slate-400">Threshold: <strong class="text-slate-600">0.50</strong></p>
                                <p class="text-[10px] text-slate-400">Avg: <strong class="text-slate-600" id="sf-mar-avg">0.14</strong></p>
                                <p class="text-[10px] text-slate-400">Max: <strong class="text-slate-600" id="sf-mar-max">0.14</strong></p>
                            </div>
                        </div>
                    </div>

                    <!-- Gauge 3: Driver State -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4" id="sf-state-card">
                        <div class="flex items-center justify-between mb-3">
                            <p class="text-[10px] font-semibold text-slate-500 uppercase tracking-wide">Driver State</p>
                            <span class="w-2 h-2 rounded-full dot-blink" id="sf-state-dot" style="background:#10b981"></span>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl mb-1" id="sf-state-icon">ðŸ˜Š</div>
                            <p class="text-sm font-bold" id="sf-state-text" style="color:#10b981">ALERT</p>
                            <p class="text-[10px] text-slate-400 mt-1">Face: <strong id="sf-face-status" class="text-slate-600">â€”</strong></p>
                        </div>
                    </div>

                    <!-- Gauge 4: Drowsy Duration (current) -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4" id="sf-drowsy-card">
                        <div class="flex items-center justify-between mb-3">
                            <p class="text-[10px] font-semibold text-slate-500 uppercase tracking-wide">Drowsy Timer</p>
                            <span class="px-1.5 py-0.5 rounded text-[8px] font-bold" id="sf-drowsy-badge" style="background:#f0fdf4;color:#10b981;">CLEAR</span>
                        </div>
                        <div class="text-center">
                            <p class="text-3xl font-bold font-mono" id="sf-drowsy-dur" style="color:#10b981">0.0s</p>
                            <div class="mt-2 h-2 bg-slate-100 rounded-full overflow-hidden">
                                <div id="sf-drowsy-fill" class="h-full rounded-full transition-all duration-300" style="width:0%;background:#10b981;"></div>
                            </div>
                            <p class="text-[9px] text-slate-400 mt-1">Max 10s threshold</p>
                        </div>
                    </div>

                    <!-- Gauge 5: COâ‚‚ / Air Quality -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4">
                        <div class="flex items-center justify-between mb-3">
                            <p class="text-[10px] font-semibold text-slate-500 uppercase tracking-wide">Air Quality</p>
                            <span class="w-2 h-2 rounded-full" id="sf-co2-dot" style="background:#10b981"></span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="relative" style="width:60px; height:60px;">
                                <svg viewBox="0 0 60 60" class="w-full h-full">
                                    <circle cx="30" cy="30" r="25" fill="none" stroke="#f1f5f9" stroke-width="5"/>
                                    <circle id="sf-co2-ring" cx="30" cy="30" r="25" fill="none" stroke="#f59e0b" stroke-width="5"
                                        stroke-linecap="round" stroke-dasharray="157" stroke-dashoffset="130"
                                        transform="rotate(-90 30 30)" style="transition:all 0.5s ease;"/>
                                    <text x="30" y="32" text-anchor="middle" font-size="11" font-weight="700" fill="#1e293b" id="sf-co2-gauge-val">420</text>
                                    <text x="30" y="42" text-anchor="middle" font-size="6" fill="#94a3b8">PPM</text>
                                </svg>
                            </div>
                            <div>
                                <p class="text-[10px] text-slate-400">Danger: <strong class="text-red-500">1000+</strong></p>
                                <p class="text-[10px] text-slate-400">Source: <strong class="text-slate-600" id="sf-co2-source">â€”</strong></p>
                                <p class="text-[10px] font-semibold" id="sf-co2-level" style="color:#10b981">Good</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Row 2: Charts + Alert Distribution -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

                    <!-- Safety Score Timeline (2/3 width) -->
                    <div class="lg:col-span-2 bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <p class="text-sm font-semibold text-slate-700">Safety Score Timeline</p>
                                <p class="text-[10px] text-slate-400">Real-time attention score from CV pipeline</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="flex items-center gap-1.5">
                                    <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                                    <span class="text-[9px] text-slate-400">Safe (&gt;70%)</span>
                                </div>
                                <div class="flex items-center gap-1.5">
                                    <span class="w-2 h-2 rounded-full bg-amber-500"></span>
                                    <span class="text-[9px] text-slate-400">Warning (50â€“70%)</span>
                                </div>
                                <div class="flex items-center gap-1.5">
                                    <span class="w-2 h-2 rounded-full bg-red-500"></span>
                                    <span class="text-[9px] text-slate-400">Critical (&lt;50%)</span>
                                </div>
                            </div>
                        </div>
                        <div style="height:200px;"><canvas id="sf-score-chart"></canvas></div>
                    </div>

                    <!-- Alert Distribution Donut (1/3 width) -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <p class="text-sm font-semibold text-slate-700">Alert Distribution</p>
                                <p class="text-[10px] text-slate-400">Breakdown by detection type</p>
                            </div>
                            <span class="text-lg font-bold text-slate-800" id="sf-donut-total">0</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <div style="width:140px; height:140px; position:relative;">
                                <canvas id="sf-donut-chart"></canvas>
                                <div class="absolute inset-0 flex flex-col items-center justify-center">
                                    <span class="text-xl font-bold text-slate-800" id="sf-donut-center">0</span>
                                    <span class="text-[8px] text-slate-400 uppercase">Events</span>
                                </div>
                            </div>
                            <div class="flex-1 space-y-2">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2"><span class="w-2.5 h-2.5 rounded-sm" style="background:#ef4444"></span><span class="text-[10px] text-slate-600">Drowsiness</span></div>
                                    <span class="text-[10px] font-bold text-slate-700" id="sf-dist-drowsy">0</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2"><span class="w-2.5 h-2.5 rounded-sm" style="background:#f59e0b"></span><span class="text-[10px] text-slate-600">Yawning</span></div>
                                    <span class="text-[10px] font-bold text-slate-700" id="sf-dist-yawn">0</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2"><span class="w-2.5 h-2.5 rounded-sm" style="background:#f97316"></span><span class="text-[10px] text-slate-600">Distraction</span></div>
                                    <span class="text-[10px] font-bold text-slate-700" id="sf-dist-distract">0</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2"><span class="w-2.5 h-2.5 rounded-sm" style="background:#8b5cf6"></span><span class="text-[10px] text-slate-600">Phone Use</span></div>
                                    <span class="text-[10px] font-bold text-slate-700" id="sf-dist-phone">0</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2"><span class="w-2.5 h-2.5 rounded-sm" style="background:#06b6d4"></span><span class="text-[10px] text-slate-600">Looking Away</span></div>
                                    <span class="text-[10px] font-bold text-slate-700" id="sf-dist-look">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Row 3: EAR/MAR Charts + Risk Matrix -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- EAR History Chart -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <p class="text-sm font-semibold text-slate-700">Fatigue Trend (EAR)</p>
                                <p class="text-[10px] text-slate-400">Eye Aspect Ratio over time</p>
                            </div>
                            <span class="text-base font-bold" id="sf-ear-live-val">0.280</span>
                        </div>
                        <div style="height:160px;"><canvas id="sf-ear-chart"></canvas></div>
                    </div>

                    <!-- MAR History Chart -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <p class="text-sm font-semibold text-slate-700">Yawn Trend (MAR)</p>
                                <p class="text-[10px] text-slate-400">Mouth Aspect Ratio over time</p>
                            </div>
                            <span class="text-base font-bold" id="sf-mar-live-val">0.140</span>
                        </div>
                        <div style="height:160px;"><canvas id="sf-mar-chart"></canvas></div>
                    </div>

                    <!-- Risk Assessment Matrix -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                        <div class="flex items-center justify-between mb-3">
                            <p class="text-sm font-semibold text-slate-700">Risk Assessment</p>
                            <span id="sf-risk-level-tag" class="px-2 py-0.5 rounded-full text-[9px] font-bold bg-emerald-50 text-emerald-600">LOW</span>
                        </div>
                        <div class="space-y-3">
                            <!-- Drowsiness Risk -->
                            <div>
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-[10px] text-slate-500">Drowsiness Risk</span>
                                    <span class="text-[10px] font-bold" id="sf-risk-drowsy-pct">0%</span>
                                </div>
                                <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                                    <div id="sf-risk-drowsy-bar" class="h-full rounded-full bg-red-500 transition-all duration-500" style="width:0%"></div>
                                </div>
                            </div>
                            <!-- Yawn Risk -->
                            <div>
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-[10px] text-slate-500">Fatigue (Yawn) Risk</span>
                                    <span class="text-[10px] font-bold" id="sf-risk-yawn-pct">0%</span>
                                </div>
                                <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                                    <div id="sf-risk-yawn-bar" class="h-full rounded-full bg-amber-400 transition-all duration-500" style="width:0%"></div>
                                </div>
                            </div>
                            <!-- Distraction Risk -->
                            <div>
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-[10px] text-slate-500">Distraction Risk</span>
                                    <span class="text-[10px] font-bold" id="sf-risk-distract-pct">0%</span>
                                </div>
                                <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                                    <div id="sf-risk-distract-bar" class="h-full rounded-full bg-orange-400 transition-all duration-500" style="width:0%"></div>
                                </div>
                            </div>
                            <!-- Air Quality Risk -->
                            <div>
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-[10px] text-slate-500">Air Quality Risk</span>
                                    <span class="text-[10px] font-bold" id="sf-risk-co2-pct">0%</span>
                                </div>
                                <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                                    <div id="sf-risk-co2-bar" class="h-full rounded-full bg-cyan-400 transition-all duration-500" style="width:0%"></div>
                                </div>
                            </div>
                            <!-- Overall -->
                            <div class="pt-2 border-t border-slate-100">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-[10px] font-semibold text-slate-700">Overall Risk</span>
                                    <span class="text-[10px] font-bold" id="sf-risk-overall-pct">0%</span>
                                </div>
                                <div class="h-2.5 bg-slate-100 rounded-full overflow-hidden">
                                    <div id="sf-risk-overall-bar" class="h-full rounded-full transition-all duration-500" style="width:0%;background:linear-gradient(90deg,#10b981,#f59e0b,#ef4444);"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Row 4: Drowsy Episodes + Alert Timeline + Recommendations -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

                    <!-- Drowsy Episodes Log -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                        <div class="px-5 py-3 border-b border-slate-100 flex items-center justify-between">
                            <div>
                                <p class="text-sm font-semibold text-slate-700">Drowsy Episodes</p>
                                <p class="text-[10px] text-slate-400">Detected micro-sleep events from CV</p>
                            </div>
                            <span class="px-2 py-0.5 rounded-full bg-red-50 text-red-600 text-[10px] font-bold" id="sf-ep-count">0</span>
                        </div>
                        <div id="sf-episode-feed" class="flex-1 overflow-y-auto p-3 space-y-2" style="max-height:220px;">
                            <div class="flex flex-col items-center justify-center py-8 text-slate-300" id="sf-no-episodes">
                                <svg class="w-8 h-8 mb-2 text-slate-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                <span class="text-[10px]">No drowsy episodes detected</span>
                            </div>
                        </div>
                    </div>

                    <!-- Full Alert Log (scrollable) -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                        <div class="px-5 py-3 border-b border-slate-100 flex items-center justify-between">
                            <div>
                                <p class="text-sm font-semibold text-slate-700">Alert Timeline</p>
                                <p class="text-[10px] text-slate-400">Chronological CV detection log</p>
                            </div>
                            <button id="sf-refresh-btn" class="px-2.5 py-1 rounded-lg bg-blue-50 text-blue-600 text-[10px] font-semibold hover:bg-blue-100 transition-colors">Refresh</button>
                        </div>
                        <div id="sf-alert-timeline" class="flex-1 overflow-y-auto p-3 space-y-1.5" style="max-height:220px;">
                            <div class="flex flex-col items-center justify-center py-8 text-slate-300" id="sf-no-timeline">
                                <svg class="w-8 h-8 mb-2 text-slate-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                <span class="text-[10px]">No alerts in this session</span>
                            </div>
                        </div>
                    </div>

                    <!-- AI Safety Recommendations -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl border border-blue-100 shadow-sm p-5">
                        <div class="flex items-center gap-2 mb-4">
                            <div class="w-7 h-7 rounded-lg bg-blue-600 flex items-center justify-center">
                                <svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.455 2.456L21.75 6l-1.036.259a3.375 3.375 0 00-2.455 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z"/></svg>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-slate-700">AI Safety Insights</p>
                                <p class="text-[10px] text-slate-400">Intelligent recommendations</p>
                            </div>
                        </div>
                        <div id="sf-recommendations" class="space-y-3">
                            <div class="flex items-start gap-2.5 p-3 bg-white/70 rounded-lg border border-white">
                                <span class="text-sm mt-0.5">âœ…</span>
                                <div>
                                    <p class="text-[11px] font-semibold text-slate-700">Session Starting</p>
                                    <p class="text-[10px] text-slate-400">All safety systems are initializing. CV pipeline will begin monitoring when the camera feed is active.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Row 5: Session Summary Footer -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-sm font-semibold text-slate-700">Session Summary</p>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-slate-400">Vehicle:</span>
                            <span class="px-2 py-0.5 rounded bg-slate-100 text-[10px] font-bold text-slate-600" id="sf-summary-vid">â€”</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-4">
                        <div class="text-center">
                            <p class="text-lg font-bold text-slate-800" id="sf-sum-score">98%</p>
                            <p class="text-[9px] text-slate-400 uppercase">Avg Score</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-slate-800" id="sf-sum-min-score">98%</p>
                            <p class="text-[9px] text-slate-400 uppercase">Min Score</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-blue-600" id="sf-sum-avg-ear">0.280</p>
                            <p class="text-[9px] text-slate-400 uppercase">Avg EAR</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-blue-600" id="sf-sum-min-ear">0.280</p>
                            <p class="text-[9px] text-slate-400 uppercase">Min EAR</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-violet-600" id="sf-sum-avg-mar">0.140</p>
                            <p class="text-[9px] text-slate-400 uppercase">Avg MAR</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-violet-600" id="sf-sum-max-mar">0.140</p>
                            <p class="text-[9px] text-slate-400 uppercase">Max MAR</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-red-600" id="sf-sum-drowsy-ep">0</p>
                            <p class="text-[9px] text-slate-400 uppercase">Drowsy Ep.</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-slate-800" id="sf-sum-total-alerts">0</p>
                            <p class="text-[9px] text-slate-400 uppercase">Total Alerts</p>
                        </div>
                    </div>
                </div>

            </div><!-- /p-6 content -->
        </div><!-- /page-safety -->

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- â•â•â•â•â•â•â•â•â•â• PAGE: ADAR POINTS â€” Insurance Intelligence â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div id="page-adar-points" class="page-section h-full overflow-y-auto">

            <!-- â”€â”€ HERO: Score Display â”€â”€ -->
            <div class="bg-gradient-to-r from-indigo-950 via-violet-900 to-indigo-950 px-6 py-6 relative overflow-hidden">
                <!-- Animated bg particles -->
                <div class="absolute inset-0 opacity-10">
                    <div class="absolute top-4 left-10 w-32 h-32 bg-indigo-400 rounded-full blur-3xl animate-pulse"></div>
                    <div class="absolute bottom-2 right-16 w-24 h-24 bg-violet-400 rounded-full blur-2xl animate-pulse" style="animation-delay:1s"></div>
                    <div class="absolute top-8 right-1/3 w-20 h-20 bg-blue-400 rounded-full blur-2xl animate-pulse" style="animation-delay:2s"></div>
                </div>
                <div class="relative flex items-center gap-6 flex-wrap">
                    <!-- Main Score Ring -->
                    <div class="relative flex-shrink-0" style="width:140px;height:140px;">
                        <svg viewBox="0 0 100 100" class="w-full h-full" style="transform:rotate(-90deg)">
                            <defs>
                                <linearGradient id="ap-score-grad" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#818cf8"/>
                                    <stop offset="50%" stop-color="#6366f1"/>
                                    <stop offset="100%" stop-color="#4f46e5"/>
                                </linearGradient>
                            </defs>
                            <circle cx="50" cy="50" r="42" fill="none" stroke="rgba(255,255,255,0.06)" stroke-width="7"/>
                            <circle id="ap-score-ring" cx="50" cy="50" r="42" fill="none" stroke="url(#ap-score-grad)" stroke-width="7"
                                stroke-linecap="round" stroke-dasharray="263.9" stroke-dashoffset="263.9"
                                style="transition: stroke-dashoffset 2s cubic-bezier(.4,0,.2,1), stroke 0.5s"/>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span id="ap-score-num" class="text-3xl font-black text-white tabular-nums" style="letter-spacing:-1px">â€”</span>
                            <span class="text-[9px] text-indigo-300 font-semibold tracking-widest uppercase">/ 1000</span>
                        </div>
                    </div>
                    <!-- Score Meta -->
                    <div class="flex-1 min-w-[200px]">
                        <div class="flex items-center gap-3 mb-2">
                            <h2 class="text-xl font-black text-white tracking-tight">ADAR Points</h2>
                            <span id="ap-grade-badge" class="px-2.5 py-0.5 rounded-full text-xs font-black bg-indigo-500/30 text-indigo-200">â€”</span>
                        </div>
                        <p class="text-xs text-indigo-300/80 mb-3">Insurance-grade driver behavior score powered by AI telemetry analysis</p>
                        <div class="flex flex-wrap gap-2">
                            <span id="ap-tier-badge" class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider bg-indigo-500/20 text-indigo-200 border border-indigo-500/30">â€”</span>
                            <span id="ap-risk-badge" class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider bg-emerald-500/20 text-emerald-300 border border-emerald-500/30">â€”</span>
                            <span id="ap-rate-badge" class="px-3 py-1 rounded-full text-[10px] font-bold tracking-wider bg-white/10 text-white/80 border border-white/10">â€” % Interest</span>
                        </div>
                    </div>
                    <!-- Quick Stats -->
                    <div class="flex gap-3 flex-shrink-0">
                        <div class="bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-center min-w-[80px]">
                            <p id="ap-savings" class="text-lg font-black text-emerald-400">â€”</p>
                            <p class="text-[8px] text-indigo-300 font-semibold uppercase">Annual Savings</p>
                        </div>
                        <div class="bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-center min-w-[80px]">
                            <p id="ap-discount" class="text-lg font-black text-amber-400">â€”%</p>
                            <p class="text-[8px] text-indigo-300 font-semibold uppercase">Discount</p>
                        </div>
                        <div class="bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-center min-w-[80px]">
                            <p id="ap-monthly" class="text-lg font-black text-white">â€”</p>
                            <p class="text-[8px] text-indigo-300 font-semibold uppercase">Monthly EMI</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 space-y-5">

                <!-- Insurance Tier Cards -->
                <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                    <!-- Platinum -->
                    <div id="ap-tier-platinum" class="relative rounded-xl border-2 p-4 transition-all duration-500 border-slate-200 bg-white">
                        <div class="absolute -top-2.5 left-3 px-2 py-0.5 rounded-full text-[8px] font-bold uppercase tracking-widest bg-indigo-600 text-white">Platinum</div>
                        <div class="mt-2 text-center">
                            <p class="text-2xl font-black text-indigo-600">0.5%</p>
                            <p class="text-[9px] text-slate-400 font-semibold mt-1">Interest Rate</p>
                            <p class="text-[10px] text-slate-500 mt-2 font-medium">800 â€” 1000 pts</p>
                            <div class="w-full bg-slate-100 rounded-full h-1.5 mt-2">
                                <div class="bg-indigo-600 h-1.5 rounded-full" style="width:100%"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Gold -->
                    <div id="ap-tier-gold" class="relative rounded-xl border-2 p-4 transition-all duration-500 border-slate-200 bg-white">
                        <div class="absolute -top-2.5 left-3 px-2 py-0.5 rounded-full text-[8px] font-bold uppercase tracking-widest bg-amber-500 text-white">Gold</div>
                        <div class="mt-2 text-center">
                            <p class="text-2xl font-black text-amber-500">1.0%</p>
                            <p class="text-[9px] text-slate-400 font-semibold mt-1">Interest Rate</p>
                            <p class="text-[10px] text-slate-500 mt-2 font-medium">650 â€” 799 pts</p>
                            <div class="w-full bg-slate-100 rounded-full h-1.5 mt-2">
                                <div class="bg-amber-500 h-1.5 rounded-full" style="width:80%"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Silver -->
                    <div id="ap-tier-silver" class="relative rounded-xl border-2 p-4 transition-all duration-500 border-slate-200 bg-white">
                        <div class="absolute -top-2.5 left-3 px-2 py-0.5 rounded-full text-[8px] font-bold uppercase tracking-widest bg-slate-400 text-white">Silver</div>
                        <div class="mt-2 text-center">
                            <p class="text-2xl font-black text-slate-500">1.5%</p>
                            <p class="text-[9px] text-slate-400 font-semibold mt-1">Interest Rate</p>
                            <p class="text-[10px] text-slate-500 mt-2 font-medium">500 â€” 649 pts</p>
                            <div class="w-full bg-slate-100 rounded-full h-1.5 mt-2">
                                <div class="bg-slate-400 h-1.5 rounded-full" style="width:60%"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Bronze -->
                    <div id="ap-tier-bronze" class="relative rounded-xl border-2 p-4 transition-all duration-500 border-slate-200 bg-white">
                        <div class="absolute -top-2.5 left-3 px-2 py-0.5 rounded-full text-[8px] font-bold uppercase tracking-widest bg-amber-700 text-white">Bronze</div>
                        <div class="mt-2 text-center">
                            <p class="text-2xl font-black text-amber-700">2.0%</p>
                            <p class="text-[9px] text-slate-400 font-semibold mt-1">Interest Rate</p>
                            <p class="text-[10px] text-slate-500 mt-2 font-medium">300 â€” 499 pts</p>
                            <div class="w-full bg-slate-100 rounded-full h-1.5 mt-2">
                                <div class="bg-amber-700 h-1.5 rounded-full" style="width:40%"></div>
                            </div>
                        </div>
                    </div>
                    <!-- High Risk -->
                    <div id="ap-tier-uninsured" class="relative rounded-xl border-2 p-4 transition-all duration-500 border-slate-200 bg-white">
                        <div class="absolute -top-2.5 left-3 px-2 py-0.5 rounded-full text-[8px] font-bold uppercase tracking-widest bg-red-500 text-white">High Risk</div>
                        <div class="mt-2 text-center">
                            <p class="text-2xl font-black text-red-500">2.5%+</p>
                            <p class="text-[9px] text-slate-400 font-semibold mt-1">Interest Rate</p>
                            <p class="text-[10px] text-slate-500 mt-2 font-medium">Below 300 pts</p>
                            <div class="w-full bg-slate-100 rounded-full h-1.5 mt-2">
                                <div class="bg-red-500 h-1.5 rounded-full" style="width:20%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Row: Radar Chart + Score Trend -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
                    <!-- Score Breakdown â€” Radar Chart -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                        <div class="px-5 py-4 border-b border-slate-100 flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-violet-50 flex items-center justify-center"><svg class="w-4 h-4 text-violet-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 3m8.5-3l1 3m0 0l.5 1.5m-.5-1.5h-9.5m0 0l-.5 1.5"/></svg></div>
                            <div>
                                <p class="text-sm font-semibold text-slate-700">Score Breakdown</p>
                                <p class="text-[10px] text-slate-400">6 behavioral dimensions analyzed</p>
                            </div>
                        </div>
                        <div class="p-4" style="height:320px">
                            <canvas id="ap-radar-chart"></canvas>
                        </div>
                    </div>
                    <!-- 7-Day Score Trend -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                        <div class="px-5 py-4 border-b border-slate-100 flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-blue-50 flex items-center justify-center"><svg class="w-4 h-4 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941"/></svg></div>
                            <div>
                                <p class="text-sm font-semibold text-slate-700">7-Day Score Trend</p>
                                <p class="text-[10px] text-slate-400">Your score progression over time</p>
                            </div>
                        </div>
                        <div class="p-4" style="height:320px">
                            <canvas id="ap-trend-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Risk Factors Analysis -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                    <div class="px-5 py-4 border-b border-slate-100 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-red-50 flex items-center justify-center"><svg class="w-4 h-4 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/></svg></div>
                        <div>
                            <p class="text-sm font-semibold text-slate-700">Risk Factor Analysis</p>
                            <p class="text-[10px] text-slate-400">Factors affecting your ADAR score & premium</p>
                        </div>
                    </div>
                    <div id="ap-risk-factors" class="p-5">
                        <div class="flex items-center justify-center py-8 text-slate-300">
                            <svg class="w-5 h-5 animate-spin mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                            <span class="text-xs">Analyzing risk factorsâ€¦</span>
                        </div>
                    </div>
                </div>

                <!-- Insurance Partner Offers -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                    <div class="px-5 py-4 border-b border-slate-100 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-emerald-50 flex items-center justify-center"><svg class="w-4 h-4 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z"/></svg></div>
                        <div>
                            <p class="text-sm font-semibold text-slate-700">Insurance Partner Offers</p>
                            <p class="text-[10px] text-slate-400">Personalized plans based on your ADAR score</p>
                        </div>
                    </div>
                    <div id="ap-partner-cards" class="p-5">
                        <div class="flex items-center justify-center py-8 text-slate-300">
                            <svg class="w-5 h-5 animate-spin mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                            <span class="text-xs">Loading partner offersâ€¦</span>
                        </div>
                    </div>
                </div>

                <!-- Row: Event Summary + Biometrics -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
                    <!-- Event Summary Donut -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                        <div class="px-5 py-4 border-b border-slate-100 flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-amber-50 flex items-center justify-center"><svg class="w-4 h-4 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 107.5 7.5h-7.5V6z"/><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0013.5 3v7.5z"/></svg></div>
                            <div>
                                <p class="text-sm font-semibold text-slate-700">Event Impact Distribution</p>
                                <p class="text-[10px] text-slate-400">How each event type affects your score</p>
                            </div>
                        </div>
                        <div class="p-4" style="height:300px">
                            <canvas id="ap-events-chart"></canvas>
                        </div>
                    </div>
                    <!-- Biometric Health -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                        <div class="px-5 py-4 border-b border-slate-100 flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-cyan-50 flex items-center justify-center"><svg class="w-4 h-4 text-cyan-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.502-4.688-4.502-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z"/></svg></div>
                            <div>
                                <p class="text-sm font-semibold text-slate-700">Biometric Health Indicators</p>
                                <p class="text-[10px] text-slate-400">Real-time physiological metrics</p>
                            </div>
                        </div>
                        <div id="ap-biometrics" class="p-5 space-y-4">
                            <!-- EAR -->
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-[11px] font-semibold text-slate-600">Eye Aspect Ratio (EAR)</span>
                                    <span id="ap-bio-ear" class="text-[11px] font-mono font-bold text-slate-700">â€”</span>
                                </div>
                                <div class="w-full bg-slate-100 rounded-full h-2"><div id="ap-bio-ear-bar" class="bg-emerald-500 h-2 rounded-full transition-all duration-700" style="width:70%"></div></div>
                                <p class="text-[9px] text-slate-400 mt-0.5">Normal: 0.20â€“0.35 | Below 0.20 = Drowsy</p>
                            </div>
                            <!-- EAR Stability -->
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-[11px] font-semibold text-slate-600">EAR Stability Index</span>
                                    <span id="ap-bio-stability" class="text-[11px] font-mono font-bold text-slate-700">â€”%</span>
                                </div>
                                <div class="w-full bg-slate-100 rounded-full h-2"><div id="ap-bio-stability-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-700" style="width:85%"></div></div>
                                <p class="text-[9px] text-slate-400 mt-0.5">Higher is better â€” consistent eye openness</p>
                            </div>
                            <!-- MAR -->
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-[11px] font-semibold text-slate-600">Mouth Aspect Ratio (MAR)</span>
                                    <span id="ap-bio-mar" class="text-[11px] font-mono font-bold text-slate-700">â€”</span>
                                </div>
                                <div class="w-full bg-slate-100 rounded-full h-2"><div id="ap-bio-mar-bar" class="bg-amber-500 h-2 rounded-full transition-all duration-700" style="width:30%"></div></div>
                                <p class="text-[9px] text-slate-400 mt-0.5">Normal: 0.05â€“0.30 | Above 0.60 = Yawning</p>
                            </div>
                            <!-- Safety Score -->
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-[11px] font-semibold text-slate-600">Avg Safety Score</span>
                                    <span id="ap-bio-safety" class="text-[11px] font-mono font-bold text-slate-700">â€”</span>
                                </div>
                                <div class="w-full bg-slate-100 rounded-full h-2"><div id="ap-bio-safety-bar" class="bg-violet-500 h-2 rounded-full transition-all duration-700" style="width:95%"></div></div>
                                <p class="text-[9px] text-slate-400 mt-0.5">Composite attention score from CV pipeline</p>
                            </div>
                            <!-- Frames Analyzed -->
                            <div class="pt-2 border-t border-slate-100 flex items-center justify-between">
                                <span class="text-[10px] text-slate-400">Total Frames Analyzed</span>
                                <span id="ap-bio-frames" class="text-xs font-mono font-bold text-slate-600">â€”</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Insights -->
                <div class="bg-gradient-to-br from-indigo-50 to-violet-50 rounded-xl border border-indigo-100 shadow-sm">
                    <div class="px-5 py-4 border-b border-indigo-100 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-indigo-100 flex items-center justify-center"><svg class="w-4 h-4 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.455 2.456L21.75 6l-1.036.259a3.375 3.375 0 00-2.455 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z"/></svg></div>
                        <div>
                            <p class="text-sm font-semibold text-indigo-800">AI Insurance Advisor</p>
                            <p class="text-[10px] text-indigo-500">Personalized recommendations to maximize your ADAR score</p>
                        </div>
                    </div>
                    <div id="ap-insights" class="p-5 space-y-2">
                        <div class="flex items-center justify-center py-6 text-indigo-300">
                            <svg class="w-5 h-5 animate-spin mr-2" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                            <span class="text-xs">Generating AI insightsâ€¦</span>
                        </div>
                    </div>
                </div>

                <!-- How ADAR Points Work -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                    <div class="px-5 py-4 border-b border-slate-100 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center"><svg class="w-4 h-4 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z"/></svg></div>
                        <div>
                            <p class="text-sm font-semibold text-slate-700">How ADAR Points Work</p>
                            <p class="text-[10px] text-slate-400">Understanding the scoring methodology</p>
                        </div>
                    </div>
                    <div class="p-5">
                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-3">
                            <div class="text-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-xl font-black text-indigo-600">25%</p>
                                <p class="text-[10px] font-semibold text-slate-600 mt-1">Drowsiness Control</p>
                                <p class="text-[8px] text-slate-400 mt-0.5">Eye closure events & duration</p>
                            </div>
                            <div class="text-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-xl font-black text-blue-600">20%</p>
                                <p class="text-[10px] font-semibold text-slate-600 mt-1">Attention Focus</p>
                                <p class="text-[8px] text-slate-400 mt-0.5">Distraction & phone usage</p>
                            </div>
                            <div class="text-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-xl font-black text-cyan-600">15%</p>
                                <p class="text-[10px] font-semibold text-slate-600 mt-1">Fatigue Management</p>
                                <p class="text-[8px] text-slate-400 mt-0.5">Yawning & EAR consistency</p>
                            </div>
                            <div class="text-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-xl font-black text-emerald-600">15%</p>
                                <p class="text-[10px] font-semibold text-slate-600 mt-1">Consistency</p>
                                <p class="text-[8px] text-slate-400 mt-0.5">Safety score stability</p>
                            </div>
                            <div class="text-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-xl font-black text-violet-600">15%</p>
                                <p class="text-[10px] font-semibold text-slate-600 mt-1">Clean Streak</p>
                                <p class="text-[8px] text-slate-400 mt-0.5">Minutes without alerts</p>
                            </div>
                            <div class="text-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-xl font-black text-amber-600">10%</p>
                                <p class="text-[10px] font-semibold text-slate-600 mt-1">Compliance</p>
                                <p class="text-[8px] text-slate-400 mt-0.5">Seatbelt & speed limits</p>
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-indigo-50 rounded-lg border border-indigo-100">
                            <p class="text-[10px] text-indigo-700 leading-relaxed"><strong>Scoring Formula:</strong> ADAR Points = (DrowsinessÃ—2.5 + AttentionÃ—2.0 + FatigueÃ—1.5 + ConsistencyÃ—1.5 + StreakÃ—1.5 + ComplianceÃ—1.0). Each dimension is scored 0-100, weighted, and combined into a final 0-1000 score. This score directly maps to your insurance premium tier â€” higher score = lower premium.</p>
                        </div>
                    </div>
                </div>

            </div><!-- /p-6 -->
        </div><!-- /page-adar-points -->

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- â•â•â•â•â•â•â•â•â•â• PAGE: ANALYTICS â€” Fleet Intelligence Engine â•â•â•â•â•â•â•â•â•â• -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div id="page-analytics" class="page-section h-full overflow-y-auto">

            <!-- â”€â”€ Hero Header â”€â”€ -->
            <div class="bg-gradient-to-r from-violet-900 via-indigo-800 to-violet-900 px-6 py-5">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div class="flex items-center gap-5">
                        <!-- Analytics Score Gauge -->
                        <div class="relative flex-shrink-0" style="width:96px;height:96px;">
                            <svg viewBox="0 0 100 100" class="w-full h-full">
                                <circle cx="50" cy="50" r="42" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="6"/>
                                <circle id="an-score-ring" cx="50" cy="50" r="42" fill="none" stroke="#818cf8" stroke-width="6"
                                    stroke-linecap="round" stroke-dasharray="263.9" stroke-dashoffset="5.3"
                                    transform="rotate(-90 50 50)" style="transition:stroke-dashoffset 1s ease,stroke .5s ease;"/>
                                <text x="50" y="46" text-anchor="middle" font-size="22" font-weight="800" fill="#fff" id="an-score-text">98</text>
                                <text x="50" y="60" text-anchor="middle" font-size="8" font-weight="500" fill="rgba(255,255,255,0.5)">FLEET IQ</text>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-white tracking-tight">Fleet Analytics Engine</h2>
                            <p class="text-xs text-indigo-300/70 mt-0.5">Deep fleet intelligence &bull; Anomaly detection &bull; Predictive insights</p>
                            <div class="flex items-center gap-2 mt-2 flex-wrap">
                                <span class="px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-indigo-500/20 text-indigo-300 border border-indigo-500/30">SESSION ACTIVE</span>
                                <span class="px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-violet-500/20 text-violet-300 border border-violet-500/30">AI ENGINE ON</span>
                                <span id="an-data-badge" class="px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-emerald-500/20 text-emerald-300 border border-emerald-500/30">LIVE DATA</span>
                            </div>
                        </div>
                    </div>
                    <!-- Hero KPIs -->
                    <div class="flex items-center gap-5 flex-wrap">
                        <div class="text-center"><p class="text-2xl font-extrabold text-white" id="an-kpi-vehicles">0</p><p class="text-[9px] text-indigo-400 uppercase font-semibold tracking-widest">Vehicles</p></div>
                        <div class="w-px h-10 bg-white/10"></div>
                        <div class="text-center"><p class="text-2xl font-extrabold text-indigo-300" id="an-kpi-events">0</p><p class="text-[9px] text-indigo-400 uppercase font-semibold tracking-widest">Events</p></div>
                        <div class="w-px h-10 bg-white/10"></div>
                        <div class="text-center"><p class="text-2xl font-extrabold text-violet-300" id="an-kpi-anomalies">0</p><p class="text-[9px] text-indigo-400 uppercase font-semibold tracking-widest">Anomalies</p></div>
                        <div class="w-px h-10 bg-white/10"></div>
                        <div class="text-center"><p class="text-[10px] text-indigo-400 uppercase font-semibold tracking-widest mb-0.5">Uptime</p><p class="text-sm font-bold font-mono text-indigo-200" id="an-session-clock">00:00:00</p></div>
                    </div>
                </div>
            </div>

            <!-- â”€â”€ Main Content â”€â”€ -->
            <div class="p-6 space-y-5">

                <!-- â”€â”€ Row 0: Filters & Controls â”€â”€ -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm px-5 py-3 flex flex-wrap items-center gap-4">
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-slate-500 font-semibold uppercase tracking-wide">Vehicle</label>
                        <select id="an-filter-vehicle" class="px-2 py-1 rounded-lg border border-slate-200 text-xs bg-slate-50 focus:ring-2 focus:ring-indigo-200 outline-none">
                            <option value="all">All Vehicles</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-slate-500 font-semibold uppercase tracking-wide">Period</label>
                        <select id="an-filter-period" class="px-2 py-1 rounded-lg border border-slate-200 text-xs bg-slate-50 focus:ring-2 focus:ring-indigo-200 outline-none">
                            <option value="session">This Session</option>
                            <option value="1h">Last Hour</option>
                            <option value="24h">Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                            <option value="30d">Last 30 Days</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-[10px] text-slate-500 font-semibold uppercase tracking-wide">Event</label>
                        <select id="an-filter-event" class="px-2 py-1 rounded-lg border border-slate-200 text-xs bg-slate-50 focus:ring-2 focus:ring-indigo-200 outline-none">
                            <option value="all">All Types</option>
                            <option value="drowsiness">Drowsiness</option>
                            <option value="yawning">Yawning</option>
                            <option value="distraction">Distraction</option>
                            <option value="phone">Phone Use</option>
                            <option value="looking_away">Looking Away</option>
                        </select>
                    </div>
                    <div class="flex-1"></div>
                    <button id="an-btn-refresh" class="px-3 py-1.5 rounded-lg bg-indigo-50 text-indigo-600 text-[11px] font-semibold hover:bg-indigo-100 transition-colors flex items-center gap-1.5">
                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182"/></svg>
                        Refresh
                    </button>
                    <button id="an-btn-export" class="px-3 py-1.5 rounded-lg bg-violet-50 text-violet-600 text-[11px] font-semibold hover:bg-violet-100 transition-colors flex items-center gap-1.5">
                        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>
                        Export CSV
                    </button>
                </div>

                <!-- â”€â”€ Row 1: Fleet Event Timeline (wide) + Anomaly Radar â”€â”€ -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Fleet Event Timeline -->
                    <div class="lg:col-span-2 bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <p class="text-sm font-semibold text-slate-700">Fleet Event Timeline</p>
                                <p class="text-[10px] text-slate-400">Stacked event frequency across all vehicles &bull; Real-time</p>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <span class="w-2.5 h-2.5 rounded-full bg-red-500"></span><span class="text-[9px] text-slate-400">Drowsy</span>
                                <span class="w-2.5 h-2.5 rounded-full bg-amber-400 ml-1.5"></span><span class="text-[9px] text-slate-400">Yawn</span>
                                <span class="w-2.5 h-2.5 rounded-full bg-orange-500 ml-1.5"></span><span class="text-[9px] text-slate-400">Distract</span>
                                <span class="w-2.5 h-2.5 rounded-full bg-pink-500 ml-1.5"></span><span class="text-[9px] text-slate-400">Phone</span>
                                <span class="w-2.5 h-2.5 rounded-full bg-blue-400 ml-1.5"></span><span class="text-[9px] text-slate-400">Away</span>
                            </div>
                        </div>
                        <div style="height:210px;"><canvas id="an-timeline-chart"></canvas></div>
                    </div>

                    <!-- Anomaly Detection Radar -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                        <div class="mb-3">
                            <p class="text-sm font-semibold text-slate-700">Anomaly Radar</p>
                            <p class="text-[10px] text-slate-400">Multi-dimensional anomaly scoring</p>
                        </div>
                        <div style="height:210px;"><canvas id="an-anomaly-chart"></canvas></div>
                    </div>
                </div>

                <!-- â”€â”€ Row 2: Vehicle Comparison + EAR/MAR Correlation + Trend Forecast â”€â”€ -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Vehicle Comparison -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                        <div class="mb-3">
                            <p class="text-sm font-semibold text-slate-700">Vehicle Comparison</p>
                            <p class="text-[10px] text-slate-400">Safety score across fleet members</p>
                        </div>
                        <div style="height:180px;"><canvas id="an-vehicle-chart"></canvas></div>
                    </div>

                    <!-- EAR/MAR Correlation Scatter -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                        <div class="mb-3">
                            <p class="text-sm font-semibold text-slate-700">EAR vs MAR Correlation</p>
                            <p class="text-[10px] text-slate-400">Biometric correlation analysis</p>
                        </div>
                        <div style="height:180px;"><canvas id="an-corr-chart"></canvas></div>
                    </div>

                    <!-- AI Trend Forecast -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                        <div class="mb-3">
                            <p class="text-sm font-semibold text-slate-700">AI Trend Forecast</p>
                            <p class="text-[10px] text-slate-400">Predicted safety trajectory &bull; Next 30 min</p>
                        </div>
                        <div style="height:180px;"><canvas id="an-trend-chart"></canvas></div>
                    </div>
                </div>

                <!-- â”€â”€ Row 3: Safety Heatmap + Event Distribution Donut â”€â”€ -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <!-- Safety Heatmap (Hour Ã— Day) -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                        <div class="mb-3">
                            <p class="text-sm font-semibold text-slate-700">Safety Heatmap</p>
                            <p class="text-[10px] text-slate-400">Event density across hours &bull; When are drivers most at risk?</p>
                        </div>
                        <div id="an-heatmap-container" class="overflow-x-auto" style="min-height:160px;">
                            <!-- 24-col SVG heatmap rendered by JS -->
                            <svg id="an-heatmap-svg" viewBox="0 0 600 120" class="w-full" style="min-width:500px;"></svg>
                        </div>
                        <div class="flex items-center justify-between mt-2">
                            <span class="text-[9px] text-slate-400">Less Events</span>
                            <div class="flex gap-0.5">
                                <div class="w-4 h-3 rounded-sm" style="background:#eef2ff"></div>
                                <div class="w-4 h-3 rounded-sm" style="background:#c7d2fe"></div>
                                <div class="w-4 h-3 rounded-sm" style="background:#818cf8"></div>
                                <div class="w-4 h-3 rounded-sm" style="background:#6366f1"></div>
                                <div class="w-4 h-3 rounded-sm" style="background:#4338ca"></div>
                            </div>
                            <span class="text-[9px] text-slate-400">More Events</span>
                        </div>
                    </div>

                    <!-- Event Distribution Donut -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                        <div class="mb-3">
                            <p class="text-sm font-semibold text-slate-700">Event Distribution</p>
                            <p class="text-[10px] text-slate-400">Proportional breakdown by type</p>
                        </div>
                        <div class="flex items-center gap-6">
                            <div style="width:170px;height:170px;" class="flex-shrink-0"><canvas id="an-donut-chart"></canvas></div>
                            <div class="space-y-2 flex-1" id="an-donut-legend">
                                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-red-500"></span><span class="text-[11px] text-slate-600">Drowsiness</span><span class="text-[10px] font-bold text-slate-800 ml-auto" id="an-donut-drowsy">0</span></div>
                                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-amber-400"></span><span class="text-[11px] text-slate-600">Yawning</span><span class="text-[10px] font-bold text-slate-800 ml-auto" id="an-donut-yawn">0</span></div>
                                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-orange-500"></span><span class="text-[11px] text-slate-600">Distraction</span><span class="text-[10px] font-bold text-slate-800 ml-auto" id="an-donut-distract">0</span></div>
                                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-pink-500"></span><span class="text-[11px] text-slate-600">Phone Use</span><span class="text-[10px] font-bold text-slate-800 ml-auto" id="an-donut-phone">0</span></div>
                                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-blue-400"></span><span class="text-[11px] text-slate-600">Looking Away</span><span class="text-[10px] font-bold text-slate-800 ml-auto" id="an-donut-away">0</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- â”€â”€ Row 4: Event Log + AI Insights â”€â”€ -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <!-- Live Event Log -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                        <div class="px-5 py-3 border-b border-slate-100 flex items-center justify-between">
                            <div><p class="text-sm font-semibold text-slate-700">Live Event Log</p><p class="text-[10px] text-slate-400">Chronological fleet event stream</p></div>
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-600 text-[10px] font-bold" id="an-log-count">0</span>
                                <button id="an-log-refresh" class="px-2.5 py-1 rounded-lg bg-indigo-50 text-indigo-600 text-[10px] font-semibold hover:bg-indigo-100 transition-colors">Refresh</button>
                            </div>
                        </div>
                        <div id="an-event-log" class="flex-1 overflow-y-auto p-3 space-y-1.5" style="max-height:240px;">
                            <div class="flex flex-col items-center justify-center py-10 text-slate-300" id="an-no-log">
                                <svg class="w-8 h-8 mb-2 text-slate-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                <span class="text-[10px]">Waiting for fleet events&hellip;</span>
                            </div>
                        </div>
                    </div>

                    <!-- AI Analytics Insights -->
                    <div class="bg-gradient-to-br from-indigo-50 via-violet-50 to-purple-50 rounded-xl border border-indigo-100 shadow-sm p-5 flex flex-col">
                        <div class="flex items-center gap-2 mb-4">
                            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-600 to-violet-600 flex items-center justify-center shadow-md">
                                <svg class="w-4.5 h-4.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.455 2.456L21.75 6l-1.036.259a3.375 3.375 0 00-2.455 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z"/></svg>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-slate-700">AI Analytics Insights</p>
                                <p class="text-[10px] text-slate-400">Intelligent fleet-wide recommendations</p>
                            </div>
                        </div>
                        <div id="an-ai-insights" class="space-y-2.5 flex-1 overflow-y-auto" style="max-height:200px;">
                            <div class="flex items-start gap-2.5 p-3 bg-white/70 rounded-lg border border-white/80 shadow-sm">
                                <span class="text-base mt-0.5">ðŸ§ </span>
                                <div>
                                    <p class="text-[11px] font-semibold text-slate-700">Analytics Engine Initializing</p>
                                    <p class="text-[10px] text-slate-400">AI pipeline is calibrating. Insights will populate as telemetry data arrives from connected vehicles.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- â”€â”€ Row 5: Session Summary Footer â”€â”€ -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-sm font-semibold text-slate-700">Analytics Session Summary</p>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-slate-400">Fleet:</span>
                            <span class="px-2 py-0.5 rounded bg-indigo-100 text-[10px] font-bold text-indigo-600" id="an-summary-fleet">â€”</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-4">
                        <div class="text-center">
                            <p class="text-lg font-bold text-slate-800" id="an-sum-events">0</p>
                            <p class="text-[9px] text-slate-400 uppercase font-semibold">Total Events</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-indigo-600" id="an-sum-anomalies">0</p>
                            <p class="text-[9px] text-slate-400 uppercase font-semibold">Anomalies</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-violet-600" id="an-sum-avg-score">98</p>
                            <p class="text-[9px] text-slate-400 uppercase font-semibold">Avg Score</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-violet-600" id="an-sum-min-score">98</p>
                            <p class="text-[9px] text-slate-400 uppercase font-semibold">Min Score</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-blue-600" id="an-sum-avg-ear">0.280</p>
                            <p class="text-[9px] text-slate-400 uppercase font-semibold">Avg EAR</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-blue-600" id="an-sum-min-ear">0.280</p>
                            <p class="text-[9px] text-slate-400 uppercase font-semibold">Min EAR</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-violet-600" id="an-sum-avg-mar">0.140</p>
                            <p class="text-[9px] text-slate-400 uppercase font-semibold">Avg MAR</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-slate-800" id="an-sum-vehicles">0</p>
                            <p class="text-[9px] text-slate-400 uppercase font-semibold">Vehicles</p>
                        </div>
                    </div>
                </div>

            </div><!-- /p-6 content -->
        </div><!-- /page-analytics -->

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- â•â•â•â•â•â•â•â•â•â• PAGE: SETTINGS â€” System Configuration â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div id="page-settings" class="page-section h-full overflow-y-auto">

            <!-- Settings Hero -->
            <div class="bg-gradient-to-r from-slate-800 via-slate-700 to-slate-800 px-6 py-5">
                <div class="flex items-center gap-5">
                    <div class="w-12 h-12 rounded-xl bg-white/10 flex items-center justify-center">
                        <svg class="w-6 h-6 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 010 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 010-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-white tracking-tight">System Settings</h2>
                        <p class="text-xs text-slate-400 mt-0.5">Configure fleet parameters, alerts, display, and connectivity</p>
                    </div>
                </div>
            </div>

            <div class="p-6 space-y-5">

                <!-- Section 1: Fleet & Vehicle Configuration -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                    <div class="px-5 py-4 border-b border-slate-100 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-blue-50 flex items-center justify-center"><svg class="w-4 h-4 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.125-.504 1.125-1.125v-3.026a3 3 0 00-.879-2.121L16.5 9.128V4.875A1.125 1.125 0 0015.375 3.75h-8.25A1.125 1.125 0 006 4.875V9.128l-.966.966A3 3 0 004.125 12.254v4.621A1.125 1.125 0 005.25 18h.375"/></svg></div>
                        <div>
                            <p class="text-sm font-semibold text-slate-700">Fleet & Vehicle</p>
                            <p class="text-[10px] text-slate-400">Vehicle identity, fleet name, and server connection</p>
                        </div>
                    </div>
                    <div class="p-5 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Fleet Name</label>
                                <input id="set-fleet-name" type="text" value="ADAR Fleet Alpha" class="w-full px-3 py-2 rounded-lg border border-slate-200 text-sm bg-slate-50 focus:ring-2 focus:ring-blue-200 focus:border-blue-400 outline-none transition-all" />
                            </div>
                            <div>
                                <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Vehicle ID</label>
                                <input id="set-vehicle-id" type="text" value="" placeholder="Auto-detected" class="w-full px-3 py-2 rounded-lg border border-slate-200 text-sm bg-slate-50 focus:ring-2 focus:ring-blue-200 focus:border-blue-400 outline-none transition-all" />
                            </div>
                            <div>
                                <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Server URL</label>
                                <input id="set-server-url" type="text" value="http://localhost:8000" class="w-full px-3 py-2 rounded-lg border border-slate-200 text-sm bg-slate-50 focus:ring-2 focus:ring-blue-200 focus:border-blue-400 outline-none transition-all font-mono" />
                            </div>
                            <div>
                                <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Driver Name</label>
                                <input id="set-driver-name" type="text" value="" placeholder="Optional" class="w-full px-3 py-2 rounded-lg border border-slate-200 text-sm bg-slate-50 focus:ring-2 focus:ring-blue-200 focus:border-blue-400 outline-none transition-all" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Alert & Safety Thresholds -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                    <div class="px-5 py-4 border-b border-slate-100 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-red-50 flex items-center justify-center"><svg class="w-4 h-4 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0"/></svg></div>
                        <div>
                            <p class="text-sm font-semibold text-slate-700">Alert & Safety Thresholds</p>
                            <p class="text-[10px] text-slate-400">Configure when alerts are triggered</p>
                        </div>
                    </div>
                    <div class="p-5 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">EAR Drowsiness Threshold</label>
                                <div class="flex items-center gap-3">
                                    <input id="set-ear-threshold" type="range" min="0.10" max="0.35" step="0.01" value="0.20" class="flex-1 accent-red-500" />
                                    <span id="set-ear-threshold-val" class="text-xs font-mono font-bold text-slate-700 w-10 text-right">0.20</span>
                                </div>
                                <p class="text-[9px] text-slate-400 mt-1">Eyes considered closed below this value</p>
                            </div>
                            <div>
                                <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">MAR Yawn Threshold</label>
                                <div class="flex items-center gap-3">
                                    <input id="set-mar-threshold" type="range" min="0.30" max="1.00" step="0.05" value="0.60" class="flex-1 accent-amber-500" />
                                    <span id="set-mar-threshold-val" class="text-xs font-mono font-bold text-slate-700 w-10 text-right">0.60</span>
                                </div>
                                <p class="text-[9px] text-slate-400 mt-1">Mouth open above this triggers yawn alert</p>
                            </div>
                            <div>
                                <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">CO&#8322; Warning Level (ppm)</label>
                                <div class="flex items-center gap-3">
                                    <input id="set-co2-threshold" type="range" min="400" max="2000" step="50" value="800" class="flex-1 accent-cyan-500" />
                                    <span id="set-co2-threshold-val" class="text-xs font-mono font-bold text-slate-700 w-10 text-right">800</span>
                                </div>
                                <p class="text-[9px] text-slate-400 mt-1">CO&#8322; above this value triggers air quality warning</p>
                            </div>
                            <div>
                                <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Speed Limit (km/h)</label>
                                <div class="flex items-center gap-3">
                                    <input id="set-speed-limit" type="range" min="40" max="200" step="10" value="120" class="flex-1 accent-blue-500" />
                                    <span id="set-speed-limit-val" class="text-xs font-mono font-bold text-slate-700 w-10 text-right">120</span>
                                </div>
                                <p class="text-[9px] text-slate-400 mt-1">Speed above this triggers over-speed alert</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2">
                            <div>
                                <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Drowsy Duration Alert (seconds)</label>
                                <div class="flex items-center gap-3">
                                    <input id="set-drowsy-dur" type="range" min="0.5" max="5.0" step="0.5" value="1.5" class="flex-1 accent-red-500" />
                                    <span id="set-drowsy-dur-val" class="text-xs font-mono font-bold text-slate-700 w-10 text-right">1.5s</span>
                                </div>
                                <p class="text-[9px] text-slate-400 mt-1">Continuous eyes-closed duration before critical alert</p>
                            </div>
                            <div>
                                <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Alert Sound</label>
                                <div class="flex items-center gap-3">
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input id="set-alert-sound" type="checkbox" checked class="sr-only peer" />
                                        <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600 transition-colors"></div>
                                    </label>
                                    <span class="text-xs text-slate-600">Enabled</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Display & UI -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                    <div class="px-5 py-4 border-b border-slate-100 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-violet-50 flex items-center justify-center"><svg class="w-4 h-4 text-violet-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.4 2.245 4.5 4.5 0 008.4-2.245c0-.399-.078-.78-.22-1.128zm0 0a15.998 15.998 0 003.388-1.62m-5.043-.025a15.994 15.994 0 011.622-3.395m3.42 3.42a15.995 15.995 0 004.764-4.648l3.876-5.814a1.151 1.151 0 00-1.597-1.597L14.146 6.32a15.996 15.996 0 00-4.649 4.763m3.42 3.42a6.776 6.776 0 00-3.42-3.42"/></svg></div>
                        <div>
                            <p class="text-sm font-semibold text-slate-700">Display & UI</p>
                            <p class="text-[10px] text-slate-400">Dashboard appearance and polling intervals</p>
                        </div>
                    </div>
                    <div class="p-5 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Dashboard Refresh Rate</label>
                                <select id="set-refresh-rate" class="w-full px-3 py-2 rounded-lg border border-slate-200 text-sm bg-slate-50 focus:ring-2 focus:ring-violet-200 outline-none">
                                    <option value="1000">1 second (High Performance)</option>
                                    <option value="2000">2 seconds (Balanced)</option>
                                    <option value="5000" selected>5 seconds (Default)</option>
                                    <option value="10000">10 seconds (Low Power)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Map Style</label>
                                <select id="set-map-style" class="w-full px-3 py-2 rounded-lg border border-slate-200 text-sm bg-slate-50 focus:ring-2 focus:ring-violet-200 outline-none">
                                    <option value="street" selected>Street View</option>
                                    <option value="satellite">Satellite</option>
                                    <option value="dark">Dark Mode</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Temperature Unit</label>
                                <select id="set-temp-unit" class="w-full px-3 py-2 rounded-lg border border-slate-200 text-sm bg-slate-50 focus:ring-2 focus:ring-violet-200 outline-none">
                                    <option value="celsius" selected>Celsius (Â°C)</option>
                                    <option value="fahrenheit">Fahrenheit (Â°F)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[11px] font-semibold text-slate-600 mb-1.5">Speed Unit</label>
                                <select id="set-speed-unit" class="w-full px-3 py-2 rounded-lg border border-slate-200 text-sm bg-slate-50 focus:ring-2 focus:ring-violet-200 outline-none">
                                    <option value="kmh" selected>km/h</option>
                                    <option value="mph">mph</option>
                                    <option value="ms">m/s</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-2">
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                <span class="text-xs text-slate-600 font-medium">Show GPS Trail</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input id="set-show-trail" type="checkbox" checked class="sr-only peer" />
                                    <div class="w-9 h-5 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-violet-600 transition-colors"></div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                <span class="text-xs text-slate-600 font-medium">Dark Sidebar</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input id="set-dark-sidebar" type="checkbox" checked class="sr-only peer" />
                                    <div class="w-9 h-5 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-violet-600 transition-colors"></div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                <span class="text-xs text-slate-600 font-medium">Compact Mode</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input id="set-compact-mode" type="checkbox" class="sr-only peer" />
                                    <div class="w-9 h-5 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-violet-600 transition-colors"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 4: Connectivity & Sensors -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                    <div class="px-5 py-4 border-b border-slate-100 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-emerald-50 flex items-center justify-center"><svg class="w-4 h-4 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.288 15.038a5.25 5.25 0 017.424 0M5.106 11.856c3.807-3.808 9.98-3.808 13.788 0M1.924 8.674c5.565-5.565 14.587-5.565 20.152 0M12.53 18.22l-.53.53-.53-.53a.75.75 0 011.06 0z"/></svg></div>
                        <div>
                            <p class="text-sm font-semibold text-slate-700">Connectivity & Sensors</p>
                            <p class="text-[10px] text-slate-400">WebSocket, GPS, IMU, and sensor configuration</p>
                        </div>
                    </div>
                    <div class="p-5">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- WebSocket Status -->
                            <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                <div class="flex items-center gap-2 mb-2">
                                    <span id="set-ws-dot" class="w-2.5 h-2.5 rounded-full bg-emerald-500 dot-blink"></span>
                                    <span class="text-[11px] font-semibold text-slate-700">WebSocket</span>
                                </div>
                                <p class="text-[10px] text-slate-400" id="set-ws-status">Connected</p>
                                <p class="text-[9px] text-slate-400 mt-1 font-mono" id="set-ws-url">ws://localhost:8000/ws/dashboard</p>
                            </div>
                            <!-- GPS Status -->
                            <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                <div class="flex items-center gap-2 mb-2">
                                    <span id="set-gps-dot" class="w-2.5 h-2.5 rounded-full bg-amber-500"></span>
                                    <span class="text-[11px] font-semibold text-slate-700">GPS</span>
                                </div>
                                <p class="text-[10px] text-slate-400" id="set-gps-source">Browser Geolocation</p>
                                <p class="text-[9px] text-slate-400 mt-1" id="set-gps-accuracy">Accuracy: â€”</p>
                            </div>
                            <!-- IMU Status -->
                            <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                <div class="flex items-center gap-2 mb-2">
                                    <span id="set-imu-dot" class="w-2.5 h-2.5 rounded-full bg-slate-400"></span>
                                    <span class="text-[11px] font-semibold text-slate-700">IMU (MPU6050)</span>
                                </div>
                                <p class="text-[10px] text-slate-400" id="set-imu-status">Waiting for dataâ€¦</p>
                            </div>
                            <!-- COâ‚‚ Sensor -->
                            <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                <div class="flex items-center gap-2 mb-2">
                                    <span id="set-co2s-dot" class="w-2.5 h-2.5 rounded-full bg-slate-400"></span>
                                    <span class="text-[11px] font-semibold text-slate-700">CO&#8322; Sensor (MQ135)</span>
                                </div>
                                <p class="text-[10px] text-slate-400" id="set-co2s-status">Waiting for dataâ€¦</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 5: Data & Export -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                    <div class="px-5 py-4 border-b border-slate-100 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center"><svg class="w-4 h-4 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125"/></svg></div>
                        <div>
                            <p class="text-sm font-semibold text-slate-700">Data & Export</p>
                            <p class="text-[10px] text-slate-400">Data management, clearing, and export options</p>
                        </div>
                    </div>
                    <div class="p-5">
                        <div class="flex flex-wrap gap-3">
                            <button id="set-export-session" class="px-4 py-2 rounded-lg bg-indigo-50 text-indigo-600 text-xs font-semibold hover:bg-indigo-100 transition-colors flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>
                                Export Session Data
                            </button>
                            <button id="set-export-alerts" class="px-4 py-2 rounded-lg bg-red-50 text-red-600 text-xs font-semibold hover:bg-red-100 transition-colors flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>
                                Export Alert History
                            </button>
                            <button id="set-clear-alerts" class="px-4 py-2 rounded-lg bg-slate-100 text-slate-600 text-xs font-semibold hover:bg-slate-200 transition-colors flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"/></svg>
                                Clear Session Data
                            </button>
                        </div>
                        <p class="text-[9px] text-slate-400 mt-3">Exported data will be saved as CSV files. Clearing session data will reset all counters and charts.</p>
                    </div>
                </div>

                <!-- Section 6: About -->
                <div class="bg-gradient-to-br from-slate-50 to-blue-50 rounded-xl border border-slate-200 shadow-sm p-5">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center shadow-md flex-shrink-0">
                            <span class="text-white font-extrabold text-sm">A</span>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-bold text-slate-800">ADAR â€” Advanced Driver Attention & Response</p>
                            <p class="text-[11px] text-slate-500 mt-0.5">Version 3.0.0 &bull; Fleet Command Center</p>
                            <p class="text-[10px] text-slate-400 mt-1">Real-time driver safety monitoring using Computer Vision, IoT sensors, and AI-powered analytics. Built with FastAPI, OpenCV, MediaPipe, and Chart.js.</p>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="text-[9px] text-slate-400 uppercase font-semibold">Session Started</p>
                            <p class="text-xs font-mono text-slate-600" id="set-session-start">â€”</p>
                        </div>
                    </div>
                </div>

                <!-- Save Settings Bar -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span id="set-save-status" class="text-[11px] text-slate-400">Settings are saved automatically</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="set-reset-defaults" class="px-4 py-2 rounded-lg border border-slate-200 text-slate-600 text-xs font-semibold hover:bg-slate-50 transition-colors">Reset Defaults</button>
                        <button id="set-save-btn" class="px-5 py-2 rounded-lg bg-blue-600 text-white text-xs font-semibold hover:bg-blue-700 transition-colors shadow-sm">Save Settings</button>
                    </div>
                </div>

            </div><!-- /p-6 content -->
        </div><!-- /page-settings -->

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- â•â•â•â•â•â•â•â•â•â• PAGE: SUPPORT â€” Help & Documentation â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div id="page-support" class="page-section h-full overflow-y-auto">
            <!-- Support Hero -->
            <div class="bg-gradient-to-r from-emerald-800 via-teal-700 to-emerald-800 px-6 py-5">
                <div class="flex items-center gap-5">
                    <div class="w-12 h-12 rounded-xl bg-white/10 flex items-center justify-center">
                        <svg class="w-6 h-6 text-emerald-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M16.712 4.33a9.027 9.027 0 011.652 1.306c.51.51.944 1.064 1.306 1.652M16.712 4.33l-3.448 4.138m3.448-4.138a9.014 9.014 0 00-9.424 0M19.67 7.288l-4.138 3.448m4.138-3.448a9.014 9.014 0 010 9.424m-1.306 1.652a9.027 9.027 0 01-1.652 1.306m0 0l-3.448-4.138m3.448 4.138a9.014 9.014 0 01-9.424 0m-1.652-1.306a9.027 9.027 0 01-1.306-1.652m0 0l4.138-3.448M4.33 16.712a9.014 9.014 0 010-9.424m4.138 3.448a5.25 5.25 0 117.5 0 5.25 5.25 0 01-7.5 0z"/></svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-white tracking-tight">Support & Documentation</h2>
                        <p class="text-xs text-emerald-300/70 mt-0.5">Quick start guides, architecture reference, API docs, and troubleshooting</p>
                    </div>
                    <div class="ml-auto flex items-center gap-2">
                        <span id="sup-server-badge" class="px-2.5 py-1 rounded-full bg-emerald-500/20 text-emerald-300 text-[10px] font-semibold flex items-center gap-1.5">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 dot-blink"></span> System Online
                        </span>
                    </div>
                </div>
            </div>

            <div class="p-6 space-y-5">

                <!-- System Status Overview -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4 text-center">
                        <div class="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center mx-auto mb-2">
                            <svg class="w-5 h-5 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 14.25h13.5m-13.5 0a3 3 0 01-3-3m3 3a3 3 0 100 6h13.5a3 3 0 100-6m-16.5-3a3 3 0 013-3h13.5a3 3 0 013 3m-19.5 0a4.5 4.5 0 01.9-2.7L5.737 5.1a3.375 3.375 0 012.7-1.35h7.126c1.062 0 2.062.5 2.7 1.35l2.587 3.45a4.5 4.5 0 01.9 2.7m0 0a3 3 0 01-3 3m0 3h.008v.008h-.008v-.008zm0-6h.008v.008h-.008v-.008zm-3 6h.008v.008h-.008v-.008zm0-6h.008v.008h-.008v-.008z"/></svg>
                        </div>
                        <p class="text-[10px] text-slate-400 font-semibold uppercase">Fleet Server</p>
                        <p id="sup-fleet-status" class="text-sm font-bold text-emerald-600 mt-0.5">Online</p>
                        <p class="text-[9px] text-slate-400 mt-0.5">Port 8000</p>
                    </div>
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4 text-center">
                        <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center mx-auto mb-2">
                            <svg class="w-5 h-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/></svg>
                        </div>
                        <p class="text-[10px] text-slate-400 font-semibold uppercase">Driver Client</p>
                        <p id="sup-driver-status" class="text-sm font-bold text-blue-600 mt-0.5">Online</p>
                        <p class="text-[9px] text-slate-400 mt-0.5">Port 5000</p>
                    </div>
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4 text-center">
                        <div class="w-10 h-10 rounded-full bg-violet-50 flex items-center justify-center mx-auto mb-2">
                            <svg class="w-5 h-5 text-violet-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        </div>
                        <p class="text-[10px] text-slate-400 font-semibold uppercase">CV Pipeline</p>
                        <p id="sup-cv-status" class="text-sm font-bold text-violet-600 mt-0.5">Active</p>
                        <p class="text-[9px] text-slate-400 mt-0.5">MediaPipe + YOLOv8</p>
                    </div>
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-4 text-center">
                        <div class="w-10 h-10 rounded-full bg-amber-50 flex items-center justify-center mx-auto mb-2">
                            <svg class="w-5 h-5 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.288 15.038a5.25 5.25 0 017.424 0M5.106 11.856c3.807-3.808 9.98-3.808 13.788 0M1.924 8.674c5.565-5.565 14.587-5.565 20.152 0M12.53 18.22l-.53.53-.53-.53a.75.75 0 011.06 0z"/></svg>
                        </div>
                        <p class="text-[10px] text-slate-400 font-semibold uppercase">WebSocket</p>
                        <p id="sup-ws-status" class="text-sm font-bold text-amber-600 mt-0.5">Connected</p>
                        <p class="text-[9px] text-slate-400 mt-0.5">Real-time telemetry</p>
                    </div>
                </div>

                <!-- Architecture & Quick-Start Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                        <div class="w-9 h-9 rounded-lg bg-blue-50 flex items-center justify-center mb-3"><svg class="w-5 h-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/></svg></div>
                        <p class="text-sm font-semibold text-slate-700 mb-1">System Architecture</p>
                        <p class="text-[10px] text-slate-400 leading-relaxed">FastAPI Fleet Server (port 8000) + Flask Driver Client (port 5000). WebSocket real-time telemetry. OpenCV + MediaPipe CV pipeline for face detection, EAR, MAR, head pose estimation.</p>
                    </div>
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                        <div class="w-9 h-9 rounded-lg bg-emerald-50 flex items-center justify-center mb-3"><svg class="w-5 h-5 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 14.25h13.5m-13.5 0a3 3 0 01-3-3m3 3a3 3 0 100 6h13.5a3 3 0 100-6m-16.5-3a3 3 0 013-3h13.5a3 3 0 013 3m-19.5 0a4.5 4.5 0 01.9-2.7L5.737 5.1a3.375 3.375 0 012.7-1.35h7.126c1.062 0 2.062.5 2.7 1.35l2.587 3.45a4.5 4.5 0 01.9 2.7m0 0a3 3 0 01-3 3m0 3h.008v.008h-.008v-.008zm0-6h.008v.008h-.008v-.008zm-3 6h.008v.008h-.008v-.008zm0-6h.008v.008h-.008v-.008z"/></svg></div>
                        <p class="text-sm font-semibold text-slate-700 mb-1">IoT Sensors</p>
                        <p class="text-[10px] text-slate-400 leading-relaxed">ESP32 + MQ135 for CO&#8322; air quality monitoring. MPU6050 IMU for G-force and heading. Browser Geolocation API for GPS. All data streamed via WebSocket.</p>
                    </div>
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5">
                        <div class="w-9 h-9 rounded-lg bg-violet-50 flex items-center justify-center mb-3"><svg class="w-5 h-5 text-violet-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z"/></svg></div>
                        <p class="text-sm font-semibold text-slate-700 mb-1">Quick Start</p>
                        <p class="text-[10px] text-slate-400 leading-relaxed">1. Run <span class="font-mono bg-slate-100 px-1 rounded">run_all.bat</span> to start both servers. 2. Open <span class="font-mono bg-slate-100 px-1 rounded">http://localhost:8000</span> for fleet dashboard. 3. Allow camera + GPS permission when prompted.</p>
                    </div>
                </div>

                <!-- API Reference -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                    <div class="px-5 py-4 border-b border-slate-100 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center"><svg class="w-4 h-4 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5"/></svg></div>
                        <div>
                            <p class="text-sm font-semibold text-slate-700">API Reference</p>
                            <p class="text-[10px] text-slate-400">All available REST & WebSocket endpoints</p>
                        </div>
                    </div>
                    <div class="p-5">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="border-b border-slate-100">
                                        <th class="text-[10px] font-semibold text-slate-500 uppercase pb-2 pr-4">Method</th>
                                        <th class="text-[10px] font-semibold text-slate-500 uppercase pb-2 pr-4">Endpoint</th>
                                        <th class="text-[10px] font-semibold text-slate-500 uppercase pb-2">Description</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-50">
                                    <tr><td class="py-2 pr-4"><span class="px-1.5 py-0.5 rounded text-[9px] font-bold bg-emerald-50 text-emerald-600">GET</span></td><td class="py-2 pr-4 text-[11px] font-mono text-slate-600">/api/status</td><td class="py-2 text-[10px] text-slate-400">Server status, active vehicles, GPS, IMU, sensor data</td></tr>
                                    <tr><td class="py-2 pr-4"><span class="px-1.5 py-0.5 rounded text-[9px] font-bold bg-emerald-50 text-emerald-600">GET</span></td><td class="py-2 pr-4 text-[11px] font-mono text-slate-600">/api/gps</td><td class="py-2 text-[10px] text-slate-400">Latest GPS coordinates and speed</td></tr>
                                    <tr><td class="py-2 pr-4"><span class="px-1.5 py-0.5 rounded text-[9px] font-bold bg-emerald-50 text-emerald-600">GET</span></td><td class="py-2 pr-4 text-[11px] font-mono text-slate-600">/api/sensor</td><td class="py-2 text-[10px] text-slate-400">CO&#8322; and air quality sensor readings</td></tr>
                                    <tr><td class="py-2 pr-4"><span class="px-1.5 py-0.5 rounded text-[9px] font-bold bg-emerald-50 text-emerald-600">GET</span></td><td class="py-2 pr-4 text-[11px] font-mono text-slate-600">/api/safety/analytics</td><td class="py-2 text-[10px] text-slate-400">Safety reports â€” drowsiness, yawn, phone, seatbelt, fatigue score</td></tr>
                                    <tr><td class="py-2 pr-4"><span class="px-1.5 py-0.5 rounded text-[9px] font-bold bg-emerald-50 text-emerald-600">GET</span></td><td class="py-2 pr-4 text-[11px] font-mono text-slate-600">/api/fleet/analytics</td><td class="py-2 text-[10px] text-slate-400">Fleet analytics â€” IQ score, anomalies, heatmap, trends, AI insights</td></tr>
                                    <tr><td class="py-2 pr-4"><span class="px-1.5 py-0.5 rounded text-[9px] font-bold bg-blue-50 text-blue-600">POST</span></td><td class="py-2 pr-4 text-[11px] font-mono text-slate-600">/api/update</td><td class="py-2 text-[10px] text-slate-400">Receive telemetry updates from driver client</td></tr>
                                    <tr><td class="py-2 pr-4"><span class="px-1.5 py-0.5 rounded text-[9px] font-bold bg-violet-50 text-violet-600">WS</span></td><td class="py-2 pr-4 text-[11px] font-mono text-slate-600">/ws/dashboard</td><td class="py-2 text-[10px] text-slate-400">WebSocket â€” real-time dashboard telemetry stream</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tech Stack -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                    <div class="px-5 py-4 border-b border-slate-100 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-cyan-50 flex items-center justify-center"><svg class="w-4 h-4 text-cyan-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6.429 9.75L2.25 12l4.179 2.25m0-4.5l5.571 3 5.571-3m-11.142 0L2.25 7.5 12 2.25l9.75 5.25-4.179 2.25m0 0L12 12.75 6.429 9.75m11.142 0l4.179 2.25L12 17.25 2.25 12l4.179-2.25m11.142 0L12 12.75"/></svg></div>
                        <div>
                            <p class="text-sm font-semibold text-slate-700">Technology Stack</p>
                            <p class="text-[10px] text-slate-400">Libraries and frameworks powering ADAR</p>
                        </div>
                    </div>
                    <div class="p-5">
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                            <div class="text-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-[11px] font-bold text-slate-700">FastAPI</p>
                                <p class="text-[9px] text-slate-400">Fleet Server</p>
                            </div>
                            <div class="text-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-[11px] font-bold text-slate-700">Flask</p>
                                <p class="text-[9px] text-slate-400">Driver Client</p>
                            </div>
                            <div class="text-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-[11px] font-bold text-slate-700">OpenCV</p>
                                <p class="text-[9px] text-slate-400">Video Processing</p>
                            </div>
                            <div class="text-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-[11px] font-bold text-slate-700">MediaPipe</p>
                                <p class="text-[9px] text-slate-400">Face Landmarks</p>
                            </div>
                            <div class="text-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-[11px] font-bold text-slate-700">YOLOv8</p>
                                <p class="text-[9px] text-slate-400">Object Detection</p>
                            </div>
                            <div class="text-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-[11px] font-bold text-slate-700">Chart.js</p>
                                <p class="text-[9px] text-slate-400">Visualization</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 mt-3">
                            <div class="text-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-[11px] font-bold text-slate-700">TailwindCSS</p>
                                <p class="text-[9px] text-slate-400">Styling</p>
                            </div>
                            <div class="text-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-[11px] font-bold text-slate-700">Leaflet.js</p>
                                <p class="text-[9px] text-slate-400">Maps</p>
                            </div>
                            <div class="text-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-[11px] font-bold text-slate-700">WebSocket</p>
                                <p class="text-[9px] text-slate-400">Real-time Data</p>
                            </div>
                            <div class="text-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-[11px] font-bold text-slate-700">ESP32</p>
                                <p class="text-[9px] text-slate-400">IoT Hardware</p>
                            </div>
                            <div class="text-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-[11px] font-bold text-slate-700">MQ135</p>
                                <p class="text-[9px] text-slate-400">Air Quality</p>
                            </div>
                            <div class="text-center p-3 bg-slate-50 rounded-xl border border-slate-100">
                                <p class="text-[11px] font-bold text-slate-700">MPU6050</p>
                                <p class="text-[9px] text-slate-400">IMU / Gyroscope</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Troubleshooting FAQ -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                    <div class="px-5 py-4 border-b border-slate-100 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-amber-50 flex items-center justify-center"><svg class="w-4 h-4 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z"/></svg></div>
                        <div>
                            <p class="text-sm font-semibold text-slate-700">Troubleshooting</p>
                            <p class="text-[10px] text-slate-400">Common issues and solutions</p>
                        </div>
                    </div>
                    <div class="p-5 space-y-3">
                        <details class="group">
                            <summary class="flex items-center justify-between cursor-pointer p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors">
                                <span class="text-xs font-semibold text-slate-700">Camera not working / no video feed</span>
                                <svg class="w-4 h-4 text-slate-400 group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/></svg>
                            </summary>
                            <div class="mt-2 px-3 pb-2 text-[11px] text-slate-500 leading-relaxed">
                                <p>1. Ensure camera permissions are allowed in your browser.</p>
                                <p>2. Check that no other application (Zoom, Teams, etc.) is using the camera.</p>
                                <p>3. Try restarting the Driver Client: <span class="font-mono bg-slate-100 px-1 rounded">python main.py</span></p>
                                <p>4. Verify OpenCV is installed: <span class="font-mono bg-slate-100 px-1 rounded">pip install opencv-python</span></p>
                            </div>
                        </details>
                        <details class="group">
                            <summary class="flex items-center justify-between cursor-pointer p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors">
                                <span class="text-xs font-semibold text-slate-700">WebSocket disconnects frequently</span>
                                <svg class="w-4 h-4 text-slate-400 group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/></svg>
                            </summary>
                            <div class="mt-2 px-3 pb-2 text-[11px] text-slate-500 leading-relaxed">
                                <p>1. Check that the Fleet Server is running on port 8000.</p>
                                <p>2. Verify no firewall is blocking WebSocket connections.</p>
                                <p>3. Try refreshing the dashboard page â€” auto-reconnect is built in.</p>
                                <p>4. If using a proxy or VPN, ensure WebSocket upgrade headers are allowed.</p>
                            </div>
                        </details>
                        <details class="group">
                            <summary class="flex items-center justify-between cursor-pointer p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors">
                                <span class="text-xs font-semibold text-slate-700">GPS location shows wrong coordinates</span>
                                <svg class="w-4 h-4 text-slate-400 group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/></svg>
                            </summary>
                            <div class="mt-2 px-3 pb-2 text-[11px] text-slate-500 leading-relaxed">
                                <p>1. Browser Geolocation API uses WiFi/cell towers when GPS hardware is unavailable â€” accuracy varies.</p>
                                <p>2. Ensure location permissions are set to "Allow" (not "Ask").</p>
                                <p>3. For higher accuracy, use the system on a device with a real GPS receiver.</p>
                                <p>4. The simulation mode generates random coordinates for testing purposes.</p>
                            </div>
                        </details>
                        <details class="group">
                            <summary class="flex items-center justify-between cursor-pointer p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors">
                                <span class="text-xs font-semibold text-slate-700">CO&#8322; sensor shows "Waiting for data"</span>
                                <svg class="w-4 h-4 text-slate-400 group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/></svg>
                            </summary>
                            <div class="mt-2 px-3 pb-2 text-[11px] text-slate-500 leading-relaxed">
                                <p>1. Make sure the ESP32 is powered and connected to WiFi.</p>
                                <p>2. Verify the ESP32 firmware is flashed with <span class="font-mono bg-slate-100 px-1 rounded">mq135_sender.ino</span>.</p>
                                <p>3. Check that the ESP32 is sending data to the correct server IP.</p>
                                <p>4. MQ135 sensors need 24-48 hours of burn-in time for stable readings.</p>
                            </div>
                        </details>
                        <details class="group">
                            <summary class="flex items-center justify-between cursor-pointer p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors">
                                <span class="text-xs font-semibold text-slate-700">Face detection not detecting properly</span>
                                <svg class="w-4 h-4 text-slate-400 group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/></svg>
                            </summary>
                            <div class="mt-2 px-3 pb-2 text-[11px] text-slate-500 leading-relaxed">
                                <p>1. Ensure adequate lighting â€” MediaPipe performs poorly in very dark conditions.</p>
                                <p>2. Position your face directly in front of the camera, within 30-80 cm distance.</p>
                                <p>3. Avoid wearing reflective sunglasses which obscure eye landmarks.</p>
                                <p>4. Verify <span class="font-mono bg-slate-100 px-1 rounded">face_landmarker.task</span> model file exists in the project root.</p>
                            </div>
                        </details>
                        <details class="group">
                            <summary class="flex items-center justify-between cursor-pointer p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors">
                                <span class="text-xs font-semibold text-slate-700">Server won't start / port already in use</span>
                                <svg class="w-4 h-4 text-slate-400 group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"/></svg>
                            </summary>
                            <div class="mt-2 px-3 pb-2 text-[11px] text-slate-500 leading-relaxed">
                                <p>1. Kill existing Python processes: <span class="font-mono bg-slate-100 px-1 rounded">taskkill /F /IM python.exe</span></p>
                                <p>2. Check if the port is in use: <span class="font-mono bg-slate-100 px-1 rounded">netstat -ano | findstr :8000</span></p>
                                <p>3. Change the port in server.py if needed.</p>
                                <p>4. Ensure all dependencies are installed: <span class="font-mono bg-slate-100 px-1 rounded">pip install -r requirements.txt</span></p>
                            </div>
                        </details>
                    </div>
                </div>

                <!-- Keyboard Shortcuts -->
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm">
                    <div class="px-5 py-4 border-b border-slate-100 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center"><svg class="w-4 h-4 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 7.5l3 2.25-3 2.25m4.5 0h3m-9 8.25h13.5A2.25 2.25 0 0021 18V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v12a2.25 2.25 0 002.25 2.25z"/></svg></div>
                        <div>
                            <p class="text-sm font-semibold text-slate-700">Keyboard Shortcuts</p>
                            <p class="text-[10px] text-slate-400">Quick navigation with keystrokes</p>
                        </div>
                    </div>
                    <div class="p-5">
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                            <div class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg"><kbd class="px-2 py-1 rounded bg-white text-[10px] font-mono font-bold text-slate-600 border border-slate-200 shadow-sm">1</kbd><span class="text-[11px] text-slate-500">Dashboard</span></div>
                            <div class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg"><kbd class="px-2 py-1 rounded bg-white text-[10px] font-mono font-bold text-slate-600 border border-slate-200 shadow-sm">2</kbd><span class="text-[11px] text-slate-500">Tracking</span></div>
                            <div class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg"><kbd class="px-2 py-1 rounded bg-white text-[10px] font-mono font-bold text-slate-600 border border-slate-200 shadow-sm">3</kbd><span class="text-[11px] text-slate-500">Safety</span></div>
                            <div class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg"><kbd class="px-2 py-1 rounded bg-white text-[10px] font-mono font-bold text-slate-600 border border-slate-200 shadow-sm">4</kbd><span class="text-[11px] text-slate-500">Analytics</span></div>
                            <div class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg"><kbd class="px-2 py-1 rounded bg-white text-[10px] font-mono font-bold text-slate-600 border border-slate-200 shadow-sm">5</kbd><span class="text-[11px] text-slate-500">Settings</span></div>
                            <div class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg"><kbd class="px-2 py-1 rounded bg-white text-[10px] font-mono font-bold text-slate-600 border border-slate-200 shadow-sm">6</kbd><span class="text-[11px] text-slate-500">Support</span></div>
                        </div>
                    </div>
                </div>

                <!-- Version & Contact -->
                <div class="bg-gradient-to-br from-slate-50 to-emerald-50 rounded-xl border border-slate-200 shadow-sm p-5">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-600 to-teal-600 flex items-center justify-center shadow-md flex-shrink-0">
                            <span class="text-white font-extrabold text-sm">A</span>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-bold text-slate-800">ADAR â€” Advanced Driver Attention & Response</p>
                            <p class="text-[11px] text-slate-500 mt-0.5">Version 3.0.0 &bull; Fleet Command Center &bull; &copy; 2026</p>
                            <p class="text-[10px] text-slate-400 mt-1">Built with Python, FastAPI, OpenCV, MediaPipe, YOLOv8, ESP32, Chart.js, and TailwindCSS.</p>
                        </div>
                        <div class="flex-shrink-0 flex items-center gap-2">
                            <a href="https://github.com" target="_blank" class="w-8 h-8 rounded-lg bg-white border border-slate-200 flex items-center justify-center hover:bg-slate-50 transition-colors">
                                <svg class="w-4 h-4 text-slate-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                            </a>
                        </div>
                    </div>
                </div>

            </div><!-- /p-6 content -->
        </div><!-- /page-support -->

        </main>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SOS BUTTON â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <button id="sos-btn" class="sos-btn fixed bottom-6 right-6 z-50 w-14 h-14 rounded-full bg-red-500 hover:bg-red-600 text-white flex items-center justify-center shadow-lg transition-colors" title="Emergency SOS">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/>
        </svg>
    </button>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• JAVASCRIPT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <script>
    (function () {
        'use strict';

        lucide.createIcons();

        const $ = id => document.getElementById(id);
        const DOM = {
            wsDot: $('ws-dot'), wsLabel: $('ws-label'),
            simBadge: $('sim-badge'), clock: $('clock'), subtitle: $('subtitle'),
            sensorBadge: $('sensor-badge'), sensorBadgeIcon: $('sensor-badge-icon'), sensorBadgeText: $('sensor-badge-text'),
            cvBadge: $('cv-badge'), cvBadgeIcon: $('cv-badge-icon'), cvBadgeText: $('cv-badge-text'),
            safetyCard: $('safety-card'), dotFace: $('dot-face'), faceLabel: $('face-label'), affectiveLabel: $('affective-label'),
            dotCv: $('dot-cv'),
            gpsBadge: $('gps-badge'), gpsBadgeIcon: $('gps-badge-icon'), gpsBadgeText: $('gps-badge-text'),
            gpsSourceDot: $('gps-source-dot'), gpsSourceLabel: $('gps-source-label'),
            gpsAccuracyLabel: $('gps-accuracy-label'), gpsSourceTag: $('gps-source-tag'),
            mapAccuracy: $('map-accuracy'),
            statVehicles: $('stat-vehicles'), vehicleBadge: $('vehicle-badge'), vehicleIdLabel: $('vehicle-id-label'),
            statSafety: $('stat-safety'),
            statSpeed: $('stat-speed'), statMaxSpeed: $('stat-max-speed'),
            statCo2: $('stat-co2'), co2Bar: $('co2-bar'), co2IconBg: $('co2-icon-bg'),
            statDistance: $('stat-distance'), statAltitude: $('stat-altitude'),
            statSys: $('stat-sys'), sysIconBg: $('sys-icon-bg'),
            dotSensor: $('dot-sensor'), dotGps: $('dot-gps'),
            mapLat: $('map-lat'), mapLon: $('map-lon'), mapSpeed: $('map-speed'),
            // Speedometer overlay
            speedoArc: $('speedo-arc'), speedoValue: $('speedo-value'), speedoMax: $('speedo-max'),
            speedoAvg: $('speedo-avg'), speedSourceLabel: $('speed-source-label'),
            gforceVal: $('gforce-val'), gforceDot: $('gforce-dot'),
            // Trip overlay
            tripDistOverlay: $('trip-distance-overlay'), tripDurOverlay: $('trip-duration-overlay'), tripAltOverlay: $('trip-alt-overlay'),
            // Footer
            footerGpsDot: $('footer-gps-dot'), footerGpsStatus: $('footer-gps-status'),
            footerImuDot: $('footer-imu-dot'), footerImuStatus: $('footer-imu-status'),
            footerTrailPts: $('footer-trail-pts'), footerTimestamp: $('footer-timestamp'),
            imuTag: $('imu-tag'), trackingDot: $('tracking-dot'),
            alertFeed: $('alert-feed'), alertCount: $('alert-count'),
            earLive: $('ear-live'), earDot: $('ear-dot'),
            marLive: $('mar-live'), marDot: $('mar-dot'),
            co2Live: $('co2-live'), co2Dot: $('co2-dot'),
            speedLive: $('speed-live'),
            compassDialGroup: document.getElementById('compass-dial-group'), headingValue: $('heading-value'), headingCardinal: $('heading-cardinal'),
            sosBtn: $('sos-btn'), uptimeLabel: $('uptime-label'),
        };

        // â”€â”€ State â”€â”€
        let safetyScore = 98;
        let alertTotal = 0;
        let ws = null;
        let firstAlert = true;
        let vehicleId = 'â€”';
        let _drowsyActive = false;
        let _drowsyStart = 0;
        let _lastDrowsyAlertTime = 0;
        // Real alert counters (fetched from server API)
        let _realAlertCounts = { total: 0, drowsiness: 0, yawning: 0, distraction: 0, phone: 0, looking_away: 0 };
        let maxSpeed = 0;
        let tripDistanceKm = 0;
        let lastGpsLat = null, lastGpsLon = null;
        const startTime = Date.now();

        // â”€â”€ Clock + Uptime â”€â”€
        setInterval(() => {
            DOM.clock.textContent = new Date().toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const h = String(Math.floor(elapsed / 3600)).padStart(2, '0');
            const m = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0');
            const s = String(elapsed % 60).padStart(2, '0');
            DOM.uptimeLabel.textContent = `${h}:${m}:${s}`;
        }, 1000);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  REAL GPS (navigator.geolocation)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let gpsActive = false;
        let gpsWatchId = null;

        function initGPS() {
            if (!navigator.geolocation) {
                setGpsStatus('unavailable', 'Browser GPS not supported');
                return;
            }
            setGpsStatus('acquiring', 'Acquiring GPSâ€¦');

            gpsWatchId = navigator.geolocation.watchPosition(
                (pos) => {
                    gpsActive = true;
                    const { latitude, longitude, accuracy, altitude, heading, speed } = pos.coords;
                    setGpsStatus('active', `Accuracy: Â±${accuracy ? accuracy.toFixed(0) : '?'}m`);

                    // Send GPS to server via WebSocket
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'GPS',
                            lat: latitude,
                            lon: longitude,
                            accuracy: accuracy,
                            altitude: altitude,
                            heading: heading,
                            speed_mps: speed,
                        }));
                    }

                    DOM.gpsAccuracyLabel.textContent = `Â±${accuracy ? accuracy.toFixed(0) : '?'}m  |  Alt: ${altitude ? altitude.toFixed(0) : 'â€”'}m`;
                    DOM.mapAccuracy.textContent = accuracy ? accuracy.toFixed(0) : 'â€”';

                    // Update accuracy circle on map
                    updateAccuracyCircle(latitude, longitude, accuracy);
                },
                (err) => {
                    gpsActive = false;
                    const msgs = {
                        1: 'GPS Permission Denied',
                        2: 'GPS Position Unavailable',
                        3: 'GPS Timeout',
                    };
                    setGpsStatus('error', msgs[err.code] || 'GPS Error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0,
                }
            );
        }

        function setGpsStatus(state, text) {
            const colors = {
                active:    { dot: 'bg-emerald-500', badge: 'bg-emerald-50 text-emerald-600 border-emerald-200', icon: 'ðŸ›°ï¸', tag: 'LIVE GPS' },
                acquiring: { dot: 'bg-amber-500',   badge: 'bg-amber-50 text-amber-600 border-amber-200',     icon: 'ðŸ“¡', tag: 'ACQUIRING' },
                error:     { dot: 'bg-red-500',     badge: 'bg-red-50 text-red-600 border-red-200',           icon: 'âš ï¸', tag: 'GPS ERROR' },
                unavailable: { dot: 'bg-slate-500', badge: 'bg-slate-50 text-slate-600 border-slate-200',     icon: 'âŒ', tag: 'NO GPS' },
            };
            const c = colors[state] || colors.acquiring;
            DOM.gpsSourceDot.className = `w-2 h-2 rounded-full ${c.dot} dot-blink`;
            DOM.gpsSourceLabel.textContent = text;
            DOM.gpsBadge.className = `px-2.5 py-1 rounded-full text-[10px] font-semibold border ${c.badge}`;
            DOM.gpsBadgeIcon.textContent = c.icon;
            DOM.gpsBadgeText.textContent = text;
            DOM.gpsSourceTag.textContent = c.tag;
            DOM.gpsSourceTag.className = `px-2 py-0.5 rounded-full text-[9px] font-semibold ${c.badge}`;
            // GPS dot in system status
            if (state === 'active') {
                DOM.dotGps.className = 'w-1.5 h-1.5 rounded-full bg-emerald-500';
            } else if (state === 'error') {
                DOM.dotGps.className = 'w-1.5 h-1.5 rounded-full bg-red-500';
            } else {
                DOM.dotGps.className = 'w-1.5 h-1.5 rounded-full bg-amber-500';
            }
        }

        // Start GPS immediately
        initGPS();

        // "Enable GPS" button on map overlay
        const gpsOverlay = $('gps-overlay');
        const enableGpsBtn = $('enable-gps-btn');
        enableGpsBtn.addEventListener('click', () => {
            // Stop old watcher if any
            if (gpsWatchId !== null) navigator.geolocation.clearWatch(gpsWatchId);
            gpsWatchId = null;
            gpsActive = false;
            setGpsStatus('acquiring', 'Requesting GPSâ€¦');
            initGPS();
        });
        // Hide overlay when GPS becomes active
        function checkOverlay() {
            if (gpsActive) gpsOverlay.style.display = 'none';
        }
        setInterval(checkOverlay, 500);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  MAP (Leaflet)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const map = L.map('map', { center: [20, 78], zoom: 5, zoomControl: false });
        // Use streetLayer from map controls section (added below)
        // Initial layer added here, swapped by satellite toggle
        const _initTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19, attribution: '&copy; OpenStreetMap'
        }).addTo(map);
        // Add zoom control to bottom-left
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // Professional vehicle marker â€” pulsing blue dot with direction arrow
        const carIcon = L.divIcon({
            className: '',
            html: `<div style="position:relative; width:40px; height:40px;">
                <div style="position:absolute; inset:0; border-radius:50%; background:rgba(59,130,246,0.15); animation:accuracyPulse 2s ease-in-out infinite;"></div>
                <div style="position:absolute; top:8px; left:8px; width:24px; height:24px; border-radius:50%; background:#1e40af; border:3px solid #fff; box-shadow:0 2px 8px rgba(30,64,175,0.4); display:flex; align-items:center; justify-content:center;">
                    <svg style="width:12px; height:12px; color:#fff; transform:rotate(0deg);" id="car-direction-arrow" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l-5 10h3v10h4V12h3z"/></svg>
                </div>
            </div>`,
            iconSize: [40, 40], iconAnchor: [20, 20],
        });
        // DON'T add car marker to map yet â€” only show when real GPS arrives
        const carMarker = L.marker([20, 78], { icon: carIcon }); // NOT added to map
        let markerOnMap = false;

        // Trail polyline
        const trail = L.polyline([], { color: '#3b82f6', weight: 3, opacity: 0.6, dashArray: '8,6' }).addTo(map);
        const trailPts = [];
        let mapCentered = false;

        // Accuracy circle
        let accuracyCircle = null;
        function updateAccuracyCircle(lat, lon, accuracy) {
            if (!accuracy) return;
            if (accuracyCircle) {
                accuracyCircle.setLatLng([lat, lon]);
                accuracyCircle.setRadius(accuracy);
            } else {
                accuracyCircle = L.circle([lat, lon], {
                    radius: accuracy, color: '#3b82f6', fillColor: '#3b82f6',
                    fillOpacity: 0.1, weight: 1, opacity: 0.3,
                    className: 'accuracy-ring',
                }).addTo(map);
            }
        }

        function updateMap(lat, lon) {
            if (lat == null || lon == null) return; // Skip if no real GPS
            const ll = [lat, lon];

            // Add marker to map on first real GPS fix
            if (!markerOnMap) {
                carMarker.addTo(map);
                markerOnMap = true;
            }

            carMarker.setLatLng(ll);
            trailPts.push(ll);
            if (trailPts.length > 500) trailPts.shift();
            trail.setLatLngs(trailPts);

            // Center map: zoom in first time, then smooth pan
            if (!mapCentered) {
                map.setView(ll, 16, { animate: true });
                mapCentered = true;
            } else {
                map.panTo(ll, { animate: true, duration: 0.4 });
            }
            DOM.mapLat.textContent = lat.toFixed(5);
            DOM.mapLon.textContent = lon.toFixed(5);

            // Trip distance (Haversine)
            if (lastGpsLat !== null && lastGpsLon !== null) {
                const segDist = haversine(lastGpsLat, lastGpsLon, lat, lon);
                if (segDist < 0.5) { // Ignore GPS jumps > 500m
                    tripDistanceKm += segDist;
                    DOM.statDistance.textContent = tripDistanceKm.toFixed(2);
                    if (DOM.tripDistOverlay) DOM.tripDistOverlay.textContent = tripDistanceKm.toFixed(2) + ' km';
                }
            }
            lastGpsLat = lat;
            lastGpsLon = lon;
            // Update footer trail count
            if (DOM.footerTrailPts) DOM.footerTrailPts.textContent = trailPts.length;
        }

        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        setTimeout(() => map.invalidateSize(), 300);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  SPEEDOMETER GAUGE + IMU
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const SPEEDO_ARC_LENGTH = 220;  // total dasharray length of the SVG arc
        const SPEEDO_MAX_KMH = 160;     // max scale
        let _speedSamples = [];          // for average calculation
        let _imuConnected = false;

        function updateSpeedometer(speedKmh, source) {
            const s = Math.max(0, Math.min(speedKmh, SPEEDO_MAX_KMH));
            // Update arc
            const offset = SPEEDO_ARC_LENGTH - (s / SPEEDO_MAX_KMH) * SPEEDO_ARC_LENGTH;
            if (DOM.speedoArc) DOM.speedoArc.setAttribute('stroke-dashoffset', offset);
            // Color: blue<60, amber<100, red>=100
            if (DOM.speedoArc) {
                DOM.speedoArc.setAttribute('stroke', s < 60 ? '#3b82f6' : s < 100 ? '#f59e0b' : '#ef4444');
            }
            if (DOM.speedoValue) DOM.speedoValue.textContent = Math.round(s);
            if (DOM.speedSourceLabel) DOM.speedSourceLabel.textContent = (source || 'GPS').toUpperCase();
            // Track max
            if (s > maxSpeed) {
                maxSpeed = s;
                DOM.statMaxSpeed.textContent = maxSpeed.toFixed(0);
                if (DOM.speedoMax) DOM.speedoMax.textContent = maxSpeed.toFixed(0);
            }
            // Avg speed
            if (s > 0) _speedSamples.push(s);
            if (_speedSamples.length > 500) _speedSamples.shift();
            if (_speedSamples.length > 0 && DOM.speedoAvg) {
                const avg = _speedSamples.reduce((a, b) => a + b, 0) / _speedSamples.length;
                DOM.speedoAvg.textContent = avg.toFixed(0);
            }
        }

        function updateGForce(gForce) {
            if (!DOM.gforceVal) return;
            DOM.gforceVal.textContent = gForce.toFixed(2);
            // Color: green < 1.5, amber < 2.5, red >= 2.5
            const color = gForce < 1.5 ? '#3b82f6' : gForce < 2.5 ? '#f59e0b' : '#ef4444';
            if (DOM.gforceDot) DOM.gforceDot.style.background = color;
        }

        function updateIMUStatus(hasIMU) {
            _imuConnected = hasIMU;
            if (DOM.imuTag) {
                DOM.imuTag.classList.toggle('hidden', !hasIMU);
                if (hasIMU) {
                    DOM.imuTag.className = 'px-2 py-0.5 rounded-full text-[8px] font-semibold bg-teal-50 text-teal-600';
                    DOM.imuTag.textContent = 'âš¡ MPU6050';
                }
            }
            if (DOM.footerImuDot) DOM.footerImuDot.style.background = hasIMU ? '#10b981' : '#94a3b8';
            if (DOM.footerImuStatus) DOM.footerImuStatus.textContent = hasIMU ? 'Live' : 'No Sensor';
        }

        // Trip duration timer (updates overlay every second)
        let _tripStartTime = Date.now();
        setInterval(() => {
            const elapsed = Math.floor((Date.now() - _tripStartTime) / 1000);
            const hh = Math.floor(elapsed / 3600);
            const mm = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0');
            const ss = String(elapsed % 60).padStart(2, '0');
            const text = hh > 0 ? `${hh}:${mm}:${ss}` : `${mm}:${ss}`;
            if (DOM.tripDurOverlay) DOM.tripDurOverlay.textContent = text;
        }, 1000);

        // â”€â”€ Map Controls â”€â”€
        let _trailVisible = true;
        let _useSatellite = false;
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19, attribution: '&copy; Esri'
        });

        // Center on vehicle
        const btnCenter = $('btn-center-vehicle');
        if (btnCenter) btnCenter.addEventListener('click', () => {
            if (lastGpsLat != null && lastGpsLon != null) {
                map.setView([lastGpsLat, lastGpsLon], 17, { animate: true });
            }
        });

        // Toggle trail
        const btnTrail = $('btn-toggle-trail');
        if (btnTrail) btnTrail.addEventListener('click', () => {
            _trailVisible = !_trailVisible;
            if (_trailVisible) {
                trail.addTo(map);
                btnTrail.querySelector('svg').style.opacity = '1';
            } else {
                trail.remove();
                btnTrail.querySelector('svg').style.opacity = '0.3';
            }
        });

        // Toggle satellite/street
        const btnSat = $('btn-toggle-satellite');
        if (btnSat) btnSat.addEventListener('click', () => {
            _useSatellite = !_useSatellite;
            if (_useSatellite) {
                map.removeLayer(_initTileLayer);
                satelliteLayer.addTo(map);
                btnSat.classList.add('bg-blue-100');
            } else {
                map.removeLayer(satelliteLayer);
                _initTileLayer.addTo(map);
                btnSat.classList.remove('bg-blue-100');
            }
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  COMPASS â€” Phone-style with smoothing
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let _gpsHeading = null;       // from GPS when moving
        let _cvYaw = null;            // from CV pipeline head pose
        let _headingSource = 'none';  // 'device', 'sensor', 'gyro', 'gps', 'cv'

        // â”€â”€ Smoothing & animation state â”€â”€
        let _targetHeading = 0;       // where we want to go (degrees)
        let _displayHeading = 0;      // currently rendered angle (degrees)
        let _animating = false;
        const SMOOTH_FACTOR = 0.12;   // exponential smoothing (0=frozen, 1=instant)
        const SNAP_THRESHOLD = 0.3;   // degrees - stop animating below this delta

        // Generate SVG tick marks (every 5Â°, bold every 30Â°)
        (function buildTicks() {
            const g = document.getElementById('compass-ticks');
            if (!g) return;
            for (let deg = 0; deg < 360; deg += 5) {
                const isMajor = deg % 30 === 0;
                const isCardinal = deg % 90 === 0;
                if (isCardinal) continue; // skip N/E/S/W â€” we have text labels
                const inner = isMajor ? 68 : 74;
                const outer = 80;
                const rad = deg * Math.PI / 180;
                const x1 = 100 + inner * Math.sin(rad);
                const y1 = 100 - inner * Math.cos(rad);
                const x2 = 100 + outer * Math.sin(rad);
                const y2 = 100 - outer * Math.cos(rad);
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x1); line.setAttribute('y1', y1);
                line.setAttribute('x2', x2); line.setAttribute('y2', y2);
                line.setAttribute('stroke', isMajor ? '#64748b' : '#cbd5e1');
                line.setAttribute('stroke-width', isMajor ? '1.5' : '0.8');
                g.appendChild(line);
                // Degree number labels at every 30Â°
                if (isMajor) {
                    const labelR = 62;
                    const lx = 100 + labelR * Math.sin(rad);
                    const ly = 100 - labelR * Math.cos(rad);
                    const txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    txt.setAttribute('x', lx); txt.setAttribute('y', ly + 3);
                    txt.setAttribute('text-anchor', 'middle');
                    txt.setAttribute('font-size', '8'); txt.setAttribute('font-weight', '500');
                    txt.setAttribute('fill', '#94a3b8');
                    txt.textContent = deg.toString();
                    g.appendChild(txt);
                }
            }
        })();

        // Shortest-path angular difference (-180 to +180)
        function angleDiff(from, to) {
            let d = ((to - from) % 360 + 540) % 360 - 180;
            return d;
        }

        // Smooth animation loop (requestAnimationFrame)
        function compassAnimLoop() {
            const diff = angleDiff(_displayHeading, _targetHeading);
            if (Math.abs(diff) < SNAP_THRESHOLD) {
                _displayHeading = _targetHeading;
                renderCompass(_displayHeading);
                _animating = false;
                return;
            }
            _displayHeading = ((_displayHeading + diff * SMOOTH_FACTOR) % 360 + 360) % 360;
            renderCompass(_displayHeading);
            requestAnimationFrame(compassAnimLoop);
        }

        function renderCompass(h) {
            // Rotate the DIAL opposite to heading so N label points to true north
            const dialGroup = document.getElementById('compass-dial-group');
            if (dialGroup) dialGroup.setAttribute('transform', `rotate(${-h}, 100, 100)`);

            // Update text readouts
            const hRound = Math.round(h);
            DOM.headingValue.textContent = hRound + 'Â°';
            const dirs16 = ['N','NNE','NE','ENE','E','ESE','SE','SSE',
                            'S','SSW','SW','WSW','W','WNW','NW','NNW'];
            DOM.headingCardinal.textContent = dirs16[Math.round(h / 22.5) % 16];
        }

        function setCompassTarget(heading, source) {
            if (heading == null || isNaN(heading)) return;
            _targetHeading = ((heading % 360) + 360) % 360;

            // Update source tag
            const tag = $('heading-source-tag');
            if (source === 'device') {
                tag.textContent = 'ðŸ§­ COMPASS';
                tag.className = 'px-2 py-0.5 rounded-full text-[8px] font-semibold bg-emerald-50 text-emerald-600';
            } else if (source === 'sensor') {
                tag.textContent = 'ðŸ”„ IMU SENSOR';
                tag.className = 'px-2 py-0.5 rounded-full text-[8px] font-semibold bg-teal-50 text-teal-600';
            } else if (source === 'gyro') {
                tag.textContent = 'ðŸ”ƒ GYROSCOPE';
                tag.className = 'px-2 py-0.5 rounded-full text-[8px] font-semibold bg-cyan-50 text-cyan-600';
            } else if (source === 'gps') {
                tag.textContent = 'ðŸ›°ï¸ GPS';
                tag.className = 'px-2 py-0.5 rounded-full text-[8px] font-semibold bg-blue-50 text-blue-600';
            } else if (source === 'cv') {
                tag.textContent = 'ðŸŽ¥ HEAD POSE';
                tag.className = 'px-2 py-0.5 rounded-full text-[8px] font-semibold bg-violet-50 text-violet-600';
            }

            if (!_animating) {
                _animating = true;
                requestAnimationFrame(compassAnimLoop);
            }
        }

        // Resolve best heading: absolute compass > sensor > relative gyro > GPS > CV head yaw
        function resolveBestHeading() {
            if (_absoluteHeading != null)  { setCompassTarget(_absoluteHeading, 'device');   _headingSource = 'device'; }
            else if (_sensorHeading != null){ setCompassTarget(_sensorHeading, 'sensor');    _headingSource = 'sensor'; }
            else if (_relativeHeading != null){ setCompassTarget(_relativeHeading, 'gyro');  _headingSource = 'gyro'; }
            else if (_gpsHeading != null)  { setCompassTarget(_gpsHeading, 'gps');           _headingSource = 'gps'; }
            else if (_cvYaw != null)       { setCompassTarget(_cvYaw, 'cv');                 _headingSource = 'cv'; }
        }

        // â”€â”€ Device Orientation API â”€â”€
        let _deviceOrientationSamples = [];  // rolling buffer for absolute compass
        let _relativeOrientationSamples = []; // rolling buffer for relative gyro
        const ORIENTATION_BUFFER_SIZE = 5;
        let _absoluteHeading = null;         // true north from magnetometer
        let _relativeHeading = null;         // gyro-based (no true north, but tracks rotation)
        let _sensorHeading = null;           // from Generic Sensor API
        let _relativeBaseAlpha = null;       // first alpha reading used as "zero" reference
        let _hasAbsoluteSource = false;      // true if we ever got absolute readings

        function initDeviceOrientation() {
            // iOS 13+ requires permission request
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(state => {
                    if (state === 'granted') window.addEventListener('deviceorientation', onDeviceOrientation, true);
                }).catch(() => {});
            } else if ('DeviceOrientationEvent' in window) {
                window.addEventListener('deviceorientation', onDeviceOrientation, true);
            }
            // Absolute variant (true compass on devices with magnetometer)
            if ('ondeviceorientationabsolute' in window) {
                window.addEventListener('deviceorientationabsolute', onDeviceOrientationAbsolute, true);
            }
            // â”€â”€ Generic Sensor API (modern laptops/tablets with IMU) â”€â”€
            initGenericSensors();
        }

        // Circular mean of angles (handles 0Â°/360Â° wraparound correctly)
        function circularMean(angles) {
            let sinSum = 0, cosSum = 0;
            for (const a of angles) {
                const rad = a * Math.PI / 180;
                sinSum += Math.sin(rad);
                cosSum += Math.cos(rad);
            }
            let mean = Math.atan2(sinSum / angles.length, cosSum / angles.length) * 180 / Math.PI;
            return ((mean % 360) + 360) % 360;
        }

        function pushAbsoluteSample(heading) {
            _deviceOrientationSamples.push(heading);
            if (_deviceOrientationSamples.length > ORIENTATION_BUFFER_SIZE)
                _deviceOrientationSamples.shift();
            _absoluteHeading = circularMean(_deviceOrientationSamples);
            _hasAbsoluteSource = true;
            resolveBestHeading();
        }

        function pushRelativeSample(heading) {
            _relativeOrientationSamples.push(heading);
            if (_relativeOrientationSamples.length > ORIENTATION_BUFFER_SIZE)
                _relativeOrientationSamples.shift();
            _relativeHeading = circularMean(_relativeOrientationSamples);
            resolveBestHeading();
        }

        function onDeviceOrientation(e) {
            // webkitCompassHeading = Safari/iOS true north
            if (e.webkitCompassHeading != null) {
                pushAbsoluteSample(e.webkitCompassHeading);
                return;
            }
            // Absolute orientation (magnetometer present) â†’ true compass
            if (e.alpha != null && e.absolute) {
                pushAbsoluteSample((360 - e.alpha) % 360);
                return;
            }
            // â”€â”€ Relative orientation (gyro/accelerometer, NO magnetometer) â”€â”€
            // This is the LAPTOP case: alpha changes when the device rotates
            // but has no true north reference. We use the first reading as 0Â°.
            if (e.alpha != null && !_hasAbsoluteSource) {
                if (_relativeBaseAlpha === null) _relativeBaseAlpha = e.alpha;
                // Delta from initial position, inverted to match compass convention
                let heading = (360 - (e.alpha - _relativeBaseAlpha)) % 360;
                heading = ((heading % 360) + 360) % 360;
                pushRelativeSample(heading);
            }
        }

        function onDeviceOrientationAbsolute(e) {
            if (e.alpha != null) {
                pushAbsoluteSample((360 - e.alpha) % 360);
            }
        }

        // â”€â”€ Generic Sensor API (AbsoluteOrientationSensor / RelativeOrientationSensor) â”€â”€
        // Works on many modern laptops with IMU chips (Surface, ThinkPad, etc.)
        function initGenericSensors() {
            // Try AbsoluteOrientationSensor first (has magnetometer = true north)
            if ('AbsoluteOrientationSensor' in window) {
                try {
                    const sensor = new AbsoluteOrientationSensor({ frequency: 30, referenceFrame: 'device' });
                    sensor.addEventListener('reading', () => {
                        const q = sensor.quaternion; // [x, y, z, w]
                        if (q) {
                            const heading = quaternionToHeading(q[0], q[1], q[2], q[3]);
                            _sensorHeading = heading;
                            resolveBestHeading();
                        }
                    });
                    sensor.addEventListener('error', (e) => {
                        console.log('[Compass] AbsoluteOrientationSensor error:', e.error.name);
                        tryRelativeSensor(); // fallback
                    });
                    sensor.start();
                    console.log('[Compass] AbsoluteOrientationSensor started');
                    return; // success â€” don't try relative
                } catch (err) {
                    console.log('[Compass] AbsoluteOrientationSensor unavailable:', err.message);
                }
            }
            tryRelativeSensor();
        }

        function tryRelativeSensor() {
            if ('RelativeOrientationSensor' in window) {
                try {
                    const sensor = new RelativeOrientationSensor({ frequency: 30, referenceFrame: 'device' });
                    let baseHeading = null;
                    sensor.addEventListener('reading', () => {
                        const q = sensor.quaternion;
                        if (q) {
                            let heading = quaternionToHeading(q[0], q[1], q[2], q[3]);
                            if (baseHeading === null) baseHeading = heading;
                            heading = ((heading - baseHeading) + 360) % 360;
                            if (!_hasAbsoluteSource) {
                                _sensorHeading = heading;
                                resolveBestHeading();
                            }
                        }
                    });
                    sensor.addEventListener('error', (e) => {
                        console.log('[Compass] RelativeOrientationSensor error:', e.error.name);
                    });
                    sensor.start();
                    console.log('[Compass] RelativeOrientationSensor started');
                } catch (err) {
                    console.log('[Compass] RelativeOrientationSensor unavailable:', err.message);
                }
            }
        }

        // Convert quaternion [x,y,z,w] to compass heading (yaw around Z-axis)
        function quaternionToHeading(x, y, z, w) {
            // Yaw (rotation around vertical axis)
            const siny_cosp = 2 * (w * z + x * y);
            const cosy_cosp = 1 - 2 * (y * y + z * z);
            let yaw = Math.atan2(siny_cosp, cosy_cosp) * 180 / Math.PI;
            // Normalize to 0â€“360, convert to compass bearing
            return ((360 - yaw) % 360 + 360) % 360;
        }

        initDeviceOrientation();

        // Diagnostic: log sensor status after 3s
        setTimeout(() => {
            const sources = [];
            if (_absoluteHeading != null) sources.push('ABSOLUTE compass');
            if (_sensorHeading != null) sources.push('Generic Sensor API');
            if (_relativeHeading != null) sources.push('Relative gyro');
            if (_gpsHeading != null) sources.push('GPS');
            if (_cvYaw != null) sources.push('CV yaw');
            console.log('[Compass] Active heading sources:', sources.length ? sources.join(', ') : 'NONE â€” waiting for data');
        }, 3000);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  CHARTS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const MAX = 80;
        const earData = [], earLabels = [];
        const marData = [], marLabels = [];
        const co2Data = [], co2Labels = [];
        const spdData = [], spdLabels = [];

        function makeChart(ctx, label, color, data, labels, yMin, yMax, threshold, threshLabel) {
            return new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label, data, borderColor: color, backgroundColor: color + '15', borderWidth: 2, fill: true, tension: 0.4, pointRadius: 0 }] },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: { duration: 150 },
                    scales: {
                        x: { display: false },
                        y: { min: yMin, max: yMax, grid: { color: '#f1f5f9' }, ticks: { font: { family: 'Inter', size: 10 }, color: '#94a3b8' } },
                    },
                    plugins: { legend: { display: false } },
                },
                plugins: threshold != null ? [{
                    afterDraw(chart) {
                        const y = chart.scales.y.getPixelForValue(threshold);
                        const ctx2 = chart.ctx;
                        ctx2.save();
                        ctx2.strokeStyle = '#ef4444'; ctx2.lineWidth = 1; ctx2.setLineDash([5,4]);
                        ctx2.beginPath(); ctx2.moveTo(chart.chartArea.left, y); ctx2.lineTo(chart.chartArea.right, y); ctx2.stroke();
                        ctx2.fillStyle = '#ef4444'; ctx2.font = '10px Inter';
                        ctx2.fillText(threshLabel, chart.chartArea.right - ctx2.measureText(threshLabel).width - 4, y - 5);
                        ctx2.restore();
                    }
                }] : [],
            });
        }

        const earChart  = makeChart($('ear-chart').getContext('2d'),   'EAR',  '#3b82f6', earData, earLabels, 0.05, 0.45, 0.20, 'Drowsy');
        const marChart  = makeChart($('mar-chart').getContext('2d'),   'MAR',  '#8b5cf6', marData, marLabels, 0.00, 0.90, 0.50, 'Yawn');
        const co2Chart  = makeChart($('co2-chart').getContext('2d'),   'COâ‚‚',  '#f59e0b', co2Data, co2Labels, 300, 1800, 1000, 'Danger');
        const speedChart = makeChart($('speed-chart').getContext('2d'),'Speed','#06b6d4', spdData, spdLabels, 0, 140, null, null);

        function pushChart(chart, labels, data, val, max) {
            const t = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
            labels.push(t); data.push(val);
            if (labels.length > max) { labels.shift(); data.shift(); }
            chart.update('none');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  ALERT FEED (deduplicated)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const _recentAlerts = {};  // text â†’ timestamp of last shown
        const ALERT_COOLDOWN = 8000;  // Min 8 seconds between same alert type

        // Alert type classification from CV pipeline text
        function classifyAlert(text) {
            const t = text.toUpperCase();
            if (t.includes('DROWSI') || t.includes('DROWSY') || t.includes('EYES CLOSED')) return { type: 'drowsiness', icon: 'ðŸ˜´', severity: 'danger', color: 'red' };
            if (t.includes('YAWN')) return { type: 'yawning', icon: 'ðŸ¥±', severity: 'warning', color: 'amber' };
            if (t.includes('DISTRACT')) return { type: 'distraction', icon: 'ðŸ“±', severity: 'danger', color: 'orange' };
            if (t.includes('PHONE')) return { type: 'phone', icon: 'ðŸ“ž', severity: 'danger', color: 'red' };
            if (t.includes('LOOKING AWAY') || t.includes('LOOKING DOWN')) return { type: 'looking_away', icon: 'ðŸ‘€', severity: 'warning', color: 'amber' };
            if (t.includes('SOS') || t.includes('EMERGENCY')) return { type: 'sos', icon: 'ðŸš¨', severity: 'danger', color: 'red' };
            return { type: 'other', icon: 'âš ï¸', severity: 'warning', color: 'amber' };
        }

        function addAlert(text, vid, type = 'danger') {
            // Only accept alerts from real CV pipeline (not simulation)
            const now = Date.now();
            const cls = classifyAlert(text);
            const key = cls.type + '|' + vid;
            if (_recentAlerts[key] && now - _recentAlerts[key] < ALERT_COOLDOWN) return;
            _recentAlerts[key] = now;

            // Remove "no alerts" placeholder
            const noMsg = document.getElementById('no-alerts-msg');
            if (noMsg) noMsg.remove();
            if (firstAlert) { DOM.alertFeed.innerHTML = ''; firstAlert = false; }
            alertTotal++;
            DOM.alertCount.textContent = alertTotal;
            DOM.alertCount.className = 'px-2 py-0.5 rounded-full text-[10px] font-semibold bg-red-100 text-red-600';

            // Flash the alerts panel border on new alert
            const panel = document.getElementById('alerts-panel');
            panel.className = 'bg-white rounded-xl border-2 border-red-300 shadow-sm flex flex-col flex-1';
            setTimeout(() => { panel.className = 'bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col flex-1'; }, 2000);

            const row = document.createElement('div');
            const isDanger = cls.severity === 'danger';
            row.className = `alert-row flex items-start gap-3 p-3 rounded-lg ${isDanger ? 'bg-red-50 border border-red-100' : 'bg-amber-50 border border-amber-100'}`;
            const color = isDanger ? 'text-red-600' : 'text-amber-600';
            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
            row.innerHTML = `
                <div class="flex-shrink-0 text-sm mt-0.5">${cls.icon}</div>
                <div class="flex-1 min-w-0">
                    <p class="text-xs font-semibold ${color}">${escapeHtml(text)}</p>
                    <div class="flex items-center gap-2 mt-0.5">
                        <span class="text-[10px] text-slate-400">${time}</span>
                        <span class="px-1.5 py-0.5 rounded text-[8px] font-bold uppercase ${isDanger ? 'bg-red-100 text-red-500' : 'bg-amber-100 text-amber-500'}">${cls.type.replace('_',' ')}</span>
                        <span class="text-[10px] text-slate-400">${vid}</span>
                    </div>
                </div>`;
            DOM.alertFeed.prepend(row);
            while (DOM.alertFeed.children.length > 50) DOM.alertFeed.removeChild(DOM.alertFeed.lastChild);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Fetch real alert counters from server API (only real CV alerts, never fake)
        async function fetchAlertCounters() {
            try {
                const res = await fetch('/api/alerts/summary');
                const d = await res.json();
                _realAlertCounts = d;
                const cntDrowsy = document.getElementById('cnt-drowsy');
                const cntYawn = document.getElementById('cnt-yawn');
                const cntDistract = document.getElementById('cnt-distract');
                if (cntDrowsy) cntDrowsy.textContent = d.drowsiness || 0;
                if (cntYawn) cntYawn.textContent = d.yawning || 0;
                if (cntDistract) cntDistract.textContent = (d.distraction || 0) + (d.phone || 0) + (d.looking_away || 0);
            } catch(e) { /* server may not be ready */ }
        }
        setInterval(fetchAlertCounters, 4000);
        fetchAlertCounters();

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  PROCESS TELEMETRY
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function processTelemetry(d) {
            const danger = d.status === 'DANGER';
            const isLive = d.is_simulation === false;
            vehicleId = d.vehicle_id || 'â€”';

            // â”€â”€ Real drowsiness tracking (only from CV pipeline) â”€â”€
            if (isLive) {
                const isDrowsy = d.is_drowsy === true;
                const drowsyDur = d.drowsy_duration || 0;
                const drowsyTimerBar = document.getElementById('drowsy-timer-bar');
                const drowsyTimerText = document.getElementById('drowsy-timer-text');
                const drowsyTimerFill = document.getElementById('drowsy-timer-fill');
                const safetyIconBg = document.getElementById('safety-icon-bg');

                if (isDrowsy) {
                    _drowsyActive = true;
                    if (_drowsyStart === 0) _drowsyStart = Date.now();
                    // Show drowsy timer bar in safety card
                    drowsyTimerBar.classList.remove('hidden');
                    drowsyTimerText.textContent = drowsyDur.toFixed(1) + 's';
                    const pct = Math.min(100, (drowsyDur / 10.0) * 100);
                    drowsyTimerFill.style.width = pct + '%';
                    // Safety card goes RED with pulse
                    DOM.safetyCard.className = 'stat-card bg-red-50 rounded-xl border-2 border-red-400 shadow-sm p-4 animate-pulse';
                    safetyIconBg.className = 'w-7 h-7 rounded-lg bg-red-50 flex items-center justify-center';
                } else {
                    _drowsyActive = false;
                    _drowsyStart = 0;
                    drowsyTimerBar.classList.add('hidden');
                    DOM.safetyCard.className = 'stat-card bg-white rounded-xl border border-slate-200 shadow-sm p-4';
                    safetyIconBg.className = 'w-7 h-7 rounded-lg bg-emerald-50 flex items-center justify-center';
                }
            }

            // â”€â”€ Sim / Live badge â”€â”€
            if (isLive) {
                DOM.simBadge.textContent = 'â— LIVE';
                DOM.simBadge.className = 'px-2.5 py-1 rounded-full text-[10px] font-semibold bg-emerald-50 text-emerald-600 border border-emerald-200';
            } else {
                DOM.simBadge.textContent = 'SIMULATION';
                DOM.simBadge.className = 'px-2.5 py-1 rounded-full text-[10px] font-semibold bg-amber-50 text-amber-600 border border-amber-200';
            }

            // â”€â”€ CV Pipeline badge â”€â”€
            if (isLive) {
                DOM.cvBadge.className = 'px-2.5 py-1 rounded-full text-[10px] font-semibold bg-emerald-50 text-emerald-600 border border-emerald-200';
                DOM.cvBadgeIcon.textContent = 'ðŸŸ¢';
                DOM.cvBadgeText.textContent = 'Camera: Live';
                DOM.dotCv.className = 'w-1.5 h-1.5 rounded-full bg-emerald-500';
            } else {
                DOM.cvBadge.className = 'px-2.5 py-1 rounded-full text-[10px] font-semibold bg-slate-50 text-slate-400 border border-slate-200';
                DOM.cvBadgeIcon.textContent = 'ðŸŽ¥';
                DOM.cvBadgeText.textContent = 'Camera: Offline';
                DOM.dotCv.className = 'w-1.5 h-1.5 rounded-full bg-slate-300';
            }

            // Vehicle card
            DOM.vehicleIdLabel.textContent = vehicleId;
            DOM.vehicleBadge.textContent = danger ? 'Alert' : 'Online';
            DOM.vehicleBadge.className = danger
                ? 'px-1.5 py-0.5 rounded-full text-[9px] font-semibold bg-red-50 text-red-600'
                : 'px-1.5 py-0.5 rounded-full text-[9px] font-semibold bg-emerald-50 text-emerald-600';

            // â”€â”€ Safety score (use real attention_score when live) â”€â”€
            if (isLive && d.attention_score != null) {
                safetyScore = d.attention_score;
            } else {
                if (danger) safetyScore = Math.max(42, safetyScore - 0.35);
                else safetyScore = Math.min(99, safetyScore + 0.05);
            }
            DOM.statSafety.textContent = Math.round(safetyScore) + '%';
            DOM.statSafety.className = safetyScore < 50 ? 'text-2xl font-bold text-red-600' : safetyScore < 70 ? 'text-2xl font-bold text-amber-600' : 'text-2xl font-bold text-emerald-600';

            // â”€â”€ Face detection + affective state â”€â”€
            const faceDetected = d.face_detected;
            const affective = d.affective_state || '';
            if (isLive) {
                DOM.dotFace.className = faceDetected
                    ? 'w-1.5 h-1.5 rounded-full bg-emerald-500'
                    : 'w-1.5 h-1.5 rounded-full bg-red-500';
                DOM.faceLabel.textContent = faceDetected ? 'Face: âœ“' : 'Face: âœ—';
                // Affective state badge
                const stateColors = { 'ALERT': 'text-emerald-500', 'NEUTRAL': 'text-slate-400', 'TIRED': 'text-amber-500', 'DROWSY': 'text-red-500', 'DISTRACTED': 'text-orange-500' };
                DOM.affectiveLabel.textContent = affective;
                DOM.affectiveLabel.className = 'ml-1 text-[10px] font-semibold ' + (stateColors[affective] || 'text-slate-400');
            } else {
                DOM.dotFace.className = 'w-1.5 h-1.5 rounded-full bg-emerald-500';
                DOM.faceLabel.textContent = 'Simulated';
                DOM.affectiveLabel.textContent = '';
            }

            // â”€â”€ Drowsiness alarm visual (handled above in real drowsiness tracking) â”€â”€
            // Safety card styling is now driven by real CV drowsiness state above

            // Speed â€” use IMU speed as fallback when GPS speed is 0
            const speed = d.speed_kmh || 0;
            const imuData = d.imu || null;
            const hasIMU = d.imu_source === 'MPU6050';
            let speedSource = 'GPS';
            let displaySpeed = speed;
            if (hasIMU && imuData) {
                updateIMUStatus(true);
                updateGForce(imuData.g_force || 1.0);
                // If GPS speed is 0 but IMU has speed, use IMU
                if (speed < 0.5 && imuData.speed_kmh > 0.5) {
                    displaySpeed = imuData.speed_kmh;
                    speedSource = 'IMU';
                }
            } else {
                updateIMUStatus(false);
            }
            DOM.statSpeed.textContent = displaySpeed.toFixed(0);
            DOM.mapSpeed.textContent = displaySpeed.toFixed(0);
            DOM.speedLive.textContent = displaySpeed.toFixed(0);
            updateSpeedometer(displaySpeed, speedSource);
            if (displaySpeed > maxSpeed) { maxSpeed = displaySpeed; DOM.statMaxSpeed.textContent = maxSpeed.toFixed(0); }
            pushChart(speedChart, spdLabels, spdData, displaySpeed, MAX);

            // Footer GPS status
            if (d.gps_source === 'browser') {
                if (DOM.footerGpsDot) DOM.footerGpsDot.style.background = '#10b981';
                if (DOM.footerGpsStatus) DOM.footerGpsStatus.textContent = 'Live';
            } else {
                if (DOM.footerGpsDot) DOM.footerGpsDot.style.background = '#f59e0b';
                if (DOM.footerGpsStatus) DOM.footerGpsStatus.textContent = 'Acquiring';
            }
            // Footer timestamp
            if (DOM.footerTimestamp) DOM.footerTimestamp.textContent = new Date().toLocaleTimeString();

            // COâ‚‚ + sensor status
            const co2 = d.co2_ppm || 0;
            const co2Source = d.co2_source || 'none';
            const hasSensor = co2Source === 'MQ-135';

            // Sensor badge in navbar
            if (hasSensor) {
                DOM.sensorBadge.className = 'px-2.5 py-1 rounded-full text-[10px] font-semibold bg-emerald-50 text-emerald-600 border border-emerald-200';
                DOM.sensorBadgeIcon.textContent = 'ðŸŸ¢';
                DOM.sensorBadgeText.textContent = 'MQ-135: Live';
            } else {
                DOM.sensorBadge.className = 'px-2.5 py-1 rounded-full text-[10px] font-semibold bg-slate-50 text-slate-400 border border-slate-200';
                DOM.sensorBadgeIcon.textContent = 'ðŸ”Œ';
                DOM.sensorBadgeText.textContent = 'MQ-135: No Sensor';
            }

            // MQ dot in System Status card
            DOM.dotSensor.className = hasSensor
                ? 'w-1.5 h-1.5 rounded-full bg-emerald-500'
                : 'w-1.5 h-1.5 rounded-full bg-red-500';

            // CO2 stat card
            if (!hasSensor) {
                DOM.statCo2.textContent = 'â€”';
                DOM.statCo2.className = 'text-2xl font-bold text-slate-300';
                DOM.co2Bar.style.width = '0%';
                DOM.co2Bar.className = 'h-full rounded-full bg-slate-200 transition-all duration-500';
                DOM.co2IconBg.className = 'w-7 h-7 rounded-lg bg-slate-50 flex items-center justify-center';
            } else {
                DOM.statCo2.textContent = co2.toFixed(0);
                const pct = Math.min(100, (co2 / 1800) * 100);
                DOM.co2Bar.style.width = pct + '%';
                if (co2 > 1000) {
                    DOM.statCo2.className = 'text-2xl font-bold text-red-600';
                    DOM.co2Bar.className = 'h-full rounded-full bg-red-500 transition-all duration-500';
                    DOM.co2IconBg.className = 'w-7 h-7 rounded-lg bg-red-50 flex items-center justify-center';
                } else if (co2 > 700) {
                    DOM.statCo2.className = 'text-2xl font-bold text-amber-600';
                    DOM.co2Bar.className = 'h-full rounded-full bg-amber-400 transition-all duration-500';
                    DOM.co2IconBg.className = 'w-7 h-7 rounded-lg bg-amber-50 flex items-center justify-center';
                } else {
                    DOM.statCo2.className = 'text-2xl font-bold text-slate-800';
                    DOM.co2Bar.className = 'h-full rounded-full bg-emerald-500 transition-all duration-500';
                    DOM.co2IconBg.className = 'w-7 h-7 rounded-lg bg-sky-50 flex items-center justify-center';
                }
            }

            // System status
            if (danger) {
                DOM.statSys.textContent = 'THREAT';
                DOM.statSys.className = 'text-xs font-semibold text-red-600';
                DOM.sysIconBg.className = 'w-7 h-7 rounded-lg bg-red-50 flex items-center justify-center';
            } else {
                DOM.statSys.textContent = 'Nominal';
                DOM.statSys.className = 'text-xs font-semibold text-emerald-600';
                DOM.sysIconBg.className = 'w-7 h-7 rounded-lg bg-emerald-50 flex items-center justify-center';
            }

            // Map â€” ONLY update when server sends real GPS location (not null)
            if (d.location && d.location.lat != null && d.location.lon != null && d.gps_source === 'browser') {
                updateMap(d.location.lat, d.location.lon);
                // GPS heading (only valid when moving) â€” also rotate car marker
                if (d.location.heading != null && !isNaN(d.location.heading)) {
                    _gpsHeading = d.location.heading;
                    // Rotate car direction arrow
                    const arrow = document.getElementById('car-direction-arrow');
                    if (arrow) arrow.style.transform = `rotate(${d.location.heading}deg)`;
                }
                if (d.location.accuracy) {
                    updateAccuracyCircle(d.location.lat, d.location.lon, d.location.accuracy);
                    DOM.mapAccuracy.textContent = d.location.accuracy.toFixed(0);
                }
                if (d.location.altitude != null) {
                    DOM.statAltitude.textContent = `Alt: ${d.location.altitude}m`;
                    if (DOM.tripAltOverlay) DOM.tripAltOverlay.textContent = d.location.altitude.toFixed(0) + ' m';
                }
                // Tracking dot â†’ green
                if (DOM.trackingDot) DOM.trackingDot.style.background = '#10b981';
            }

            // â”€â”€ Head Pose â†’ Compass (CV pipeline yaw data) â”€â”€
            if (isLive && d.yaw != null) {
                // Convert head yaw to compass-like heading (0=forward, +right, -left)
                // Map yaw to 0-360 where 0=facing forward
                _cvYaw = ((d.yaw + 360) % 360);
                const headYawEl = $('head-yaw-val');
                const headPitchEl = $('head-pitch-val');
                if (headYawEl) headYawEl.textContent = (d.yaw || 0).toFixed(1) + 'Â°';
                if (headPitchEl) headPitchEl.textContent = (d.pitch || 0).toFixed(1) + 'Â°';
            }
            // Resolve best available heading source
            resolveBestHeading();
            // When GPS is not available, keep map static â€” no fake movement
            if (d.gps_source === 'none') {
                DOM.mapLat.textContent = 'â€”';
                DOM.mapLon.textContent = 'â€”';
                DOM.mapAccuracy.textContent = 'â€”';
            }

            // EAR
            const ear = d.ear || 0;
            DOM.earLive.textContent = ear.toFixed(3);
            DOM.earLive.className = ear < 0.20 ? 'text-base font-bold text-red-600' : 'text-base font-bold text-slate-800';
            DOM.earDot.className = ear < 0.20 ? 'w-2 h-2 rounded-full bg-red-500' : 'w-2 h-2 rounded-full bg-emerald-500';
            pushChart(earChart, earLabels, earData, ear, MAX);

            // MAR
            const mar = d.mar || 0;
            DOM.marLive.textContent = mar.toFixed(3);
            DOM.marLive.className = mar > 0.50 ? 'text-base font-bold text-red-600' : 'text-base font-bold text-slate-800';
            DOM.marDot.className = mar > 0.50 ? 'w-2 h-2 rounded-full bg-red-500' : 'w-2 h-2 rounded-full bg-emerald-500';
            pushChart(marChart, marLabels, marData, mar, MAX);

            // COâ‚‚ chart
            if (hasSensor) {
                DOM.co2Live.textContent = co2.toFixed(0);
                DOM.co2Live.className = co2 > 1000 ? 'text-base font-bold text-red-600' : 'text-base font-bold text-slate-800';
                DOM.co2Dot.className = co2 > 1000 ? 'w-2 h-2 rounded-full bg-red-500' : 'w-2 h-2 rounded-full bg-emerald-500';
                pushChart(co2Chart, co2Labels, co2Data, co2, MAX);
            } else {
                DOM.co2Live.textContent = 'â€”';
                DOM.co2Live.className = 'text-base font-bold text-slate-300';
                DOM.co2Dot.className = 'w-2 h-2 rounded-full bg-slate-300';
            }

            // Alerts â€” ONLY from real CV pipeline, never from simulation
            if (isLive && d.alerts && d.alerts.length > 0) {
                d.alerts.forEach(a => {
                    const cls = classifyAlert(a);
                    addAlert(a, vehicleId, cls.severity);
                });
            }

            // â”€â”€ Sync tracking page if active â”€â”€
            if (_currentPage === 'tracking') {
                updateTrackingPage(d);
            }
            // â”€â”€ Sync safety page if active â”€â”€
            if (_currentPage === 'safety') {
                updateSafetyPage(d);
                // Update COâ‚‚ risk in real-time
                if (d.co2_ppm) updateCo2Risk(d.co2_ppm);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  SOS BUTTON
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        DOM.sosBtn.addEventListener('click', () => {
            if (!confirm('âš ï¸ Send Emergency SOS for vehicle ' + vehicleId + '?')) return;
            addAlert('ðŸš¨ EMERGENCY SOS ACTIVATED', vehicleId, 'danger');
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'SOS', vehicle_id: vehicleId, timestamp: new Date().toISOString() }));
            }
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  WEBSOCKET
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function connect() {
            const proto = location.protocol === 'https:' ? 'wss' : 'ws';
            ws = new WebSocket(`${proto}://${location.host}/ws/dashboard`);

            ws.onopen = () => {
                DOM.wsDot.className = 'w-2 h-2 rounded-full bg-emerald-500 dot-blink';
                DOM.wsLabel.textContent = 'Connected';
            };
            ws.onmessage = (e) => {
                try { processTelemetry(JSON.parse(e.data)); } catch {}
            };
            ws.onclose = () => {
                DOM.wsDot.className = 'w-2 h-2 rounded-full bg-red-500 dot-blink';
                DOM.wsLabel.textContent = 'Reconnectingâ€¦';
                setTimeout(connect, 3000);
            };
            ws.onerror = () => ws.close();
        }
        connect();

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  PAGE NAVIGATION (SPA-style)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let _currentPage = 'dashboard';
        let _trkMapInit = false;
        let trkMap, trkMarker, trkTrail, trkMarkerOnMap = false;
        let _trkSatellite = false, _trkTrailVisible = true;
        let _trkSatLayer, _trkStreetLayer;
        let _trkAccuracyCircle = null;

        const pageIds = ['page-dashboard', 'page-tracking', 'page-safety', 'page-adar-points', 'page-analytics', 'page-settings', 'page-support'];
        const pageTitles = {
            dashboard: 'Fleet Dashboard',
            tracking: 'Live Tracking',
            safety: 'Safety Reports',
            'adar-points': 'ADAR Points',
            analytics: 'Analytics',
            settings: 'Settings',
            support: 'Support',
        };
        const pageSubtitles = {
            dashboard: 'Real-time fleet intelligence',
            tracking: 'Real-time vehicle location & sensor data',
            safety: 'Driver safety reports & history',
            'adar-points': 'Insurance intelligence & driver scoring',
            analytics: 'Fleet performance analytics',
            settings: 'System configuration & preferences',
            support: 'Help & documentation',
        };

        // Sidebar nav click handler
        document.querySelectorAll('.nav-link[data-page]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = link.dataset.page;
                if (page === _currentPage) return;
                switchPage(page);
            });
        });

        function switchPage(page) {
            _currentPage = page;

            // Toggle page sections
            pageIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('active');
            });
            const targetEl = document.getElementById('page-' + page);
            if (targetEl) targetEl.classList.add('active');

            // Update sidebar active state
            document.querySelectorAll('.nav-link[data-page]').forEach(l => {
                l.classList.remove('active');
                l.classList.remove('text-slate-200');
                l.classList.add('text-slate-400');
            });
            const activeLink = document.querySelector(`.nav-link[data-page="${page}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
                activeLink.classList.remove('text-slate-400');
                activeLink.classList.add('text-slate-200');
            }

            // Update header title
            const h1 = document.querySelector('header h1');
            if (h1) h1.textContent = pageTitles[page] || 'Fleet Dashboard';
            DOM.subtitle.textContent = pageSubtitles[page] || '';

            // Init tracking map on first visit
            if (page === 'tracking') {
                initTrackingMap();
            }

            // Init safety charts on first visit & fetch analytics
            if (page === 'safety') {
                initSafetyCharts();
                fetchSafetyAnalytics();
            }

            // Init analytics charts on first visit & fetch data
            if (page === 'analytics') {
                initAnalyticsCharts();
                fetchFleetAnalytics();
            }

            // Invalidate maps when switching
            setTimeout(() => {
                map.invalidateSize();
                if (trkMap) trkMap.invalidateSize();
            }, 100);
        }

        function initTrackingMap() {
            if (_trkMapInit) {
                trkMap.invalidateSize();
                // Sync position
                if (lastGpsLat != null && lastGpsLon != null) {
                    trkMap.setView([lastGpsLat, lastGpsLon], trkMap.getZoom(), { animate: false });
                }
                return;
            }
            _trkMapInit = true;

            trkMap = L.map('tracking-map', { center: [20, 78], zoom: 5, zoomControl: false });
            _trkStreetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19, attribution: '&copy; OpenStreetMap'
            }).addTo(trkMap);
            _trkSatLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                maxZoom: 19, attribution: '&copy; Esri'
            });

            // Vehicle marker (same style as dashboard map)
            const trkCarIcon = L.divIcon({
                className: '',
                html: `<div style="position:relative; width:44px; height:44px;">
                    <div style="position:absolute; inset:0; border-radius:50%; background:rgba(59,130,246,0.15); animation:accuracyPulse 2s ease-in-out infinite;"></div>
                    <div style="position:absolute; top:8px; left:8px; width:28px; height:28px; border-radius:50%; background:#1e40af; border:3px solid #fff; box-shadow:0 2px 8px rgba(30,64,175,0.4); display:flex; align-items:center; justify-content:center;">
                        <svg style="width:14px; height:14px; color:#fff; transform:rotate(0deg);" id="trk-direction-arrow" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l-5 10h3v10h4V12h3z"/></svg>
                    </div>
                </div>`,
                iconSize: [44, 44], iconAnchor: [22, 22],
            });
            trkMarker = L.marker([20, 78], { icon: trkCarIcon });
            trkTrail = L.polyline([], { color: '#3b82f6', weight: 3, opacity: 0.7, dashArray: '8,6' }).addTo(trkMap);

            // Sync with current GPS position if available
            if (lastGpsLat != null && lastGpsLon != null) {
                trkMarker.setLatLng([lastGpsLat, lastGpsLon]).addTo(trkMap);
                trkMarkerOnMap = true;
                trkMap.setView([lastGpsLat, lastGpsLon], 16, { animate: false });
                // Copy trail points
                if (trailPts.length > 0) trkTrail.setLatLngs([...trailPts]);
            }

            // Build compass ticks for tracking compass
            const trkTicksG = document.getElementById('trk-compass-ticks');
            if (trkTicksG) {
                for (let deg = 0; deg < 360; deg += 5) {
                    const isMajor = deg % 30 === 0;
                    const isCardinal = deg % 90 === 0;
                    if (isCardinal) continue;
                    const inner = isMajor ? 68 : 74;
                    const outer = 80;
                    const rad = deg * Math.PI / 180;
                    const x1 = 100 + inner * Math.sin(rad);
                    const y1 = 100 - inner * Math.cos(rad);
                    const x2 = 100 + outer * Math.sin(rad);
                    const y2 = 100 - outer * Math.cos(rad);
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', x1); line.setAttribute('y1', y1);
                    line.setAttribute('x2', x2); line.setAttribute('y2', y2);
                    line.setAttribute('stroke', isMajor ? '#64748b' : '#cbd5e1');
                    line.setAttribute('stroke-width', isMajor ? '1.5' : '0.8');
                    trkTicksG.appendChild(line);
                    if (isMajor) {
                        const lr = 62, lx = 100 + lr * Math.sin(rad), ly = 100 - lr * Math.cos(rad);
                        const txt = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        txt.setAttribute('x', lx); txt.setAttribute('y', ly + 3);
                        txt.setAttribute('text-anchor', 'middle');
                        txt.setAttribute('font-size', '8'); txt.setAttribute('font-weight', '500');
                        txt.setAttribute('fill', '#94a3b8');
                        txt.textContent = deg.toString();
                        trkTicksG.appendChild(txt);
                    }
                }
            }

            // Map controls
            const trkBtnCenter = $('trk-btn-center');
            const trkBtnTrail = $('trk-btn-trail');
            const trkBtnSat = $('trk-btn-satellite');
            const trkBtnZoomIn = $('trk-btn-zoom-in');
            const trkBtnZoomOut = $('trk-btn-zoom-out');

            if (trkBtnCenter) trkBtnCenter.addEventListener('click', () => {
                if (lastGpsLat != null) trkMap.setView([lastGpsLat, lastGpsLon], 17, { animate: true });
            });
            if (trkBtnTrail) trkBtnTrail.addEventListener('click', () => {
                _trkTrailVisible = !_trkTrailVisible;
                if (_trkTrailVisible) { trkTrail.addTo(trkMap); trkBtnTrail.querySelector('svg').style.opacity = '1'; }
                else { trkTrail.remove(); trkBtnTrail.querySelector('svg').style.opacity = '0.3'; }
            });
            if (trkBtnSat) trkBtnSat.addEventListener('click', () => {
                _trkSatellite = !_trkSatellite;
                if (_trkSatellite) { trkMap.removeLayer(_trkStreetLayer); _trkSatLayer.addTo(trkMap); trkBtnSat.classList.add('bg-blue-100'); }
                else { trkMap.removeLayer(_trkSatLayer); _trkStreetLayer.addTo(trkMap); trkBtnSat.classList.remove('bg-blue-100'); }
            });
            if (trkBtnZoomIn) trkBtnZoomIn.addEventListener('click', () => trkMap.zoomIn());
            if (trkBtnZoomOut) trkBtnZoomOut.addEventListener('click', () => trkMap.zoomOut());

            setTimeout(() => trkMap.invalidateSize(), 200);
        }

        // â”€â”€ Sync tracking page with telemetry â”€â”€
        function updateTrackingPage(d) {
            if (!_trkMapInit) return;

            // Vehicle badge
            const trkVBadge = $('trk-vehicle-badge');
            if (trkVBadge) trkVBadge.textContent = d.vehicle_id || 'VH-7842';

            // Mode badge
            const trkModeBadge = $('trk-mode-badge');
            if (trkModeBadge) {
                if (d.is_simulation === false) {
                    trkModeBadge.textContent = 'â— LIVE';
                    trkModeBadge.className = 'px-2.5 py-0.5 rounded-full text-[9px] font-bold bg-emerald-50 text-emerald-600 border border-emerald-200';
                } else {
                    trkModeBadge.textContent = 'SIMULATION';
                    trkModeBadge.className = 'px-2.5 py-0.5 rounded-full text-[9px] font-bold bg-amber-50 text-amber-600 border border-amber-200';
                }
            }

            // GPS info
            const trkGpsDot = $('trk-gps-dot');
            const trkGpsLabel = $('trk-gps-label');
            if (d.gps_source === 'browser') {
                if (trkGpsDot) trkGpsDot.style.background = '#10b981';
                if (trkGpsLabel) trkGpsLabel.textContent = 'Active';
            } else {
                if (trkGpsDot) trkGpsDot.style.background = '#f59e0b';
                if (trkGpsLabel) trkGpsLabel.textContent = 'Acquiring';
            }

            // IMU
            const trkImuDot = $('trk-imu-dot');
            const trkImuLabel = $('trk-imu-label');
            const hasIMU = d.imu_source === 'MPU6050';
            if (trkImuDot) trkImuDot.style.background = hasIMU ? '#10b981' : '#94a3b8';
            if (trkImuLabel) trkImuLabel.textContent = hasIMU ? 'Live' : 'â€”';

            // Coordinates
            if (d.location && d.location.lat != null) {
                const trkLat = $('trk-lat'), trkLon = $('trk-lon'), trkAcc = $('trk-accuracy');
                if (trkLat) trkLat.textContent = d.location.lat.toFixed(5);
                if (trkLon) trkLon.textContent = d.location.lon.toFixed(5);
                if (trkAcc && d.location.accuracy) trkAcc.textContent = d.location.accuracy.toFixed(0);
            }

            // Clock
            const trkClock = $('trk-clock');
            if (trkClock) trkClock.textContent = new Date().toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' });

            // Speed
            const speed = d.speed_kmh || 0;
            const imuData = d.imu || null;
            let displaySpeed = speed;
            let speedSrc = 'GPS';
            if (hasIMU && imuData && speed < 0.5 && imuData.speed_kmh > 0.5) {
                displaySpeed = imuData.speed_kmh; speedSrc = 'IMU';
            }

            // Speedometer arc (tracking page)
            const trkSpeedoArc = $('trk-speedo-arc');
            const trkSpeedVal = $('trk-speed-val');
            const trkSpeedSource = $('trk-speed-source');
            if (trkSpeedoArc) {
                const s = Math.max(0, Math.min(displaySpeed, 160));
                const off = 220 - (s / 160) * 220;
                trkSpeedoArc.setAttribute('stroke-dashoffset', off);
                trkSpeedoArc.setAttribute('stroke', s < 60 ? '#3b82f6' : s < 100 ? '#f59e0b' : '#ef4444');
            }
            if (trkSpeedVal) trkSpeedVal.textContent = Math.round(displaySpeed);
            if (trkSpeedSource) trkSpeedSource.textContent = speedSrc;

            // G-force
            if (hasIMU && imuData) {
                const trkGforce = $('trk-gforce');
                const trkGforceDot = $('trk-gforce-dot');
                if (trkGforce) trkGforce.textContent = (imuData.g_force || 1.0).toFixed(2);
                if (trkGforceDot) trkGforceDot.style.background = (imuData.g_force || 1) < 1.5 ? '#3b82f6' : (imuData.g_force || 1) < 2.5 ? '#f59e0b' : '#ef4444';
            }

            // Max / Avg speed
            const trkMaxSpd = $('trk-max-speed');
            const trkAvgSpd = $('trk-avg-speed');
            if (trkMaxSpd) trkMaxSpd.textContent = maxSpeed.toFixed(0);
            if (trkAvgSpd && _speedSamples.length > 0) {
                trkAvgSpd.textContent = (_speedSamples.reduce((a,b) => a+b, 0) / _speedSamples.length).toFixed(0);
            }

            // Trip Stats
            const trkDist = $('trk-distance');
            const trkDur = $('trk-duration');
            const trkAlt = $('trk-altitude');
            const trkTrailPts = $('trk-trail-pts');
            if (trkDist) trkDist.textContent = tripDistanceKm.toFixed(2) + ' km';
            if (trkDur) {
                const el2 = Math.floor((Date.now() - _tripStartTime) / 1000);
                const hh = Math.floor(el2/3600), mm2 = String(Math.floor((el2%3600)/60)).padStart(2,'0'), ss2 = String(el2%60).padStart(2,'0');
                trkDur.textContent = hh > 0 ? `${hh}:${mm2}:${ss2}` : `${mm2}:${ss2}`;
            }
            if (trkAlt && d.location && d.location.altitude != null) trkAlt.textContent = d.location.altitude.toFixed(0) + ' m';
            if (trkTrailPts) trkTrailPts.textContent = trailPts.length;

            // Map position sync
            if (d.location && d.location.lat != null && d.location.lon != null && d.gps_source === 'browser') {
                const ll = [d.location.lat, d.location.lon];
                if (!trkMarkerOnMap) { trkMarker.addTo(trkMap); trkMarkerOnMap = true; trkMap.setView(ll, 16); }
                trkMarker.setLatLng(ll);
                trkTrail.setLatLngs([...trailPts]);
                trkMap.panTo(ll, { animate: true, duration: 0.4 });

                // Direction arrow
                if (d.location.heading != null) {
                    const trkArrow = document.getElementById('trk-direction-arrow');
                    if (trkArrow) trkArrow.style.transform = `rotate(${d.location.heading}deg)`;
                }

                // Accuracy circle
                if (d.location.accuracy) {
                    if (_trkAccuracyCircle) {
                        _trkAccuracyCircle.setLatLng(ll);
                        _trkAccuracyCircle.setRadius(d.location.accuracy);
                    } else {
                        _trkAccuracyCircle = L.circle(ll, {
                            radius: d.location.accuracy, color: '#3b82f6', fillColor: '#3b82f6',
                            fillOpacity: 0.08, weight: 1, opacity: 0.25,
                        }).addTo(trkMap);
                    }
                }
            }

            // Compass sync (tracking page compass)
            const trkCompassGroup = document.getElementById('trk-compass-group');
            const trkHeadingVal = $('trk-heading-val');
            const trkHeadingDir = $('trk-heading-dir');
            const trkHeadingSrc = $('trk-heading-src');
            if (trkCompassGroup) {
                trkCompassGroup.setAttribute('transform', `rotate(${-_displayHeading}, 100, 100)`);
            }
            if (trkHeadingVal) trkHeadingVal.textContent = Math.round(_displayHeading) + 'Â°';
            if (trkHeadingDir) {
                const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
                trkHeadingDir.textContent = dirs[Math.round(_displayHeading / 22.5) % 16];
            }
            if (trkHeadingSrc) {
                const srcLabels = { device: 'ðŸ§­ COMPASS', sensor: 'ðŸ”„ IMU', gyro: 'ðŸ”ƒ GYRO', gps: 'ðŸ›°ï¸ GPS', cv: 'ðŸŽ¥ HEAD' };
                trkHeadingSrc.textContent = srcLabels[_headingSource] || 'WAITING';
                const srcColors = {
                    device: 'bg-emerald-50 text-emerald-600', sensor: 'bg-teal-50 text-teal-600',
                    gyro: 'bg-cyan-50 text-cyan-600', gps: 'bg-blue-50 text-blue-600',
                    cv: 'bg-violet-50 text-violet-600', none: 'bg-slate-100 text-slate-400',
                };
                trkHeadingSrc.className = `px-2 py-0.5 rounded-full text-[8px] font-semibold ${srcColors[_headingSource] || srcColors.none}`;
            }

            // Safety status
            const trkSafetyScore = $('trk-safety-score');
            const trkSafetyRing = $('trk-safety-ring');
            const trkSafetyBadge = $('trk-safety-badge');
            const trkSafetyCard = $('trk-safety-card');
            if (trkSafetyScore) trkSafetyScore.textContent = Math.round(safetyScore) + '%';
            if (trkSafetyRing) {
                const circumference = 150.8;
                const offset = circumference - (safetyScore / 100) * circumference;
                trkSafetyRing.setAttribute('stroke-dashoffset', offset);
                trkSafetyRing.setAttribute('stroke', safetyScore < 50 ? '#ef4444' : safetyScore < 70 ? '#f59e0b' : '#10b981');
            }
            if (trkSafetyBadge) {
                if (d.is_drowsy) {
                    trkSafetyBadge.textContent = 'DROWSY';
                    trkSafetyBadge.className = 'px-2 py-0.5 rounded-full text-[9px] font-bold bg-red-50 text-red-600';
                    if (trkSafetyCard) trkSafetyCard.className = 'instrument-card border-2 !border-red-300 animate-pulse';
                } else {
                    trkSafetyBadge.textContent = 'SAFE';
                    trkSafetyBadge.className = 'px-2 py-0.5 rounded-full text-[9px] font-bold bg-emerald-50 text-emerald-600';
                    if (trkSafetyCard) trkSafetyCard.className = 'instrument-card';
                }
            }

            // Face & CV
            const trkFaceDot = $('trk-face-dot');
            const trkFaceLabel = $('trk-face-label');
            const trkCvDot = $('trk-cv-dot');
            const trkCvLabel = $('trk-cv-label');
            const trkDrowsyDot = $('trk-drowsy-dot');
            const trkDrowsyLabel = $('trk-drowsy-label');
            if (d.is_simulation === false) {
                if (trkFaceDot) trkFaceDot.style.background = d.face_detected ? '#10b981' : '#ef4444';
                if (trkFaceLabel) trkFaceLabel.textContent = d.face_detected ? 'Face: âœ“' : 'Face: âœ—';
                if (trkCvDot) trkCvDot.style.background = '#10b981';
                if (trkCvLabel) trkCvLabel.textContent = 'CV: Live';
                if (trkDrowsyDot) trkDrowsyDot.style.background = d.is_drowsy ? '#ef4444' : '#10b981';
                if (trkDrowsyLabel) trkDrowsyLabel.textContent = d.is_drowsy ? 'DROWSY' : (d.affective_state || 'Alert');
            }

            // Sensor readings
            const ear = d.ear || 0, mar = d.mar || 0;
            const co2 = d.co2_ppm || 0;
            const trkEarVal = $('trk-ear-val'), trkEarDot = $('trk-ear-dot'), trkEarBar = $('trk-ear-bar');
            const trkMarVal = $('trk-mar-val'), trkMarDot = $('trk-mar-dot'), trkMarBar = $('trk-mar-bar');
            const trkCo2Val = $('trk-co2-val'), trkCo2Dot = $('trk-co2-dot'), trkCo2Bar = $('trk-co2-bar');
            const trkSpeedReading = $('trk-speed-reading');
            if (trkEarVal) trkEarVal.textContent = ear.toFixed(3);
            if (trkEarDot) trkEarDot.style.background = ear < 0.20 ? '#ef4444' : '#10b981';
            if (trkEarBar) trkEarBar.style.width = Math.min(100, (ear / 0.45) * 100) + '%';
            if (trkEarBar) trkEarBar.className = `h-full rounded-full transition-all ${ear < 0.20 ? 'bg-red-500' : 'bg-blue-500'}`;
            if (trkMarVal) trkMarVal.textContent = mar.toFixed(3);
            if (trkMarDot) trkMarDot.style.background = mar > 0.50 ? '#ef4444' : '#10b981';
            if (trkMarBar) trkMarBar.style.width = Math.min(100, (mar / 0.90) * 100) + '%';
            if (trkMarBar) trkMarBar.className = `h-full rounded-full transition-all ${mar > 0.50 ? 'bg-red-500' : 'bg-violet-500'}`;
            if (trkCo2Val) trkCo2Val.textContent = co2 > 0 ? co2.toFixed(0) + ' PPM' : 'â€”';
            if (trkCo2Dot) trkCo2Dot.style.background = co2 > 1000 ? '#ef4444' : co2 > 700 ? '#f59e0b' : '#10b981';
            if (trkCo2Bar) trkCo2Bar.style.width = Math.min(100, (co2 / 1800) * 100) + '%';
            if (trkSpeedReading) trkSpeedReading.textContent = Math.round(displaySpeed) + ' km/h';

            // Footer
            const trkFooterGps = $('trk-footer-gps');
            const trkFooterGpsStatus = $('trk-footer-gps-status');
            const trkFooterImu = $('trk-footer-imu');
            const trkFooterImuStatus = $('trk-footer-imu-status');
            const trkFooterCo2Status = $('trk-footer-co2-status');
            const trkFooterTime = $('trk-footer-time');
            if (trkFooterGps) trkFooterGps.style.background = d.gps_source === 'browser' ? '#10b981' : '#f59e0b';
            if (trkFooterGpsStatus) trkFooterGpsStatus.textContent = d.gps_source === 'browser' ? 'Live' : 'Acquiring';
            if (trkFooterImu) trkFooterImu.style.background = hasIMU ? '#10b981' : '#94a3b8';
            if (trkFooterImuStatus) trkFooterImuStatus.textContent = hasIMU ? 'Live' : 'â€”';
            if (trkFooterCo2Status) trkFooterCo2Status.textContent = (d.co2_source === 'MQ-135') ? 'Live' : 'â€”';
            if (trkFooterTime) trkFooterTime.textContent = new Date().toLocaleTimeString();

            // Recent Alerts (mirror from main alert feed)
            const trkAlertCount = $('trk-alert-count');
            if (trkAlertCount) trkAlertCount.textContent = alertTotal;
            const trkAlertFeed = $('trk-alert-feed');
            const trkNoAlerts = $('trk-no-alerts');
            if (d.is_simulation === false && d.alerts && d.alerts.length > 0 && trkAlertFeed) {
                if (trkNoAlerts) trkNoAlerts.remove();
                d.alerts.forEach(a => {
                    const cls = classifyAlert(a);
                    const row = document.createElement('div');
                    row.className = `flex items-center gap-2 p-1.5 rounded-lg text-[9px] ${cls.severity === 'danger' ? 'bg-red-50' : 'bg-amber-50'}`;
                    const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
                    row.innerHTML = `<span>${cls.icon}</span><span class="flex-1 truncate font-medium">${escapeHtml(a)}</span><span class="text-slate-300">${time}</span>`;
                    trkAlertFeed.prepend(row);
                    while (trkAlertFeed.children.length > 20) trkAlertFeed.removeChild(trkAlertFeed.lastChild);
                });
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  SAFETY REPORTS PAGE â€” Full JS Engine
        //  Chart.js instances, real-time gauge updaters, API analytics poller,
        //  AI recommendations engine, episode & alert timeline renderers.
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let _sfInit = false;
        let sfScoreChart, sfDonutChart, sfEarChart, sfMarChart;
        const sfScoreData = [], sfScoreLabels = [];
        const sfEarData = [], sfEarLabels = [];
        const sfMarData = [], sfMarLabels = [];
        const SF_MAX_PTS = 120; // 2 minutes of data at 1Hz
        let _sfSessionStart = Date.now();
        let _sfLastAnalyticsFetch = 0;
        let _sfAnalyticsData = null;

        // â”€â”€ Tracking vars for safety page live stats â”€â”€
        let _sfEarSamples = [], _sfMarSamples = [];
        let _sfMinEar = 1, _sfMinScore = 100;
        let _sfMaxMar = 0;
        let _sfScoreAccum = [], _sfEarAccum = [], _sfMarAccum = [];

        function initSafetyCharts() {
            if (_sfInit) return;
            _sfInit = true;

            // â”€â”€ Safety Score Timeline Chart â”€â”€
            const scoreCtx = $('sf-score-chart');
            if (scoreCtx) {
                sfScoreChart = new Chart(scoreCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: sfScoreLabels,
                        datasets: [{
                            label: 'Safety Score',
                            data: sfScoreData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16,185,129,0.08)',
                            borderWidth: 2.5,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHitRadius: 8,
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        animation: { duration: 200 },
                        scales: {
                            x: { display: true, grid: { display: false }, ticks: { font: { family: 'Inter', size: 9 }, color: '#94a3b8', maxTicksLimit: 10 } },
                            y: { min: 0, max: 100, grid: { color: '#f1f5f9' }, ticks: { font: { family: 'Inter', size: 10 }, color: '#94a3b8', callback: v => v + '%' } },
                        },
                        plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1e293b', titleFont: { family: 'Inter' }, bodyFont: { family: 'Inter' }, callbacks: { label: ctx => 'Score: ' + ctx.parsed.y.toFixed(1) + '%' } } },
                    },
                    plugins: [{
                        afterDraw(chart) {
                            const ctx2 = chart.ctx;
                            // Warning zone (50%)
                            const y50 = chart.scales.y.getPixelForValue(50);
                            ctx2.save(); ctx2.strokeStyle = '#ef4444'; ctx2.lineWidth = 1; ctx2.setLineDash([5,4]);
                            ctx2.beginPath(); ctx2.moveTo(chart.chartArea.left, y50); ctx2.lineTo(chart.chartArea.right, y50); ctx2.stroke();
                            ctx2.fillStyle = '#ef4444'; ctx2.font = '9px Inter'; ctx2.fillText('Critical', chart.chartArea.right - 36, y50 - 4);
                            // Warning zone (70%)
                            const y70 = chart.scales.y.getPixelForValue(70);
                            ctx2.strokeStyle = '#f59e0b'; ctx2.beginPath();
                            ctx2.moveTo(chart.chartArea.left, y70); ctx2.lineTo(chart.chartArea.right, y70); ctx2.stroke();
                            ctx2.fillStyle = '#f59e0b'; ctx2.fillText('Warning', chart.chartArea.right - 40, y70 - 4);
                            ctx2.restore();
                            // Gradient background zones
                            const area = chart.chartArea;
                            const grad = ctx2.createLinearGradient(0, area.bottom, 0, area.top);
                            grad.addColorStop(0, 'rgba(239,68,68,0.04)');
                            grad.addColorStop(0.5, 'rgba(245,158,11,0.03)');
                            grad.addColorStop(1, 'rgba(16,185,129,0.02)');
                            ctx2.save(); ctx2.fillStyle = grad;
                            ctx2.fillRect(area.left, area.top, area.right - area.left, area.bottom - area.top);
                            ctx2.restore();
                        }
                    }],
                });
            }

            // â”€â”€ Alert Distribution Donut Chart â”€â”€
            const donutCtx = $('sf-donut-chart');
            if (donutCtx) {
                sfDonutChart = new Chart(donutCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Drowsiness', 'Yawning', 'Distraction', 'Phone Use', 'Looking Away'],
                        datasets: [{
                            data: [0, 0, 0, 0, 0],
                            backgroundColor: ['#ef4444', '#f59e0b', '#f97316', '#8b5cf6', '#06b6d4'],
                            borderWidth: 0,
                            hoverOffset: 6,
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        cutout: '72%',
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#1e293b',
                                titleFont: { family: 'Inter', weight: '600' },
                                bodyFont: { family: 'Inter' },
                            },
                        },
                    },
                });
            }

            // â”€â”€ EAR History Chart â”€â”€
            const earCtx = $('sf-ear-chart');
            if (earCtx) {
                sfEarChart = new Chart(earCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: sfEarLabels,
                        datasets: [{
                            label: 'EAR',
                            data: sfEarData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59,130,246,0.06)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.35,
                            pointRadius: 0,
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        animation: { duration: 150 },
                        scales: {
                            x: { display: false },
                            y: { min: 0.05, max: 0.45, grid: { color: '#f1f5f9' }, ticks: { font: { size: 9, family: 'Inter' }, color: '#94a3b8' } },
                        },
                        plugins: { legend: { display: false } },
                    },
                    plugins: [{
                        afterDraw(chart) {
                            const y = chart.scales.y.getPixelForValue(0.20);
                            const ctx2 = chart.ctx;
                            ctx2.save(); ctx2.strokeStyle = '#ef4444'; ctx2.lineWidth = 1; ctx2.setLineDash([4,3]);
                            ctx2.beginPath(); ctx2.moveTo(chart.chartArea.left, y); ctx2.lineTo(chart.chartArea.right, y); ctx2.stroke();
                            ctx2.fillStyle = '#ef4444'; ctx2.font = '9px Inter';
                            ctx2.fillText('Drowsy', chart.chartArea.right - 34, y - 4);
                            ctx2.restore();
                        }
                    }],
                });
            }

            // â”€â”€ MAR History Chart â”€â”€
            const marCtx = $('sf-mar-chart');
            if (marCtx) {
                sfMarChart = new Chart(marCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: sfMarLabels,
                        datasets: [{
                            label: 'MAR',
                            data: sfMarData,
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139,92,246,0.06)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.35,
                            pointRadius: 0,
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        animation: { duration: 150 },
                        scales: {
                            x: { display: false },
                            y: { min: 0, max: 0.90, grid: { color: '#f1f5f9' }, ticks: { font: { size: 9, family: 'Inter' }, color: '#94a3b8' } },
                        },
                        plugins: { legend: { display: false } },
                    },
                    plugins: [{
                        afterDraw(chart) {
                            const y = chart.scales.y.getPixelForValue(0.50);
                            const ctx2 = chart.ctx;
                            ctx2.save(); ctx2.strokeStyle = '#ef4444'; ctx2.lineWidth = 1; ctx2.setLineDash([4,3]);
                            ctx2.beginPath(); ctx2.moveTo(chart.chartArea.left, y); ctx2.lineTo(chart.chartArea.right, y); ctx2.stroke();
                            ctx2.fillStyle = '#ef4444'; ctx2.font = '9px Inter';
                            ctx2.fillText('Yawn', chart.chartArea.right - 28, y - 4);
                            ctx2.restore();
                        }
                    }],
                });
            }
        }

        // â”€â”€ SVG Ring Gauge Updater â”€â”€
        // ring: SVG circle element, val: current 0-1 normalized, circumference, colorFn
        function updateRingGauge(ringId, valNorm, circumference, color) {
            const ring = $(ringId);
            if (!ring) return;
            const offset = circumference - (Math.max(0, Math.min(1, valNorm)) * circumference);
            ring.setAttribute('stroke-dashoffset', offset);
            ring.setAttribute('stroke', color);
        }

        // â”€â”€ Color helpers â”€â”€
        function earColor(ear) { return ear < 0.20 ? '#ef4444' : ear < 0.25 ? '#f59e0b' : '#3b82f6'; }
        function marColor(mar) { return mar > 0.50 ? '#ef4444' : mar > 0.35 ? '#f59e0b' : '#8b5cf6'; }
        function scoreColor(s) { return s < 50 ? '#ef4444' : s < 70 ? '#f59e0b' : '#10b981'; }
        function co2Color(ppm) { return ppm > 1000 ? '#ef4444' : ppm > 700 ? '#f59e0b' : '#10b981'; }

        // â”€â”€ Update Safety Page from Telemetry (called every WS frame) â”€â”€
        function updateSafetyPage(d) {
            if (!_sfInit) initSafetyCharts();

            const isLive = d.is_simulation === false;
            const ear = d.ear || 0;
            const mar = d.mar || 0;
            const co2 = d.co2_ppm || 0;
            const score = isLive && d.attention_score != null ? d.attention_score : safetyScore;
            const isDrowsy = d.is_drowsy === true;
            const drowsyDur = d.drowsy_duration || 0;
            const faceDetected = d.face_detected;
            const affective = d.affective_state || '';
            const co2Source = d.co2_source || 'none';
            const ts = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            // â”€â”€ Track accumulations for session summary â”€â”€
            if (isLive) {
                if (ear > 0) { _sfEarSamples.push(ear); _sfEarAccum.push(ear); }
                if (mar > 0) { _sfMarSamples.push(mar); _sfMarAccum.push(mar); }
                _sfScoreAccum.push(score);
                if (ear > 0 && ear < _sfMinEar) _sfMinEar = ear;
                if (score < _sfMinScore) _sfMinScore = score;
                if (mar > _sfMaxMar) _sfMaxMar = mar;
            }

            // â•â•â• HERO HEADER â•â•â•
            // Giant safety score gauge (circumference = 2*PI*42 = 263.9)
            const scoreNorm = score / 100;
            updateRingGauge('sf-score-ring', scoreNorm, 263.9, scoreColor(score));
            const sfScoreText = $('sf-score-text');
            if (sfScoreText) sfScoreText.textContent = Math.round(score);

            // Risk badge
            const sfRiskBadge = $('sf-risk-badge');
            if (sfRiskBadge) {
                const riskLevel = score < 50 ? 'CRITICAL RISK' : score < 70 ? 'HIGH RISK' : score < 85 ? 'MODERATE' : 'LOW RISK';
                sfRiskBadge.textContent = riskLevel;
                const riskStyles = {
                    'CRITICAL RISK': 'bg-red-500/20 text-red-400 border-red-500/30',
                    'HIGH RISK': 'bg-orange-500/20 text-orange-400 border-orange-500/30',
                    'MODERATE': 'bg-amber-500/20 text-amber-400 border-amber-500/30',
                    'LOW RISK': 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
                };
                sfRiskBadge.className = `px-3 py-1 rounded-full text-[10px] font-bold border ${riskStyles[riskLevel]}`;
            }

            // CV status badge
            const sfCvStatus = $('sf-cv-status');
            if (sfCvStatus) {
                if (isLive) {
                    sfCvStatus.textContent = 'CV: ACTIVE';
                    sfCvStatus.className = 'px-3 py-1 rounded-full text-[10px] font-bold bg-emerald-500/20 text-emerald-400 border border-emerald-500/30';
                } else {
                    sfCvStatus.textContent = 'CV: WAITING';
                    sfCvStatus.className = 'px-3 py-1 rounded-full text-[10px] font-bold bg-slate-500/20 text-slate-400 border border-slate-500/30';
                }
            }

            // Session timer
            const sfSessionTime = $('sf-session-time');
            if (sfSessionTime) {
                const el = Math.floor((Date.now() - _sfSessionStart) / 1000);
                const hh = String(Math.floor(el / 3600)).padStart(2, '0');
                const mm = String(Math.floor((el % 3600) / 60)).padStart(2, '0');
                const ss = String(el % 60).padStart(2, '0');
                sfSessionTime.textContent = `${hh}:${mm}:${ss}`;
            }

            // â•â•â• ROW 1: LIVE GAUGES â•â•â•
            // EAR Gauge (circumference of r=25 = 157)
            const earNorm = Math.min(1, ear / 0.45);
            updateRingGauge('sf-ear-ring', earNorm, 157, earColor(ear));
            const sfEarVal = $('sf-ear-gauge-val');
            if (sfEarVal) sfEarVal.textContent = ear.toFixed(2);
            const sfEarDot = $('sf-ear-status-dot');
            if (sfEarDot) sfEarDot.style.background = earColor(ear);

            // MAR Gauge
            const marNorm = Math.min(1, mar / 0.90);
            updateRingGauge('sf-mar-ring', marNorm, 157, marColor(mar));
            const sfMarVal = $('sf-mar-gauge-val');
            if (sfMarVal) sfMarVal.textContent = mar.toFixed(2);
            const sfMarDot = $('sf-mar-status-dot');
            if (sfMarDot) sfMarDot.style.background = marColor(mar);

            // Driver State
            const sfStateIcon = $('sf-state-icon');
            const sfStateText = $('sf-state-text');
            const sfStateDot = $('sf-state-dot');
            const sfFaceStatus = $('sf-face-status');
            if (sfStateIcon && sfStateText) {
                const stateMap = {
                    'ALERT':      { icon: 'ðŸ˜Š', text: 'ALERT',      color: '#10b981' },
                    'NEUTRAL':    { icon: 'ðŸ˜', text: 'NEUTRAL',    color: '#64748b' },
                    'TIRED':      { icon: 'ðŸ˜ª', text: 'TIRED',      color: '#f59e0b' },
                    'DROWSY':     { icon: 'ðŸ˜´', text: 'DROWSY',     color: '#ef4444' },
                    'DISTRACTED': { icon: 'ðŸ“±', text: 'DISTRACTED', color: '#f97316' },
                };
                const st = stateMap[affective] || (isDrowsy ? stateMap['DROWSY'] : stateMap['ALERT']);
                sfStateIcon.textContent = st.icon;
                sfStateText.textContent = st.text;
                sfStateText.style.color = st.color;
                if (sfStateDot) sfStateDot.style.background = st.color;
            }
            if (sfFaceStatus) sfFaceStatus.textContent = faceDetected ? 'Detected' : isLive ? 'Lost' : 'â€”';

            // Drowsy Timer
            const sfDrowsyDur = $('sf-drowsy-dur');
            const sfDrowsyFill = $('sf-drowsy-fill');
            const sfDrowsyBadge = $('sf-drowsy-badge');
            const sfDrowsyCard = $('sf-drowsy-card');
            if (sfDrowsyDur) {
                sfDrowsyDur.textContent = isDrowsy ? drowsyDur.toFixed(1) + 's' : '0.0s';
                sfDrowsyDur.style.color = isDrowsy ? (drowsyDur > 5 ? '#ef4444' : '#f59e0b') : '#10b981';
            }
            if (sfDrowsyFill) {
                const pct = isDrowsy ? Math.min(100, (drowsyDur / 10) * 100) : 0;
                sfDrowsyFill.style.width = pct + '%';
                sfDrowsyFill.style.background = drowsyDur > 5 ? '#ef4444' : drowsyDur > 2 ? '#f59e0b' : '#10b981';
            }
            if (sfDrowsyBadge) {
                if (isDrowsy) {
                    sfDrowsyBadge.textContent = drowsyDur > 5 ? 'CRITICAL' : 'ACTIVE';
                    sfDrowsyBadge.style.background = drowsyDur > 5 ? '#fef2f2' : '#fffbeb';
                    sfDrowsyBadge.style.color = drowsyDur > 5 ? '#ef4444' : '#f59e0b';
                } else {
                    sfDrowsyBadge.textContent = 'CLEAR';
                    sfDrowsyBadge.style.background = '#f0fdf4';
                    sfDrowsyBadge.style.color = '#10b981';
                }
            }
            if (sfDrowsyCard) {
                sfDrowsyCard.style.borderColor = isDrowsy ? (drowsyDur > 5 ? '#fca5a5' : '#fcd34d') : '';
                sfDrowsyCard.style.borderWidth = isDrowsy ? '2px' : '';
            }

            // COâ‚‚ Gauge
            const co2Norm = Math.min(1, co2 / 1800);
            updateRingGauge('sf-co2-ring', co2Norm, 157, co2Color(co2));
            const sfCo2Val = $('sf-co2-gauge-val');
            if (sfCo2Val) sfCo2Val.textContent = co2 > 0 ? co2.toFixed(0) : 'â€”';
            const sfCo2Source = $('sf-co2-source');
            if (sfCo2Source) sfCo2Source.textContent = co2Source === 'MQ-135' ? 'MQ-135' : 'â€”';
            const sfCo2Level = $('sf-co2-level');
            if (sfCo2Level) {
                const lbl = co2 > 1000 ? 'Danger' : co2 > 700 ? 'Warning' : co2 > 0 ? 'Good' : 'â€”';
                sfCo2Level.textContent = lbl;
                sfCo2Level.style.color = co2Color(co2);
            }
            const sfCo2Dot = $('sf-co2-dot');
            if (sfCo2Dot) sfCo2Dot.style.background = co2 > 0 ? co2Color(co2) : '#94a3b8';

            // â•â•â• ROW 2: CHARTS â•â•â•
            // Push to Safety Score Timeline
            sfScoreLabels.push(ts); sfScoreData.push(score);
            if (sfScoreLabels.length > SF_MAX_PTS) { sfScoreLabels.shift(); sfScoreData.shift(); }
            if (sfScoreChart) {
                // Dynamic line color based on latest score
                sfScoreChart.data.datasets[0].borderColor = scoreColor(score);
                sfScoreChart.data.datasets[0].backgroundColor = scoreColor(score) + '12';
                sfScoreChart.update('none');
            }

            // â•â•â• ROW 3: EAR/MAR CHARTS â•â•â•
            sfEarLabels.push(ts); sfEarData.push(ear);
            if (sfEarLabels.length > SF_MAX_PTS) { sfEarLabels.shift(); sfEarData.shift(); }
            if (sfEarChart) sfEarChart.update('none');

            const sfEarLiveVal = $('sf-ear-live-val');
            if (sfEarLiveVal) { sfEarLiveVal.textContent = ear.toFixed(3); sfEarLiveVal.style.color = earColor(ear); }

            sfMarLabels.push(ts); sfMarData.push(mar);
            if (sfMarLabels.length > SF_MAX_PTS) { sfMarLabels.shift(); sfMarData.shift(); }
            if (sfMarChart) sfMarChart.update('none');

            const sfMarLiveVal = $('sf-mar-live-val');
            if (sfMarLiveVal) { sfMarLiveVal.textContent = mar.toFixed(3); sfMarLiveVal.style.color = marColor(mar); }

            // â•â•â• Live EAR/MAR Stats â•â•â•
            if (_sfEarSamples.length > 500) _sfEarSamples.shift();
            if (_sfMarSamples.length > 500) _sfMarSamples.shift();
            if (_sfEarSamples.length > 0) {
                const avgE = _sfEarSamples.reduce((a,b) => a+b, 0) / _sfEarSamples.length;
                const minE = Math.min(..._sfEarSamples);
                const sfEarAvg = $('sf-ear-avg'), sfEarMin = $('sf-ear-min');
                if (sfEarAvg) sfEarAvg.textContent = avgE.toFixed(3);
                if (sfEarMin) sfEarMin.textContent = minE.toFixed(3);
            }
            if (_sfMarSamples.length > 0) {
                const avgM = _sfMarSamples.reduce((a,b) => a+b, 0) / _sfMarSamples.length;
                const maxM = Math.max(..._sfMarSamples);
                const sfMarAvg = $('sf-mar-avg'), sfMarMax = $('sf-mar-max');
                if (sfMarAvg) sfMarAvg.textContent = avgM.toFixed(3);
                if (sfMarMax) sfMarMax.textContent = maxM.toFixed(3);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  SAFETY ANALYTICS POLLER â€” Fetches /api/safety/analytics
        //  and updates donut chart, episodes, timeline, risk matrix,
        //  AI recommendations, KPIs, session summary.
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function fetchSafetyAnalytics() {
            try {
                const res = await fetch('/api/safety/analytics');
                const data = await res.json();
                _sfAnalyticsData = data;

                // â”€â”€ KPI Counters in Hero â”€â”€
                const sfKpiAlerts = $('sf-kpi-alerts');
                const sfKpiCritical = $('sf-kpi-critical');
                const sfKpiWarnings = $('sf-kpi-warnings');
                const sfKpiEpisodes = $('sf-kpi-episodes');
                if (sfKpiAlerts) sfKpiAlerts.textContent = data.total_alerts || 0;
                if (sfKpiCritical) sfKpiCritical.textContent = data.severity_counts?.critical || 0;
                if (sfKpiWarnings) sfKpiWarnings.textContent = data.severity_counts?.warning || 0;
                if (sfKpiEpisodes) sfKpiEpisodes.textContent = data.drowsy_episodes?.length || 0;

                // â”€â”€ Donut Chart â”€â”€
                if (sfDonutChart && data.type_counts) {
                    const tc = data.type_counts;
                    sfDonutChart.data.datasets[0].data = [
                        tc.drowsiness || 0, tc.yawning || 0,
                        tc.distraction || 0, tc.phone || 0, tc.looking_away || 0
                    ];
                    sfDonutChart.update('none');

                    const total = (tc.drowsiness||0) + (tc.yawning||0) + (tc.distraction||0) + (tc.phone||0) + (tc.looking_away||0);
                    const sfDonutTotal = $('sf-donut-total');
                    const sfDonutCenter = $('sf-donut-center');
                    if (sfDonutTotal) sfDonutTotal.textContent = total;
                    if (sfDonutCenter) sfDonutCenter.textContent = total;

                    // Legend counts
                    const sfDistDrowsy = $('sf-dist-drowsy');
                    const sfDistYawn = $('sf-dist-yawn');
                    const sfDistDistract = $('sf-dist-distract');
                    const sfDistPhone = $('sf-dist-phone');
                    const sfDistLook = $('sf-dist-look');
                    if (sfDistDrowsy) sfDistDrowsy.textContent = tc.drowsiness || 0;
                    if (sfDistYawn) sfDistYawn.textContent = tc.yawning || 0;
                    if (sfDistDistract) sfDistDistract.textContent = tc.distraction || 0;
                    if (sfDistPhone) sfDistPhone.textContent = tc.phone || 0;
                    if (sfDistLook) sfDistLook.textContent = tc.looking_away || 0;
                }

                // â”€â”€ Risk Assessment Matrix â”€â”€
                if (data.type_counts && data.total_alerts > 0) {
                    const tc = data.type_counts;
                    const total = data.total_alerts;
                    // Compute risk percentages (weighted by severity)
                    const drowsyRisk = Math.min(100, ((tc.drowsiness || 0) / Math.max(1, total)) * 200); // 2x weight
                    const yawnRisk = Math.min(100, ((tc.yawning || 0) / Math.max(1, total)) * 150);
                    const distractRisk = Math.min(100, (((tc.distraction || 0) + (tc.phone || 0) + (tc.looking_away || 0)) / Math.max(1, total)) * 180);
                    const co2Risk = 0; // from sensor, handled separately
                    const overallRisk = Math.min(100, (drowsyRisk * 0.4 + yawnRisk * 0.2 + distractRisk * 0.3 + co2Risk * 0.1));

                    setRiskBar('sf-risk-drowsy-bar', 'sf-risk-drowsy-pct', drowsyRisk);
                    setRiskBar('sf-risk-yawn-bar', 'sf-risk-yawn-pct', yawnRisk);
                    setRiskBar('sf-risk-distract-bar', 'sf-risk-distract-pct', distractRisk);
                    setRiskBar('sf-risk-overall-bar', 'sf-risk-overall-pct', overallRisk);

                    // Risk level tag
                    const sfRiskTag = $('sf-risk-level-tag');
                    if (sfRiskTag) {
                        const lvl = data.risk_level || 'LOW';
                        sfRiskTag.textContent = lvl;
                        const tagStyles = {
                            'LOW': 'bg-emerald-50 text-emerald-600',
                            'MODERATE': 'bg-amber-50 text-amber-600',
                            'HIGH': 'bg-orange-50 text-orange-600',
                            'CRITICAL': 'bg-red-50 text-red-600',
                        };
                        sfRiskTag.className = `px-2 py-0.5 rounded-full text-[9px] font-bold ${tagStyles[lvl] || tagStyles.LOW}`;
                    }
                }

                // â”€â”€ Drowsy Episodes Feed â”€â”€
                const sfEpFeed = $('sf-episode-feed');
                const sfNoEp = $('sf-no-episodes');
                const sfEpCount = $('sf-ep-count');
                if (sfEpCount) sfEpCount.textContent = data.drowsy_episodes?.length || 0;
                if (sfEpFeed && data.drowsy_episodes && data.drowsy_episodes.length > 0) {
                    if (sfNoEp) sfNoEp.style.display = 'none';
                    // Clear and rebuild
                    const existingCards = sfEpFeed.querySelectorAll('.ep-card');
                    existingCards.forEach(c => c.remove());
                    data.drowsy_episodes.slice(-10).reverse().forEach((ep, i) => {
                        const card = document.createElement('div');
                        card.className = 'ep-card flex items-start gap-2.5 p-2.5 bg-red-50 rounded-lg border border-red-100';
                        const startTime = ep.start ? new Date(ep.start).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true }) : 'â€”';
                        const dur = ep.peak_duration ? ep.peak_duration.toFixed(1) : '0';
                        const earVal = ep.ear_at_peak ? ep.ear_at_peak.toFixed(3) : 'â€”';
                        card.innerHTML = `
                            <div class="w-5 h-5 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-[10px] font-bold text-red-500">${i + 1}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-[11px] font-semibold text-red-700">Drowsy Episode â€” ${dur}s</p>
                                <div class="flex items-center gap-2 mt-0.5">
                                    <span class="text-[9px] text-red-400">${startTime}</span>
                                    <span class="text-[9px] text-slate-400">EAR: ${earVal}</span>
                                </div>
                            </div>`;
                        sfEpFeed.appendChild(card);
                    });
                }

                // â”€â”€ Alert Timeline Feed â”€â”€
                const sfAlertTL = $('sf-alert-timeline');
                const sfNoTL = $('sf-no-timeline');
                if (sfAlertTL && data.recent_alerts && data.recent_alerts.length > 0) {
                    if (sfNoTL) sfNoTL.style.display = 'none';
                    // Clear previous
                    const oldRows = sfAlertTL.querySelectorAll('.tl-row');
                    oldRows.forEach(r => r.remove());
                    data.recent_alerts.slice(-30).reverse().forEach(a => {
                        const row = document.createElement('div');
                        const cls = classifyAlert(a.text || '');
                        const isDanger = cls.severity === 'danger';
                        row.className = `tl-row flex items-center gap-2 px-2.5 py-1.5 rounded-lg ${isDanger ? 'bg-red-50' : 'bg-amber-50'}`;
                        const time = a.timestamp ? new Date(a.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true }) : '';
                        row.innerHTML = `
                            <span class="text-xs">${cls.icon}</span>
                            <span class="flex-1 text-[10px] font-medium ${isDanger ? 'text-red-700' : 'text-amber-700'} truncate">${escapeHtml(a.text || '')}</span>
                            <span class="text-[9px] text-slate-400 flex-shrink-0">${time}</span>`;
                        sfAlertTL.appendChild(row);
                    });
                }

                // â”€â”€ AI Safety Recommendations â”€â”€
                updateSafetyRecommendations(data);

                // â”€â”€ Session Summary (Row 5) â”€â”€
                if (data.session) {
                    const s = data.session;
                    const sfSumScore = $('sf-sum-score');
                    const sfSumMinScore = $('sf-sum-min-score');
                    const sfSumAvgEar = $('sf-sum-avg-ear');
                    const sfSumMinEar = $('sf-sum-min-ear');
                    const sfSumAvgMar = $('sf-sum-avg-mar');
                    const sfSumMaxMar = $('sf-sum-max-mar');
                    const sfSumDrowsyEp = $('sf-sum-drowsy-ep');
                    const sfSumTotalAlerts = $('sf-sum-total-alerts');

                    if (sfSumScore) sfSumScore.textContent = s.avg_safety_score.toFixed(0) + '%';
                    if (sfSumMinScore) { sfSumMinScore.textContent = s.min_safety_score.toFixed(0) + '%'; sfSumMinScore.style.color = scoreColor(s.min_safety_score); }
                    if (sfSumAvgEar) sfSumAvgEar.textContent = s.avg_ear.toFixed(3);
                    if (sfSumMinEar) { sfSumMinEar.textContent = s.min_ear.toFixed(3); sfSumMinEar.style.color = earColor(s.min_ear); }
                    if (sfSumAvgMar) sfSumAvgMar.textContent = s.avg_mar.toFixed(3);
                    if (sfSumMaxMar) { sfSumMaxMar.textContent = s.max_mar.toFixed(3); sfSumMaxMar.style.color = marColor(s.max_mar); }
                    if (sfSumDrowsyEp) { sfSumDrowsyEp.textContent = s.drowsy_episode_count || 0; sfSumDrowsyEp.style.color = s.drowsy_episode_count > 0 ? '#ef4444' : '#1e293b'; }
                    if (sfSumTotalAlerts) sfSumTotalAlerts.textContent = data.total_alerts || 0;
                }

                // Vehicle ID
                const sfSummaryVid = $('sf-summary-vid');
                if (sfSummaryVid) sfSummaryVid.textContent = vehicleId || 'â€”';

            } catch (e) {
                console.log('[Safety Analytics] Fetch error:', e);
            }
        }

        function setRiskBar(barId, pctId, value) {
            const bar = $(barId);
            const pct = $(pctId);
            if (bar) bar.style.width = Math.round(value) + '%';
            if (pct) pct.textContent = Math.round(value) + '%';
        }

        // â”€â”€ COâ‚‚ Risk (live, not from analytics) â”€â”€
        function updateCo2Risk(co2) {
            const risk = co2 > 1000 ? 90 : co2 > 700 ? 50 : co2 > 400 ? 15 : 0;
            setRiskBar('sf-risk-co2-bar', 'sf-risk-co2-pct', risk);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  AI SAFETY RECOMMENDATIONS ENGINE
        //  Generates contextual, prioritized safety insights
        //  based on real-time telemetry and aggregated analytics.
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let _lastRecommendations = '';

        function updateSafetyRecommendations(data) {
            const container = $('sf-recommendations');
            if (!container) return;

            const recs = [];
            const tc = data.type_counts || {};
            const s = data.session || {};
            const totalAlerts = data.total_alerts || 0;

            // Priority 1: Critical fatigue detection
            if (tc.drowsiness > 3) {
                recs.push({
                    icon: 'ðŸš¨', title: 'Critical Fatigue Alert',
                    text: `${tc.drowsiness} drowsiness events detected. Recommend immediate rest stop. Eyes closed patterns indicate severe fatigue risk.`,
                    priority: 'critical'
                });
            } else if (tc.drowsiness > 0) {
                recs.push({
                    icon: 'âš ï¸', title: 'Drowsiness Detected',
                    text: `${tc.drowsiness} drowsy event(s) recorded. Consider opening windows, adjusting temperature, or taking a short break.`,
                    priority: 'warning'
                });
            }

            // Priority 2: Yawn frequency
            if (tc.yawning > 5) {
                recs.push({
                    icon: 'ðŸ¥±', title: 'Excessive Yawning',
                    text: `${tc.yawning} yawn events detected â€” indicates progressive fatigue. Caffeine intake or 15-minute power nap recommended.`,
                    priority: 'warning'
                });
            } else if (tc.yawning > 2) {
                recs.push({
                    icon: 'ðŸ’¡', title: 'Yawn Activity Noted',
                    text: `${tc.yawning} yawns recorded. This may indicate early-stage drowsiness. Stay hydrated and maintain ventilation.`,
                    priority: 'info'
                });
            }

            // Priority 3: Distraction patterns
            const distractTotal = (tc.distraction || 0) + (tc.phone || 0) + (tc.looking_away || 0);
            if (distractTotal > 5) {
                recs.push({
                    icon: 'ðŸ“±', title: 'High Distraction Level',
                    text: `${distractTotal} distraction events. Phone usage and off-road gaze patterns detected. Reduce device interaction while driving.`,
                    priority: 'critical'
                });
            } else if (distractTotal > 0) {
                recs.push({
                    icon: 'ðŸ‘€', title: 'Distraction Events',
                    text: `${distractTotal} minor distraction(s) detected. Keep eyes on road and minimize secondary tasks.`,
                    priority: 'info'
                });
            }

            // Priority 4: Low safety score
            if (s.min_safety_score < 50) {
                recs.push({
                    icon: 'ðŸ”´', title: 'Critical Safety Score Drop',
                    text: `Minimum safety score dropped to ${s.min_safety_score}%. This indicates a dangerous driving window. Review driving behavior.`,
                    priority: 'critical'
                });
            } else if (s.min_safety_score < 70) {
                recs.push({
                    icon: 'ðŸŸ¡', title: 'Safety Score Below Threshold',
                    text: `Minimum score reached ${s.min_safety_score}%. Maintain focus and take breaks every 2 hours.`,
                    priority: 'warning'
                });
            }

            // Priority 5: EAR stats
            if (s.min_ear > 0 && s.min_ear < 0.18) {
                recs.push({
                    icon: 'ðŸ‘ï¸', title: 'Low Eye Aperture Detected',
                    text: `EAR dropped to ${s.min_ear.toFixed(3)} (below 0.20 threshold). This may indicate micro-sleep episodes.`,
                    priority: 'critical'
                });
            }

            // Default positive message
            if (recs.length === 0) {
                recs.push({
                    icon: 'âœ…', title: totalAlerts === 0 ? 'All Systems Nominal' : 'Session Active',
                    text: totalAlerts === 0
                        ? 'No safety concerns detected. CV pipeline is monitoring driver state. Keep up the safe driving!'
                        : 'Minor events recorded but within acceptable limits. Continue monitoring.',
                    priority: 'good'
                });
            }

            // Render (avoid flickering by comparing)
            const recKey = recs.map(r => r.title).join('|');
            if (recKey === _lastRecommendations) return;
            _lastRecommendations = recKey;

            container.innerHTML = '';
            const priorityStyles = {
                critical: 'bg-red-50/80 border-red-200',
                warning: 'bg-amber-50/80 border-amber-200',
                info: 'bg-blue-50/70 border-blue-200',
                good: 'bg-white/70 border-white',
            };
            const titleStyles = {
                critical: 'text-red-700',
                warning: 'text-amber-700',
                info: 'text-blue-700',
                good: 'text-slate-700',
            };

            recs.forEach(r => {
                const div = document.createElement('div');
                div.className = `flex items-start gap-2.5 p-3 rounded-lg border ${priorityStyles[r.priority] || priorityStyles.good}`;
                div.innerHTML = `
                    <span class="text-sm mt-0.5">${r.icon}</span>
                    <div>
                        <p class="text-[11px] font-semibold ${titleStyles[r.priority] || 'text-slate-700'}">${r.title}</p>
                        <p class="text-[10px] text-slate-500 mt-0.5">${r.text}</p>
                    </div>`;
                container.appendChild(div);
            });
        }

        // â”€â”€ Safety Analytics Polling Loop â”€â”€
        const SF_POLL_INTERVAL = 5000; // 5 seconds
        setInterval(() => {
            if (_currentPage === 'safety') {
                fetchSafetyAnalytics();
            }
        }, SF_POLL_INTERVAL);

        // â”€â”€ Refresh button handler â”€â”€
        const sfRefreshBtn = $('sf-refresh-btn');
        if (sfRefreshBtn) {
            sfRefreshBtn.addEventListener('click', () => {
                fetchSafetyAnalytics();
                sfRefreshBtn.textContent = 'Refreshingâ€¦';
                setTimeout(() => { sfRefreshBtn.textContent = 'Refresh'; }, 1000);
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  ADAR POINTS ENGINE â€” Insurance Intelligence & Driver Scoring
        //  Animated score ring, radar chart, trend chart, event donut,
        //  risk factor cards, partner offers, biometric bars, AI insights
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        (function adarPointsEngine() {
            let apRadarChart = null, apTrendChart = null, apEventsChart = null;
            let _apPolling = null;

            const TIER_COLORS = {
                platinum: '#6366f1', gold: '#f59e0b', silver: '#94a3b8',
                bronze: '#b45309', uninsured: '#ef4444'
            };

            // â”€â”€ Initialize Charts â”€â”€
            function initAdarCharts() {
                const radarCtx = document.getElementById('ap-radar-chart');
                const trendCtx = document.getElementById('ap-trend-chart');
                const eventsCtx = document.getElementById('ap-events-chart');
                if (!radarCtx || !trendCtx || !eventsCtx) return;

                // Radar Chart
                apRadarChart = new Chart(radarCtx.getContext('2d'), {
                    type: 'radar',
                    data: {
                        labels: ['Drowsiness\nControl', 'Attention\nFocus', 'Fatigue\nMgmt', 'Driving\nConsistency', 'Clean\nStreak', 'Compliance'],
                        datasets: [{
                            label: 'Your Score',
                            data: [0, 0, 0, 0, 0, 0],
                            backgroundColor: 'rgba(99,102,241,0.15)',
                            borderColor: '#6366f1',
                            borderWidth: 2,
                            pointBackgroundColor: '#6366f1',
                            pointRadius: 4,
                            pointHoverRadius: 6,
                        }, {
                            label: 'Ideal (100)',
                            data: [100, 100, 100, 100, 100, 100],
                            backgroundColor: 'rgba(16,185,129,0.05)',
                            borderColor: 'rgba(16,185,129,0.3)',
                            borderWidth: 1,
                            borderDash: [4, 4],
                            pointRadius: 0,
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            r: {
                                min: 0, max: 100,
                                ticks: { stepSize: 25, font: { size: 9 }, backdropColor: 'transparent' },
                                grid: { color: 'rgba(0,0,0,0.05)' },
                                pointLabels: { font: { size: 10, weight: '600' }, color: '#475569' },
                            }
                        },
                        plugins: {
                            legend: { display: true, position: 'bottom', labels: { font: { size: 10 }, usePointStyle: true, padding: 12 } },
                        }
                    }
                });

                // Trend Chart
                apTrendChart = new Chart(trendCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'ADAR Score',
                            data: [],
                            borderColor: '#6366f1',
                            backgroundColor: (ctx) => {
                                const g = ctx.chart.ctx.createLinearGradient(0, 0, 0, 280);
                                g.addColorStop(0, 'rgba(99,102,241,0.25)');
                                g.addColorStop(1, 'rgba(99,102,241,0.01)');
                                return g;
                            },
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2.5,
                            pointRadius: 5,
                            pointBackgroundColor: '#6366f1',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 7,
                        }, {
                            label: 'Platinum Threshold',
                            data: [],
                            borderColor: 'rgba(99,102,241,0.3)',
                            borderWidth: 1.5,
                            borderDash: [6, 4],
                            pointRadius: 0,
                            fill: false,
                        }, {
                            label: 'Silver Threshold',
                            data: [],
                            borderColor: 'rgba(148,163,184,0.3)',
                            borderWidth: 1,
                            borderDash: [4, 4],
                            pointRadius: 0,
                            fill: false,
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            y: { min: 0, max: 1050, ticks: { stepSize: 200, font: { size: 10 } }, grid: { color: 'rgba(0,0,0,0.04)' } },
                            x: { ticks: { font: { size: 10 } }, grid: { display: false } },
                        },
                        plugins: {
                            legend: { display: true, position: 'bottom', labels: { font: { size: 10 }, usePointStyle: true, padding: 12 } },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => ctx.dataset.label + ': ' + ctx.parsed.y + ' pts'
                                }
                            }
                        }
                    }
                });

                // Events Donut
                apEventsChart = new Chart(eventsCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Drowsiness', 'Phone Usage', 'Distraction', 'Yawning', 'Seatbelt', 'Speed'],
                        datasets: [{
                            data: [0, 0, 0, 0, 0, 0],
                            backgroundColor: ['#ef4444', '#8b5cf6', '#f59e0b', '#06b6d4', '#10b981', '#3b82f6'],
                            borderWidth: 2,
                            borderColor: '#fff',
                            hoverOffset: 8,
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        cutout: '65%',
                        plugins: {
                            legend: { display: true, position: 'bottom', labels: { font: { size: 10 }, usePointStyle: true, padding: 10 } },
                        }
                    }
                });
            }

            // â”€â”€ Animate Score Ring â”€â”€
            function animateScoreRing(score, tierColor) {
                const ring = document.getElementById('ap-score-ring');
                if (!ring) return;
                const circumference = 263.9;
                const pct = score / 1000;
                const offset = circumference * (1 - pct);
                ring.style.strokeDashoffset = offset;
                ring.style.stroke = tierColor;

                // Animate number counter
                const numEl = document.getElementById('ap-score-num');
                if (numEl) {
                    let current = 0;
                    const step = Math.max(1, Math.ceil(score / 60));
                    const timer = setInterval(() => {
                        current = Math.min(current + step, score);
                        numEl.textContent = current;
                        if (current >= score) clearInterval(timer);
                    }, 25);
                }
            }

            // â”€â”€ Highlight Active Tier Card â”€â”€
            function highlightTier(tier) {
                ['platinum', 'gold', 'silver', 'bronze', 'uninsured'].forEach(t => {
                    const card = document.getElementById('ap-tier-' + t);
                    if (!card) return;
                    if (t === tier) {
                        card.classList.add('ring-2', 'shadow-lg', 'scale-105');
                        card.style.borderColor = TIER_COLORS[t];
                        card.style.boxShadow = `0 0 20px ${TIER_COLORS[t]}25`;
                    } else {
                        card.classList.remove('ring-2', 'shadow-lg', 'scale-105');
                        card.style.borderColor = '#e2e8f0';
                        card.style.boxShadow = '';
                    }
                });
            }

            // â”€â”€ Render Risk Factors â”€â”€
            function renderRiskFactors(factors) {
                const container = document.getElementById('ap-risk-factors');
                if (!container) return;
                if (!factors.length) {
                    container.innerHTML = `
                        <div class="flex items-center gap-3 p-4 bg-emerald-50 rounded-xl border border-emerald-100">
                            <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center flex-shrink-0">
                                <svg class="w-5 h-5 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-emerald-800">Perfect Driving Record</p>
                                <p class="text-[10px] text-emerald-600">No risk factors detected â€” you qualify for the best insurance tier!</p>
                            </div>
                        </div>`;
                    return;
                }
                const impactColors = { high: 'red', medium: 'amber', low: 'blue' };
                container.innerHTML = '<div class="space-y-3">' + factors.map(f => {
                    const c = impactColors[f.impact] || 'slate';
                    return `
                    <div class="p-4 bg-${c}-50 rounded-xl border border-${c}-100">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-${c}-500"></span>
                                <p class="text-xs font-semibold text-${c}-800">${f.factor}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] font-bold text-${c}-600 uppercase">${f.impact} impact</span>
                                <span class="px-2 py-0.5 rounded-full bg-${c}-100 text-${c}-700 text-[10px] font-bold">${f.count}x</span>
                                <span class="px-2 py-0.5 rounded-full bg-${c}-200/50 text-${c}-700 text-[10px] font-bold">-${f.penalty} pts</span>
                            </div>
                        </div>
                        <p class="text-[10px] text-${c}-700/80 leading-relaxed pl-4">${f.recommendation}</p>
                    </div>`;
                }).join('') + '</div>';
            }

            // â”€â”€ Render Partner Offers â”€â”€
            function renderPartners(partners, currentTier) {
                const container = document.getElementById('ap-partner-cards');
                if (!container) return;
                container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4">` +
                    partners.map((p, i) => `
                    <div class="relative rounded-xl border ${i === 0 ? 'border-indigo-200 bg-gradient-to-br from-indigo-50/50 to-white' : 'border-slate-200 bg-white'} shadow-sm p-5 transition-all hover:shadow-md">
                        ${i === 0 ? '<div class="absolute -top-2 right-3 px-2 py-0.5 rounded-full text-[8px] font-bold bg-indigo-600 text-white uppercase">Best Match</div>' : ''}
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white font-bold text-sm" style="background:${p.color}">${p.logo_initial}</div>
                            <div>
                                <p class="text-sm font-bold text-slate-700">${p.name}</p>
                                <p class="text-[10px] text-slate-400">${p.plan}</p>
                            </div>
                        </div>
                        <div class="flex items-end gap-1 mb-3">
                            <span class="text-2xl font-black text-slate-800">â‚¹${p.monthly.toLocaleString()}</span>
                            <span class="text-[10px] text-slate-400 mb-1">/month</span>
                        </div>
                        <div class="flex items-center gap-2 mb-3">
                            <span class="px-2 py-0.5 rounded-full text-[9px] font-bold bg-emerald-50 text-emerald-600">${p.rate}% rate</span>
                            <span class="px-2 py-0.5 rounded-full text-[9px] font-bold bg-blue-50 text-blue-600">â‚¹${p.annual.toLocaleString()}/yr</span>
                        </div>
                        <ul class="space-y-1.5 mb-4">
                            ${p.features.map(f => `<li class="flex items-center gap-2 text-[10px] text-slate-500"><svg class="w-3 h-3 text-emerald-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5"/></svg>${f}</li>`).join('')}
                        </ul>
                        <button class="w-full py-2 rounded-lg text-xs font-bold transition-colors ${i === 0 ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}">
                            ${i === 0 ? 'Get This Plan' : 'View Details'}
                        </button>
                    </div>`).join('') + '</div>';
            }

            // â”€â”€ Render AI Insights â”€â”€
            function renderInsights(insights) {
                const container = document.getElementById('ap-insights');
                if (!container) return;
                const iconMap = {
                    success: { bg: 'bg-emerald-100', text: 'text-emerald-700', border: 'border-emerald-200', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>' },
                    info: { bg: 'bg-blue-100', text: 'text-blue-700', border: 'border-blue-200', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z"/>' },
                    warning: { bg: 'bg-amber-100', text: 'text-amber-700', border: 'border-amber-200', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/>' },
                    danger: { bg: 'bg-red-100', text: 'text-red-700', border: 'border-red-200', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0 3.75h.007v.008H12v-.008zM21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>' },
                    tip: { bg: 'bg-violet-100', text: 'text-violet-700', border: 'border-violet-200', icon: '<path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.383a14.406 14.406 0 01-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 10-7.517 0c.85.493 1.509 1.333 1.509 2.316V18"/>' },
                };
                container.innerHTML = insights.map(ins => {
                    const s = iconMap[ins.type] || iconMap.info;
                    return `<div class="flex items-start gap-3 p-3 rounded-lg ${s.bg}/50 border ${s.border}">
                        <svg class="w-4 h-4 ${s.text} flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">${s.icon}</svg>
                        <p class="text-[11px] ${s.text} leading-relaxed">${ins.text}</p>
                    </div>`;
                }).join('');
            }

            // â”€â”€ Update Biometrics â”€â”€
            function updateBiometrics(bio) {
                if (!bio) return;
                const el = (id) => document.getElementById(id);
                if (el('ap-bio-ear')) { el('ap-bio-ear').textContent = bio.avg_ear.toFixed(4); }
                if (el('ap-bio-ear-bar')) { el('ap-bio-ear-bar').style.width = Math.min(100, (bio.avg_ear / 0.35) * 100) + '%'; }
                if (el('ap-bio-stability')) { el('ap-bio-stability').textContent = bio.ear_stability.toFixed(1) + '%'; }
                if (el('ap-bio-stability-bar')) { el('ap-bio-stability-bar').style.width = bio.ear_stability + '%'; }
                if (el('ap-bio-mar')) { el('ap-bio-mar').textContent = bio.avg_mar.toFixed(4); }
                if (el('ap-bio-mar-bar')) { el('ap-bio-mar-bar').style.width = Math.min(100, (bio.avg_mar / 0.60) * 100) + '%'; }
                if (el('ap-bio-safety')) { el('ap-bio-safety').textContent = bio.avg_safety_score.toFixed(1); }
                if (el('ap-bio-safety-bar')) { el('ap-bio-safety-bar').style.width = bio.avg_safety_score + '%'; }
                if (el('ap-bio-frames')) { el('ap-bio-frames').textContent = bio.total_frames_analyzed.toLocaleString(); }
            }

            // â”€â”€ Main Fetch & Update â”€â”€
            async function fetchAdarPoints() {
                try {
                    const res = await fetch('/api/adar-points');
                    if (!res.ok) throw new Error('API error');
                    const d = await res.json();

                    // Score ring animation
                    animateScoreRing(d.adar_score, d.tier_color);

                    // Hero badges
                    const el = (id) => document.getElementById(id);
                    if (el('ap-grade-badge')) { el('ap-grade-badge').textContent = 'Grade ' + d.grade; }
                    if (el('ap-tier-badge')) {
                        el('ap-tier-badge').textContent = d.tier_label;
                        el('ap-tier-badge').style.backgroundColor = d.tier_color + '20';
                        el('ap-tier-badge').style.color = d.tier_color;
                        el('ap-tier-badge').style.borderColor = d.tier_color + '40';
                    }
                    if (el('ap-risk-badge')) { el('ap-risk-badge').textContent = d.risk_class; }
                    if (el('ap-rate-badge')) { el('ap-rate-badge').textContent = d.interest_rate + '% Interest'; }
                    if (el('ap-savings')) { el('ap-savings').textContent = 'â‚¹' + d.premium.savings.toLocaleString(); }
                    if (el('ap-discount')) { el('ap-discount').textContent = d.discount_pct + '%'; }
                    if (el('ap-monthly')) { el('ap-monthly').textContent = 'â‚¹' + d.premium.your_monthly.toLocaleString(); }

                    // Highlight active tier
                    highlightTier(d.tier);

                    // Radar chart
                    if (apRadarChart) {
                        const bd = d.breakdown;
                        apRadarChart.data.datasets[0].data = [
                            bd.drowsiness_control, bd.attention_focus, bd.fatigue_management,
                            bd.driving_consistency, bd.clean_streak, bd.compliance
                        ];
                        apRadarChart.update('none');
                    }

                    // Trend chart
                    if (apTrendChart && d.history_7d) {
                        apTrendChart.data.labels = d.history_7d.map(h => h.day);
                        apTrendChart.data.datasets[0].data = d.history_7d.map(h => h.score);
                        apTrendChart.data.datasets[1].data = d.history_7d.map(() => 800);
                        apTrendChart.data.datasets[2].data = d.history_7d.map(() => 500);
                        apTrendChart.update('none');
                    }

                    // Events donut
                    if (apEventsChart && d.event_summary) {
                        const es = d.event_summary;
                        apEventsChart.data.datasets[0].data = [
                            es.drowsiness, es.phone_usage, es.distractions,
                            es.yawning, es.seatbelt, es.speed
                        ];
                        apEventsChart.update('none');
                    }

                    // Risk factors
                    renderRiskFactors(d.risk_factors);

                    // Partners
                    renderPartners(d.partners, d.tier);

                    // Biometrics
                    updateBiometrics(d.biometrics);

                    // AI insights
                    renderInsights(d.insights);

                } catch (e) {
                    console.error('[ADAR Points] Fetch error:', e);
                }
            }

            // â”€â”€ Init on page switch â”€â”€
            function initAdarPointsPage() {
                if (!apRadarChart) initAdarCharts();
                fetchAdarPoints();
                clearInterval(_apPolling);
                _apPolling = setInterval(fetchAdarPoints, 15000);
            }

            // Hook into global switchPage
            const _origSwitchPage = window.switchPage || null;
            const _origSwitchPageAP = typeof switchPage === 'function' ? switchPage : null;

            // Listen for page changes via a MutationObserver on the page div
            const apPageDiv = document.getElementById('page-adar-points');
            if (apPageDiv) {
                const obs = new MutationObserver(() => {
                    if (apPageDiv.style.display !== 'none' && !apPageDiv.classList.contains('hidden')) {
                        initAdarPointsPage();
                    } else {
                        clearInterval(_apPolling);
                    }
                });
                obs.observe(apPageDiv, { attributes: true, attributeFilter: ['style', 'class'] });
            }

            // Also trigger if adar-points is current page on load
            if (_currentPage === 'adar-points') {
                setTimeout(initAdarPointsPage, 300);
            }
        })();

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  FLEET ANALYTICS ENGINE â€” World-class analytics dashboard
        //  Charts: Timeline, Anomaly Radar, Vehicle Comparison, Correlation,
        //  Trend Forecast, Safety Heatmap, Event Distribution Donut
        //  + AI Insights, Live Event Log, Session Summary, CSV Export
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // â”€â”€ Analytics Chart Instances â”€â”€
        let anTimelineChart = null, anAnomalyChart = null, anVehicleChart = null;
        let anCorrChart = null, anTrendChart = null, anDonutChart = null;
        let _anData = null;
        const _anStartTime = Date.now();

        // â”€â”€ Chart.js defaults for analytics â”€â”€
        const anChartFont = { family: "'Inter','Segoe UI',sans-serif", size: 10 };
        const anGridColor = 'rgba(0,0,0,0.04)';

        function initAnalyticsCharts() {
            // 1) Fleet Event Timeline â€” Stacked Bar
            const tlCtx = document.getElementById('an-timeline-chart');
            if (tlCtx && !anTimelineChart) {
                anTimelineChart = new Chart(tlCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [
                            { label: 'Drowsiness', data: [], backgroundColor: 'rgba(239,68,68,0.85)', borderRadius: 2, barPercentage: 0.7 },
                            { label: 'Yawning', data: [], backgroundColor: 'rgba(251,191,36,0.85)', borderRadius: 2, barPercentage: 0.7 },
                            { label: 'Distraction', data: [], backgroundColor: 'rgba(249,115,22,0.85)', borderRadius: 2, barPercentage: 0.7 },
                            { label: 'Phone', data: [], backgroundColor: 'rgba(236,72,153,0.85)', borderRadius: 2, barPercentage: 0.7 },
                            { label: 'Looking Away', data: [], backgroundColor: 'rgba(96,165,250,0.85)', borderRadius: 2, barPercentage: 0.7 },
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                        scales: {
                            x: { stacked: true, grid: { display: false }, ticks: { font: anChartFont, maxRotation: 0, autoSkip: true, maxTicksLimit: 12 } },
                            y: { stacked: true, grid: { color: anGridColor }, ticks: { font: anChartFont, stepSize: 1 }, beginAtZero: true }
                        },
                        interaction: { mode: 'index', intersect: false },
                    }
                });
            }

            // 2) Anomaly Radar
            const anCtx = document.getElementById('an-anomaly-chart');
            if (anCtx && !anAnomalyChart) {
                anAnomalyChart = new Chart(anCtx, {
                    type: 'radar',
                    data: {
                        labels: ['Drowsiness', 'Fatigue', 'Attention', 'Speed', 'Air Quality'],
                        datasets: [{
                            label: 'Anomaly %',
                            data: [0, 0, 0, 0, 0],
                            backgroundColor: 'rgba(139,92,246,0.15)',
                            borderColor: 'rgba(139,92,246,0.8)',
                            borderWidth: 2,
                            pointRadius: 4,
                            pointBackgroundColor: '#8b5cf6',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 1.5,
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            r: {
                                grid: { color: 'rgba(0,0,0,0.05)' },
                                angleLines: { color: 'rgba(0,0,0,0.06)' },
                                pointLabels: { font: { ...anChartFont, weight: '600' }, color: '#475569' },
                                ticks: { display: false },
                                suggestedMin: 0, suggestedMax: 30,
                            }
                        }
                    }
                });
            }

            // 3) Vehicle Comparison â€” Horizontal Bar
            const vcCtx = document.getElementById('an-vehicle-chart');
            if (vcCtx && !anVehicleChart) {
                anVehicleChart = new Chart(vcCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Avg Score',
                            data: [],
                            backgroundColor: [],
                            borderRadius: 4,
                            barPercentage: 0.6,
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `Score: ${c.raw}%` } } },
                        scales: {
                            x: { min: 0, max: 100, grid: { color: anGridColor }, ticks: { font: anChartFont, callback: v => v + '%' } },
                            y: { grid: { display: false }, ticks: { font: { ...anChartFont, weight: '600' } } }
                        }
                    }
                });
            }

            // 4) EAR vs MAR Correlation Scatter
            const corrCtx = document.getElementById('an-corr-chart');
            if (corrCtx && !anCorrChart) {
                anCorrChart = new Chart(corrCtx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'EAR vs MAR',
                            data: [],
                            backgroundColor: 'rgba(99,102,241,0.4)',
                            borderColor: 'rgba(99,102,241,0.8)',
                            pointRadius: 3.5,
                            pointHoverRadius: 6,
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { callbacks: {
                            label: (c) => `EAR: ${c.raw.x.toFixed(3)}, MAR: ${c.raw.y.toFixed(3)}`
                        }}},
                        scales: {
                            x: { title: { display: true, text: 'EAR', font: anChartFont, color: '#94a3b8' }, grid: { color: anGridColor }, ticks: { font: anChartFont } },
                            y: { title: { display: true, text: 'MAR', font: anChartFont, color: '#94a3b8' }, grid: { color: anGridColor }, ticks: { font: anChartFont } }
                        }
                    }
                });
            }

            // 5) AI Trend Forecast â€” Line with forecast zone
            const trCtx = document.getElementById('an-trend-chart');
            if (trCtx && !anTrendChart) {
                anTrendChart = new Chart(trCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Actual',
                                data: [],
                                borderColor: '#6366f1',
                                backgroundColor: 'rgba(99,102,241,0.08)',
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: true,
                                tension: 0.3,
                            },
                            {
                                label: 'Forecast',
                                data: [],
                                borderColor: '#a78bfa',
                                borderDash: [5, 3],
                                backgroundColor: 'rgba(167,139,250,0.08)',
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: true,
                                tension: 0.3,
                            }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: true, position: 'top', labels: { font: anChartFont, boxWidth: 12, padding: 8 } } },
                        scales: {
                            x: { grid: { display: false }, ticks: { display: false } },
                            y: { min: 0, max: 100, grid: { color: anGridColor }, ticks: { font: anChartFont, callback: v => v + '%' } }
                        }
                    }
                });
            }

            // 6) Event Distribution Donut
            const dnCtx = document.getElementById('an-donut-chart');
            if (dnCtx && !anDonutChart) {
                anDonutChart = new Chart(dnCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Drowsiness', 'Yawning', 'Distraction', 'Phone', 'Looking Away'],
                        datasets: [{
                            data: [0, 0, 0, 0, 0],
                            backgroundColor: ['#ef4444', '#fbbf24', '#f97316', '#ec4899', '#60a5fa'],
                            borderWidth: 2,
                            borderColor: '#fff',
                            hoverOffset: 6,
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        cutout: '65%',
                        plugins: {
                            legend: { display: false },
                            tooltip: { callbacks: { label: (c) => `${c.label}: ${c.raw}` } }
                        }
                    }
                });
            }
        }

        // â”€â”€ Safety Heatmap SVG Renderer â”€â”€
        function renderHeatmap(heatmapData) {
            const svg = document.getElementById('an-heatmap-svg');
            if (!svg) return;
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const cellW = 22, cellH = 14, padL = 32, padT = 16, gap = 2;
            const maxVal = Math.max(1, ...heatmapData.flat());
            const colors = ['#eef2ff', '#c7d2fe', '#818cf8', '#6366f1', '#4338ca'];

            let html = '';
            // Hour labels
            for (let h = 0; h < 24; h++) {
                if (h % 3 === 0) {
                    html += `<text x="${padL + h * (cellW + gap) + cellW / 2}" y="12" text-anchor="middle" font-size="8" fill="#94a3b8" font-family="Inter,sans-serif">${h}:00</text>`;
                }
            }
            // Day labels + cells
            for (let d = 0; d < 7; d++) {
                const y = padT + d * (cellH + gap);
                html += `<text x="2" y="${y + cellH - 3}" font-size="8" fill="#94a3b8" font-family="Inter,sans-serif">${days[d]}</text>`;
                for (let h = 0; h < 24; h++) {
                    const v = heatmapData[d][h];
                    const intensity = v / maxVal;
                    const cidx = Math.min(4, Math.floor(intensity * 5));
                    const color = v === 0 ? '#f8fafc' : colors[cidx];
                    const x = padL + h * (cellW + gap);
                    html += `<rect x="${x}" y="${y}" width="${cellW}" height="${cellH}" rx="2" fill="${color}"><title>${days[d]} ${h}:00 â€” ${v} events</title></rect>`;
                }
            }
            svg.innerHTML = html;
        }

        // â”€â”€ Fetch & Update Analytics â”€â”€
        async function fetchFleetAnalytics() {
            try {
                const res = await fetch('/api/fleet/analytics');
                const data = await res.json();
                _anData = data;

                // Init charts on first call
                initAnalyticsCharts();

                // â”€â”€ Hero Score Gauge â”€â”€
                const iq = data.fleet_iq ?? 98;
                const scoreText = $('an-score-text');
                const scoreRing = $('an-score-ring');
                if (scoreText) scoreText.textContent = Math.round(iq);
                if (scoreRing) {
                    const circumference = 263.9;
                    const offset = circumference - (iq / 100) * circumference;
                    scoreRing.setAttribute('stroke-dashoffset', offset.toFixed(1));
                    scoreRing.setAttribute('stroke', iq >= 80 ? '#818cf8' : iq >= 50 ? '#fbbf24' : '#ef4444');
                }

                // â”€â”€ Hero KPIs â”€â”€
                const kpiV = $('an-kpi-vehicles'), kpiE = $('an-kpi-events'), kpiA = $('an-kpi-anomalies');
                if (kpiV) kpiV.textContent = data.vehicle_count || 0;
                if (kpiE) kpiE.textContent = data.total_events || 0;
                if (kpiA) kpiA.textContent = data.total_anomalies || 0;

                // â”€â”€ 1) Timeline Chart â”€â”€
                if (anTimelineChart && data.timeline) {
                    const labels = data.timeline.map(t => {
                        const parts = t.time.split('T');
                        return parts.length > 1 ? parts[1] : t.time;
                    });
                    anTimelineChart.data.labels = labels;
                    anTimelineChart.data.datasets[0].data = data.timeline.map(t => t.drowsiness || 0);
                    anTimelineChart.data.datasets[1].data = data.timeline.map(t => t.yawning || 0);
                    anTimelineChart.data.datasets[2].data = data.timeline.map(t => t.distraction || 0);
                    anTimelineChart.data.datasets[3].data = data.timeline.map(t => t.phone || 0);
                    anTimelineChart.data.datasets[4].data = data.timeline.map(t => t.looking_away || 0);
                    anTimelineChart.update('none');
                }

                // â”€â”€ 2) Anomaly Radar â”€â”€
                if (anAnomalyChart && data.anomaly_scores) {
                    const as = data.anomaly_scores;
                    anAnomalyChart.data.datasets[0].data = [
                        as.drowsiness_rate || 0, as.fatigue_rate || 0,
                        as.attention_deviation || 0, as.speed_anomaly || 0, as.co2_anomaly || 0
                    ];
                    anAnomalyChart.update('none');
                }

                // â”€â”€ 3) Vehicle Comparison â”€â”€
                if (anVehicleChart && data.vehicle_comparison) {
                    const vc = data.vehicle_comparison;
                    anVehicleChart.data.labels = vc.map(v => v.vehicle_id);
                    anVehicleChart.data.datasets[0].data = vc.map(v => v.avg_score);
                    anVehicleChart.data.datasets[0].backgroundColor = vc.map(v =>
                        v.avg_score >= 80 ? 'rgba(99,102,241,0.7)' : v.avg_score >= 50 ? 'rgba(251,191,36,0.7)' : 'rgba(239,68,68,0.7)'
                    );
                    anVehicleChart.update('none');
                }

                // â”€â”€ 4) Correlation Scatter â”€â”€
                if (anCorrChart && data.correlation_data) {
                    anCorrChart.data.datasets[0].data = data.correlation_data;
                    anCorrChart.update('none');
                }

                // â”€â”€ 5) Trend Forecast â”€â”€
                if (anTrendChart && data.trend_forecast && data.trend_forecast.length > 0) {
                    const tf = data.trend_forecast;
                    anTrendChart.data.labels = tf.map((_, i) => i);
                    anTrendChart.data.datasets[0].data = tf.map(p => p.actual !== undefined ? p.actual : null);
                    anTrendChart.data.datasets[1].data = tf.map(p => p.forecast !== undefined ? p.forecast : null);
                    anTrendChart.update('none');
                }

                // â”€â”€ 6) Heatmap â”€â”€
                if (data.heatmap) {
                    renderHeatmap(data.heatmap);
                }

                // â”€â”€ 7) Event Distribution Donut â”€â”€
                if (anDonutChart && data.type_counts) {
                    const tc = data.type_counts;
                    anDonutChart.data.datasets[0].data = [
                        tc.drowsiness || 0, tc.yawning || 0, tc.distraction || 0,
                        tc.phone || 0, tc.looking_away || 0
                    ];
                    anDonutChart.update('none');
                    // Legend counts
                    const dd = $('an-donut-drowsy'), dy = $('an-donut-yawn'), ddi = $('an-donut-distract');
                    const dp = $('an-donut-phone'), da = $('an-donut-away');
                    if (dd) dd.textContent = tc.drowsiness || 0;
                    if (dy) dy.textContent = tc.yawning || 0;
                    if (ddi) ddi.textContent = tc.distraction || 0;
                    if (dp) dp.textContent = tc.phone || 0;
                    if (da) da.textContent = tc.looking_away || 0;
                }

                // â”€â”€ 8) Event Log â”€â”€
                const logContainer = $('an-event-log');
                const noLog = $('an-no-log');
                const logCount = $('an-log-count');
                if (logCount) logCount.textContent = data.recent_events?.length || 0;
                if (logContainer && data.recent_events && data.recent_events.length > 0) {
                    if (noLog) noLog.style.display = 'none';
                    const oldRows = logContainer.querySelectorAll('.an-log-row');
                    oldRows.forEach(r => r.remove());
                    data.recent_events.slice(-30).reverse().forEach(ev => {
                        const row = document.createElement('div');
                        const cls = classifyAlert(ev.text || '');
                        const isDanger = cls.severity === 'danger';
                        row.className = `an-log-row flex items-center gap-2 px-2.5 py-1.5 rounded-lg ${isDanger ? 'bg-red-50' : 'bg-amber-50'} transition-all`;
                        const time = ev.timestamp ? new Date(ev.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true }) : '';
                        row.innerHTML = `
                            <span class="text-xs">${cls.icon}</span>
                            <span class="flex-1 text-[10px] font-medium ${isDanger ? 'text-red-700' : 'text-amber-700'} truncate">${escapeHtml(ev.text || '')}</span>
                            <span class="text-[9px] text-slate-400 flex-shrink-0 font-mono">${time}</span>`;
                        logContainer.appendChild(row);
                    });
                }

                // â”€â”€ 9) AI Insights â”€â”€
                const insightsContainer = $('an-ai-insights');
                if (insightsContainer && data.insights && data.insights.length > 0) {
                    const insKey = data.insights.map(i => i.title).join('|');
                    if (insightsContainer.dataset.key !== insKey) {
                        insightsContainer.dataset.key = insKey;
                        insightsContainer.innerHTML = '';
                        const levelStyles = {
                            critical: { bg: 'bg-red-50/80 border-red-200', title: 'text-red-700' },
                            warning: { bg: 'bg-amber-50/80 border-amber-200', title: 'text-amber-700' },
                            info: { bg: 'bg-blue-50/70 border-blue-200', title: 'text-blue-700' },
                            success: { bg: 'bg-white/70 border-white/80', title: 'text-emerald-700' },
                        };
                        data.insights.forEach(ins => {
                            const s = levelStyles[ins.level] || levelStyles.info;
                            const div = document.createElement('div');
                            div.className = `flex items-start gap-2.5 p-3 rounded-lg border shadow-sm ${s.bg}`;
                            div.innerHTML = `
                                <span class="text-base mt-0.5">${ins.icon}</span>
                                <div>
                                    <p class="text-[11px] font-semibold ${s.title}">${ins.title}</p>
                                    <p class="text-[10px] text-slate-500 mt-0.5">${ins.text}</p>
                                </div>`;
                            insightsContainer.appendChild(div);
                        });
                    }
                }

                // â”€â”€ 10) Session Summary â”€â”€
                const sf = data.session || {};
                const sumE = $('an-sum-events'), sumA = $('an-sum-anomalies');
                const sumAvgS = $('an-sum-avg-score'), sumMinS = $('an-sum-min-score');
                const sumAvgE = $('an-sum-avg-ear'), sumMinE = $('an-sum-min-ear');
                const sumAvgM = $('an-sum-avg-mar'), sumV = $('an-sum-vehicles');
                const sumFleet = $('an-summary-fleet');
                if (sumE) sumE.textContent = data.total_events || 0;
                if (sumA) sumA.textContent = data.total_anomalies || 0;
                if (sumAvgS) { sumAvgS.textContent = sf.avg_safety?.toFixed(0) ?? '98'; sumAvgS.style.color = scoreColor(sf.avg_safety ?? 98); }
                if (sumMinS) { sumMinS.textContent = sf.min_safety?.toFixed(0) ?? '98'; sumMinS.style.color = scoreColor(sf.min_safety ?? 98); }
                if (sumAvgE) sumAvgE.textContent = sf.avg_ear?.toFixed(3) ?? '0.280';
                if (sumMinE) { sumMinE.textContent = sf.min_ear?.toFixed(3) ?? '0.280'; if (sumMinE) sumMinE.style.color = earColor(sf.min_ear ?? 0.28); }
                if (sumAvgM) sumAvgM.textContent = sf.avg_mar?.toFixed(3) ?? '0.140';
                if (sumV) sumV.textContent = data.vehicle_count || 0;
                if (sumFleet) sumFleet.textContent = data.vehicle_ids?.join(', ') || 'â€”';

                // â”€â”€ Vehicle filter dropdown â”€â”€
                const filterV = $('an-filter-vehicle');
                if (filterV && data.vehicle_ids) {
                    const current = filterV.value;
                    const opts = ['<option value="all">All Vehicles</option>'];
                    data.vehicle_ids.forEach(v => opts.push(`<option value="${v}">${v}</option>`));
                    filterV.innerHTML = opts.join('');
                    filterV.value = current || 'all';
                }

            } catch (e) {
                console.log('[Fleet Analytics] Fetch error:', e);
            }
        }

        // â”€â”€ Analytics Session Clock â”€â”€
        setInterval(() => {
            const el = $('an-session-clock');
            if (el) {
                const s = Math.floor((Date.now() - _anStartTime) / 1000);
                const h = String(Math.floor(s / 3600)).padStart(2, '0');
                const m = String(Math.floor((s % 3600) / 60)).padStart(2, '0');
                const ss = String(s % 60).padStart(2, '0');
                el.textContent = `${h}:${m}:${ss}`;
            }
        }, 1000);

        // â”€â”€ Analytics Polling Loop â”€â”€
        const AN_POLL_INTERVAL = 5000;
        setInterval(() => {
            if (_currentPage === 'analytics') {
                fetchFleetAnalytics();
            }
        }, AN_POLL_INTERVAL);

        // â”€â”€ Analytics Button Handlers â”€â”€
        const anRefreshBtn = $('an-btn-refresh');
        if (anRefreshBtn) {
            anRefreshBtn.addEventListener('click', () => {
                fetchFleetAnalytics();
                anRefreshBtn.innerHTML = '<svg class="w-3.5 h-3.5 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182"/></svg> Refreshingâ€¦';
                setTimeout(() => {
                    anRefreshBtn.innerHTML = '<svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182"/></svg> Refresh';
                }, 1000);
            });
        }

        const anLogRefresh = $('an-log-refresh');
        if (anLogRefresh) {
            anLogRefresh.addEventListener('click', () => {
                fetchFleetAnalytics();
                anLogRefresh.textContent = 'Refreshingâ€¦';
                setTimeout(() => { anLogRefresh.textContent = 'Refresh'; }, 1000);
            });
        }

        // â”€â”€ CSV Export â”€â”€
        const anExportBtn = $('an-btn-export');
        if (anExportBtn) {
            anExportBtn.addEventListener('click', () => {
                if (!_anData || !_anData.recent_events) return;
                const rows = [['Timestamp', 'Vehicle', 'Event', 'EAR', 'MAR']];
                _anData.recent_events.forEach(ev => {
                    rows.push([ev.timestamp, ev.vehicle_id, `"${ev.text}"`, ev.ear, ev.mar]);
                });
                const csv = rows.map(r => r.join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `adar_analytics_${new Date().toISOString().slice(0,10)}.csv`;
                a.click(); URL.revokeObjectURL(url);
            });
        }

        // â”€â”€ Trigger initial fetch if analytics page is active â”€â”€
        if (_currentPage === 'analytics') {
            setTimeout(fetchFleetAnalytics, 300);
        }

    })();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  SETTINGS ENGINE â€” Live slider labels, localStorage persistence, save/reset
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    (function settingsEngine() {
        const STORAGE_KEY = 'adar_settings_v3';

        // Default settings
        const DEFAULTS = {
            fleetName: 'ADAR Fleet Alpha',
            vehicleId: '',
            serverUrl: window.location.origin,
            driverName: '',
            earThreshold: 0.20,
            marThreshold: 0.60,
            co2Threshold: 800,
            speedLimit: 120,
            drowsyDuration: 1.5,
            alertSound: true,
            refreshRate: 5000,
            mapStyle: 'street',
            tempUnit: 'celsius',
            speedUnit: 'kmh',
            showTrail: true,
            darkSidebar: true,
            compactMode: false,
        };

        // Load stored settings
        function loadSettings() {
            try {
                const stored = JSON.parse(localStorage.getItem(STORAGE_KEY));
                return stored ? { ...DEFAULTS, ...stored } : { ...DEFAULTS };
            } catch { return { ...DEFAULTS }; }
        }

        // Save settings to localStorage
        function saveSettings(s) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
        }

        // Apply settings to form controls
        function applyToForm(s) {
            const el = (id) => document.getElementById(id);
            if (el('set-fleet-name')) el('set-fleet-name').value = s.fleetName;
            if (el('set-vehicle-id')) el('set-vehicle-id').value = s.vehicleId;
            if (el('set-server-url')) el('set-server-url').value = s.serverUrl;
            if (el('set-driver-name')) el('set-driver-name').value = s.driverName;
            if (el('set-ear-threshold')) { el('set-ear-threshold').value = s.earThreshold; el('set-ear-threshold-val').textContent = s.earThreshold.toFixed(2); }
            if (el('set-mar-threshold')) { el('set-mar-threshold').value = s.marThreshold; el('set-mar-threshold-val').textContent = s.marThreshold.toFixed(2); }
            if (el('set-co2-threshold')) { el('set-co2-threshold').value = s.co2Threshold; el('set-co2-threshold-val').textContent = s.co2Threshold; }
            if (el('set-speed-limit')) { el('set-speed-limit').value = s.speedLimit; el('set-speed-limit-val').textContent = s.speedLimit; }
            if (el('set-drowsy-dur')) { el('set-drowsy-dur').value = s.drowsyDuration; el('set-drowsy-dur-val').textContent = s.drowsyDuration + 's'; }
            if (el('set-alert-sound')) el('set-alert-sound').checked = s.alertSound;
            if (el('set-refresh-rate')) el('set-refresh-rate').value = s.refreshRate;
            if (el('set-map-style')) el('set-map-style').value = s.mapStyle;
            if (el('set-temp-unit')) el('set-temp-unit').value = s.tempUnit;
            if (el('set-speed-unit')) el('set-speed-unit').value = s.speedUnit;
            if (el('set-show-trail')) el('set-show-trail').checked = s.showTrail;
            if (el('set-dark-sidebar')) el('set-dark-sidebar').checked = s.darkSidebar;
            if (el('set-compact-mode')) el('set-compact-mode').checked = s.compactMode;
        }

        // Read current form values into an object
        function readFromForm() {
            const el = (id) => document.getElementById(id);
            return {
                fleetName: el('set-fleet-name')?.value || DEFAULTS.fleetName,
                vehicleId: el('set-vehicle-id')?.value || '',
                serverUrl: el('set-server-url')?.value || DEFAULTS.serverUrl,
                driverName: el('set-driver-name')?.value || '',
                earThreshold: parseFloat(el('set-ear-threshold')?.value) || DEFAULTS.earThreshold,
                marThreshold: parseFloat(el('set-mar-threshold')?.value) || DEFAULTS.marThreshold,
                co2Threshold: parseInt(el('set-co2-threshold')?.value) || DEFAULTS.co2Threshold,
                speedLimit: parseInt(el('set-speed-limit')?.value) || DEFAULTS.speedLimit,
                drowsyDuration: parseFloat(el('set-drowsy-dur')?.value) || DEFAULTS.drowsyDuration,
                alertSound: el('set-alert-sound')?.checked ?? DEFAULTS.alertSound,
                refreshRate: parseInt(el('set-refresh-rate')?.value) || DEFAULTS.refreshRate,
                mapStyle: el('set-map-style')?.value || DEFAULTS.mapStyle,
                tempUnit: el('set-temp-unit')?.value || DEFAULTS.tempUnit,
                speedUnit: el('set-speed-unit')?.value || DEFAULTS.speedUnit,
                showTrail: el('set-show-trail')?.checked ?? DEFAULTS.showTrail,
                darkSidebar: el('set-dark-sidebar')?.checked ?? DEFAULTS.darkSidebar,
                compactMode: el('set-compact-mode')?.checked ?? DEFAULTS.compactMode,
            };
        }

        // Wire up range sliders to show live values
        function wireSliders() {
            const sliders = [
                { id: 'set-ear-threshold', valId: 'set-ear-threshold-val', fmt: v => parseFloat(v).toFixed(2) },
                { id: 'set-mar-threshold', valId: 'set-mar-threshold-val', fmt: v => parseFloat(v).toFixed(2) },
                { id: 'set-co2-threshold', valId: 'set-co2-threshold-val', fmt: v => v },
                { id: 'set-speed-limit', valId: 'set-speed-limit-val', fmt: v => v },
                { id: 'set-drowsy-dur', valId: 'set-drowsy-dur-val', fmt: v => v + 's' },
            ];
            sliders.forEach(({ id, valId, fmt }) => {
                const slider = document.getElementById(id);
                const valEl = document.getElementById(valId);
                if (slider && valEl) {
                    slider.addEventListener('input', () => { valEl.textContent = fmt(slider.value); });
                }
            });
        }

        // Flash save status message
        function flashStatus(msg, color) {
            const el = document.getElementById('set-save-status');
            if (!el) return;
            el.textContent = msg;
            el.style.color = color || '#64748b';
            setTimeout(() => { el.textContent = 'Settings are saved automatically'; el.style.color = '#94a3b8'; }, 2500);
        }

        // Set session start time
        function setSessionStart() {
            const el = document.getElementById('set-session-start');
            if (el) el.textContent = new Date().toLocaleTimeString();
        }

        // Save button
        document.getElementById('set-save-btn')?.addEventListener('click', () => {
            const s = readFromForm();
            saveSettings(s);
            flashStatus('âœ“ Settings saved successfully', '#16a34a');
        });

        // Reset defaults button
        document.getElementById('set-reset-defaults')?.addEventListener('click', () => {
            applyToForm(DEFAULTS);
            saveSettings(DEFAULTS);
            flashStatus('â†º Defaults restored', '#6366f1');
        });

        // Export session data
        document.getElementById('set-export-session')?.addEventListener('click', () => {
            const s = readFromForm();
            const csv = Object.entries(s).map(([k, v]) => `${k},${v}`).join('\n');
            const blob = new Blob(['setting,value\n' + csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url;
            a.download = `adar_settings_${new Date().toISOString().slice(0,10)}.csv`;
            a.click(); URL.revokeObjectURL(url);
            flashStatus('âœ“ Settings exported', '#6366f1');
        });

        // Clear session data
        document.getElementById('set-clear-alerts')?.addEventListener('click', () => {
            if (confirm('Clear all session data? This will reset counters and charts.')) {
                flashStatus('âœ“ Session data cleared', '#ef4444');
            }
        });

        // Initialize
        const saved = loadSettings();
        applyToForm(saved);
        wireSliders();
        setSessionStart();
    })();
    </script>
</body>
</html>
